<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>openmmlib &mdash; Wrapper for Openmm to perform polymer simulations and chromatin modelling 0.4 documentation</title>
    
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.4',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="Wrapper for Openmm to perform polymer simulations and chromatin modelling 0.4 documentation" href="../index.html" />
    <link rel="up" title="Module code" href="index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../np-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">Wrapper for Openmm to perform polymer simulations and chromatin modelling 0.4 documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for openmmlib</h1><div class="highlight"><pre>
<span class="c"># (c) 2013 Massachusetts Institute of Technology. All Rights Reserved</span>
<span class="c"># Code written by: Maksim Imakaev (imakaev@mit.edu)</span>
<span class="c">#                  Anton Goloborodko (golobor@mit.edu)</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Openmm-lib - a wrapper around Openmm to use with polymer simulations</span>
<span class="sd">====================================================================</span>

<span class="sd">Summary</span>
<span class="sd">-------</span>

<span class="sd">This is a wrapper above a GPU-assisted molecular dynamics package Openmm.</span>

<span class="sd">You can find extensive description of openmm classes here:</span>
<span class="sd">https://simtk.org/api_docs/openmm/api10/annotated.html</span>

<span class="sd">The main library is located in openmmlib.Simulation</span>

<span class="sd">A file knotAnalysis.py contains code needed to calculate Alexander&#39;s polynomials,</span>
<span class="sd">a measure of knot complexity. It also uses OpenMM to help unwrap polymer and</span>
<span class="sd">reduce time needed to calculate Alexander&#39;s polynomial</span>

<span class="sd">A file polymerScalings.py has some utilities to calculate Rg(s) and Pc(s) for</span>
<span class="sd">polymer conformations in a fast and efficient way.</span>

<span class="sd">A file contactmaps.py has code to quickly calculate contacts within a polymer structure,</span>
<span class="sd">and organize them as contactmaps. It is used by polymerScalings.</span>

<span class="sd">A file pymol_show has utilities to visualize polymer conformations using pymol</span>


<span class="sd">Input/Output file format</span>
<span class="sd">------------------------</span>

<span class="sd">Polymer configuration is represented as a Nx3 numpy array of coordinates.</span>
<span class="sd">Start/end of chains/rings are not directly specified in the file,</span>
<span class="sd">and have to be added through method :py:func:`setLayout &lt;Simulation.setLayout&gt;`</span>

<span class="sd">Input file may have the simplistic format, described in txtToJoblib.py (first line with</span>
<span class="sd">number of particles, then N lines with three floats corresponding to x,y,z coordinates each).</span>
<span class="sd">Input file can also be any of the output files.</span>

<span class="sd">Output file format is a dictionary, saved with joblib.dump.</span>
<span class="sd">Nx3 data array is stored under the key &quot;data&quot;.</span>
<span class="sd">The rest of the dictionary consists of metadata, describing details of the simulation.</span>
<span class="sd">This metadata is for informative purpose only, and is ignored by the code.</span>


<span class="sd">Implemented forces</span>
<span class="sd">------------------</span>

<span class="sd">All forces of the system are added by the code to the self.ForceDict dictionary.</span>
<span class="sd">After the force is added, the class (or user) can get it out of the</span>
<span class="sd">self.ForceDict and modify the force.</span>
<span class="sd">Once the simulation is started, all forces are automatically applied</span>
<span class="sd">and cannot be modified.</span>

<span class="sd">Two types of bond forces are harmonic bond force</span>
<span class="sd">and FENE-type bond as described in Grosberg papers.</span>
<span class="sd">Individual bonds can be added using :py:func:`addBond &lt;Simulation.addBond&gt;`,</span>
<span class="sd">while polymer bonds can be added using</span>
<span class="sd">:py:func:`addHarmonicPolymerBonds &lt;Simulation.addHarmonicPolymerBonds&gt;`, etc.</span>

<span class="sd">Nonbonded (inter-monomer) force can be of many types. Three Lennard-Jones-based forces:</span>
<span class="sd"> simple repulsife force U = 1/r^12;</span>
<span class="sd">Grosberg repulsive force - a faster and better implementation</span>
<span class="sd">of repulsive force; and LennardJones Force, that can be attractive and</span>
<span class="sd">allows to specify extra attraction/repulsion between any pairs of particles.</span>

<span class="sd">There are also polynomial repulsive and attractive forces which are faster due to a shorter cutoff radius.</span>

<span class="sd">Stiffness force can be harmonic, or the &quot;special&quot; Grosberg force, kept</span>
<span class="sd">for compatibility with the systems used in Grosberg forces</span>

<span class="sd">External forces include spherical confinement, cylindrical confinement,</span>
<span class="sd">attraction to &quot;lamina&quot;- surface of a cylinder, gravity, etc.</span>

<span class="sd">Information, printed on current step</span>
<span class="sd">------------------------------------</span>

<span class="sd">A sample line of information printed on each step looks like this:</span>

<span class="sd">minim  bl=5 (i)  pos[1]=[99.2 52.1 52.4] dr=0.54</span>
<span class="sd">kin=3.65 pot=3.44 Rg=107.312 SPS=144:</span>

<span class="sd">Let&#39;s go over it step by step.</span>

<span class="sd">minim - simulation name (sim -default, minim - energy minimization.</span>
<span class="sd">Other name can be provided in self.name).</span>

<span class="sd">bl=5 - name of a current block</span>

<span class="sd">(i) indicate that velocity reinitialization was done at this step.</span>
<span class="sd">You will simultaneously see that Ek is more than 2.4</span>

<span class="sd">pos[1] is a position of a first monomer</span>

<span class="sd">dr is sqrt(mean square displacement) of monomers, i.e.</span>
<span class="sd">how much did a monomer shift on average.</span>

<span class="sd">kin=3.65 pot=3.44  - energies: kinetic, potential</span>

<span class="sd">Rg=107.312 - current radius of gyration (size of the system)</span>

<span class="sd">SPS - steps per second</span>


<span class="sd">Functions</span>
<span class="sd">---------</span>
<span class="sd">Functions depend on each other, and have to be applied in certain groups</span>

<span class="sd">1.</span>


<span class="sd">:py:func:`load &lt;Simulation.load&gt;`  ---    Mandatory</span>

<span class="sd">:py:func:`setup &lt;Simulation.setup&gt;`  ---   Mandatory</span>

<span class="sd">:py:func:`setLayout &lt;Simulation.setLayout&gt;` --- Mandatory, after self.load()</span>

<span class="sd">:py:func:`saveFolder &lt;Simulation.saveFolder&gt;`  ---  Optional</span>
<span class="sd">(default is folder with the code)</span>

<span class="sd">2.</span>

<span class="sd">self.add___Force()  --- Use any set of forces</span>

<span class="sd">Then go all the addBond, and other modifications and tweaks of forces.</span>

<span class="sd">3.</span>

<span class="sd">Before running actual simulation, it is advised to resolve all possible</span>
<span class="sd">conflict by doing :py:func:`energyMinimization &lt;Simulation.energyMinimization&gt;`</span>

<span class="sd">4.</span>


<span class="sd">:py:func:`doBlock &lt;Simulation.doBlock&gt;`  --- the actual simulation</span>

<span class="sd">:py:func:`save &lt;Simulation.save&gt;` --- saves conformation</span>


<span class="sd">Frequently-used settings - where to specify them?</span>
<span class="sd">-------------------------------------------------</span>

<span class="sd">Select GPU (&quot;0&quot; or &quot;1&quot;) - :py:func:`setup &lt;Simulation.setup&gt;`</span>

<span class="sd">Select chain/ring - :py:func:`setLayout &lt;Simulation.setLayout&gt;`</span>

<span class="sd">Select timestep or collision rate - :py:class:`Simulation`</span>


<span class="sd">-------------------------------------------------------------------------------</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="c"># Licensed under the MIT license:</span>
<span class="c"># http://www.opensource.org/licenses/mit-license.php</span>


<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">polymerutils</span> <span class="kn">import</span> <span class="n">getLinkingNumber</span>
<span class="kn">import</span> <span class="nn">cPickle</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">joblib</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">polymerutils</span>


<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&quot;LD_LIBRARY_PATH&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;LD_LIBRARY_PATH&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;:/usr/local/cuda/lib64:/usr/local/openmm/lib&quot;</span>

<span class="kn">import</span> <span class="nn">simtk.openmm</span> <span class="kn">as</span> <span class="nn">openmm</span>
<span class="kn">import</span> <span class="nn">simtk.unit</span> <span class="kn">as</span> <span class="nn">units</span>

<span class="n">nm</span> <span class="o">=</span> <span class="n">units</span><span class="o">.</span><span class="n">meter</span> <span class="o">*</span> <span class="mf">1e-9</span>
<span class="n">fs</span> <span class="o">=</span> <span class="n">units</span><span class="o">.</span><span class="n">second</span> <span class="o">*</span> <span class="mf">1e-15</span>
<span class="n">ps</span> <span class="o">=</span> <span class="n">units</span><span class="o">.</span><span class="n">second</span> <span class="o">*</span> <span class="mf">1e-12</span>

<div class="viewcode-block" id="Simulation"><a class="viewcode-back" href="../openmmlib.html#openmmlib.Simulation">[docs]</a><span class="k">class</span> <span class="nc">Simulation</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Base class for openmm simulations</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">timestep</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">thermostat</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mi">300</span> <span class="o">*</span> <span class="n">units</span><span class="o">.</span><span class="n">kelvin</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">velocityReinitialize</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="c"># reinitialize velocities at every block if E_kin is more than 2.4</span>
        <span class="n">name</span><span class="o">=</span><span class="s">&quot;sim&quot;</span><span class="p">,</span>
        <span class="n">length_scale</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
        <span class="n">mass_scale</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>  <span class="c"># name to print out</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        timestep : number</span>
<span class="sd">            timestep in femtoseconds. Default value is good.</span>

<span class="sd">        thermostat : number</span>
<span class="sd">            collision rate in inverse picoseconds. Default value is ok...</span>

<span class="sd">        temperature : simtk.units.quantity(units.kelvin), optional</span>
<span class="sd">            Temperature of the simulation. Devault value is 300 K.</span>

<span class="sd">        verbose : bool, optional</span>
<span class="sd">            If True, prints a lot of stuff in the command line.</span>

<span class="sd">        velocityReinitialize : bool, optional</span>
<span class="sd">            If true, velocities are reinitalized if Ek is more than 2.4 kT.</span>
<span class="sd">            Set to False for simulations where inertia is very important.</span>

<span class="sd">        name : string, optional</span>
<span class="sd">            Name to be printed out as a first line of each block.</span>
<span class="sd">            Use it if you run simulations one after another</span>
<span class="sd">            and want to see what&#39;s going on.</span>

<span class="sd">        length_scale : float, optional</span>
<span class="sd">            The geometric scaling factor of the system.</span>
<span class="sd">            By default, length_scale=1.0 and harmonic bonds and repulsive</span>
<span class="sd">            forces have the scale of 1 nm.</span>

<span class="sd">        mass_scale : float, optional</span>
<span class="sd">            The scaling factor of the mass of the system.</span>



<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timestep</span> <span class="o">=</span> <span class="n">timestep</span> <span class="o">*</span> <span class="n">fs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collisionRate</span> <span class="o">=</span> <span class="n">thermostat</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">ps</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temperature</span> <span class="o">=</span> <span class="n">temperature</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">velocityReinitialize</span> <span class="o">=</span> <span class="n">velocityReinitialize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loaded</span> <span class="o">=</span> <span class="bp">False</span>  <span class="c"># check if the data is loaded</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forcesApplied</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">folder</span> <span class="o">=</span> <span class="s">&quot;.&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">length_scale</span> <span class="o">=</span> <span class="n">length_scale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mass_scale</span> <span class="o">=</span> <span class="n">mass_scale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eKcritical</span> <span class="o">=</span> <span class="mi">200</span>  <span class="c"># Max allowed kinetic energy</span>

<div class="viewcode-block" id="Simulation.setup"><a class="viewcode-back" href="../openmmlib.html#openmmlib.Simulation.setup">[docs]</a>    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">platform</span><span class="o">=</span><span class="s">&quot;CUDA&quot;</span><span class="p">,</span> <span class="n">PBC</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">PBCbox</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">GPU</span><span class="o">=</span><span class="s">&quot;default&quot;</span><span class="p">,</span>
              <span class="n">integrator</span><span class="o">=</span><span class="s">&quot;langevin&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">errorTol</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="s">&quot;mixed&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets up the important low-level parameters of the platform.</span>
<span class="sd">        Mandatory to run.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        platform : string, optional</span>
<span class="sd">            Platform to use</span>

<span class="sd">        PBC : bool, optional</span>
<span class="sd">            Use periodic boundary conditions, default:False</span>

<span class="sd">        PBCbox : (float,float,float), optional</span>
<span class="sd">            Define size of the bounding box for PBC</span>

<span class="sd">        GPU : &quot;0&quot; or &quot;1&quot;, optional</span>
<span class="sd">            Switch to another GPU. Mostly unnecessary.</span>
<span class="sd">            Machines with 1 GPU automatically select right GPU.</span>
<span class="sd">            Machines with 2 GPUs select GPU that is less used.</span>

<span class="sd">        integrator : &quot;langevin&quot;, &quot;variableLangevin&quot;, &quot;verlet&quot;, &quot;variableVerlet&quot;,</span>
<span class="sd">                     &quot;brownian&quot;, optional Integrator to use</span>
<span class="sd">                     (see Openmm class reference)</span>

<span class="sd">        verbose : bool, optional</span>
<span class="sd">            Shout out loud about every change.</span>

<span class="sd">        errorTol : float, optional</span>
<span class="sd">            Error tolerance parameter for variableLangevin integrator</span>
<span class="sd">            Values of 0.03-0.1 are reasonable for &quot;nice&quot; simulation</span>
<span class="sd">            Simulations with strong forces may need 0.01 or less</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">PBC</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s">&quot;PBC&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="n">precision</span> <span class="o">=</span> <span class="n">precision</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">precision</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&quot;mixed&quot;</span><span class="p">,</span> <span class="s">&quot;single&quot;</span><span class="p">,</span> <span class="s">&quot;double&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Presision must be mixed, single or double&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">kB</span> <span class="o">=</span> <span class="n">units</span><span class="o">.</span><span class="n">BOLTZMANN_CONSTANT_kB</span> <span class="o">*</span> \
            <span class="n">units</span><span class="o">.</span><span class="n">AVOGADRO_CONSTANT_NA</span>  <span class="c"># Boltzmann constant</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kB</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">temperature</span>  <span class="c"># thermal energy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mass</span> <span class="o">=</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="n">units</span><span class="o">.</span><span class="n">amu</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_scale</span>
        <span class="c"># All masses are the same,</span>
        <span class="c"># unless individual mass multipliers are specified in self.load()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bondsForException</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mm</span> <span class="o">=</span> <span class="n">openmm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conlen</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">*</span> <span class="n">nm</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">length_scale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">system</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">System</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">PBC</span> <span class="o">=</span> <span class="n">PBC</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">PBC</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>  <span class="c"># if periodic boundary conditions</span>
            <span class="k">if</span> <span class="n">PBCbox</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>  <span class="c"># Automatically setting up PBC box</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getData</span><span class="p">()</span>
                <span class="n">data</span> <span class="o">-=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

                <span class="n">datasize</span> <span class="o">=</span> <span class="mf">1.1</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getData</span><span class="p">(),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> \
                                       <span class="n">numpy</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getData</span><span class="p">(),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)))</span>
                <span class="c"># size of the system plus some overhead</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">SolventGridSize</span> <span class="o">=</span> <span class="p">(</span><span class="n">datasize</span> <span class="o">/</span> <span class="mf">1.1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span>
                <span class="k">print</span> <span class="s">&quot;density is &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">/</span> <span class="p">(</span><span class="n">datasize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="o">*</span> <span class="n">datasize</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">datasize</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">PBCbox</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">PBCbox</span><span class="p">)</span>
                <span class="n">datasize</span> <span class="o">=</span> <span class="n">PBCbox</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s">&quot;PBCbox&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">PBCbox</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">setDefaultPeriodicBoxVectors</span><span class="p">([</span><span class="n">datasize</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mf">0.</span><span class="p">,</span>
                <span class="mf">0.</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="n">datasize</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mf">0.</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">datasize</span><span class="p">[</span><span class="mi">2</span><span class="p">]])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">BoxSizeReal</span> <span class="o">=</span> <span class="n">datasize</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">GPU</span> <span class="o">=</span> <span class="n">GPU</span>  <span class="c"># setting default GPU</span>

        <span class="k">if</span> <span class="n">platform</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;opencl&quot;</span><span class="p">:</span>
            <span class="n">platformObject</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">Platform</span><span class="o">.</span><span class="n">getPlatformByName</span><span class="p">(</span><span class="s">&#39;OpenCL&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">GPU</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s">&quot;default&quot;</span><span class="p">:</span>
                <span class="n">platformObject</span><span class="o">.</span><span class="n">setPropertyDefaultValue</span><span class="p">(</span>
                    <span class="s">&#39;OpenCLDeviceIndex&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">GPU</span><span class="p">)</span>
            <span class="n">platformObject</span><span class="o">.</span><span class="n">setPropertyDefaultValue</span><span class="p">(</span><span class="s">&#39;OpenCLPrecision&#39;</span><span class="p">,</span> <span class="n">precision</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">platform</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;reference&quot;</span><span class="p">:</span>
            <span class="n">platformObject</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">Platform</span><span class="o">.</span><span class="n">getPlatformByName</span><span class="p">(</span><span class="s">&#39;Reference&#39;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">platform</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;cuda&quot;</span><span class="p">:</span>
            <span class="n">platformObject</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">Platform</span><span class="o">.</span><span class="n">getPlatformByName</span><span class="p">(</span><span class="s">&#39;CUDA&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">GPU</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s">&quot;default&quot;</span><span class="p">:</span>
                <span class="n">platformObject</span><span class="o">.</span><span class="n">setPropertyDefaultValue</span><span class="p">(</span><span class="s">&#39;CudaDeviceIndex&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">GPU</span><span class="p">)</span>
            <span class="n">platformObject</span><span class="o">.</span><span class="n">setPropertyDefaultValue</span><span class="p">(</span><span class="s">&#39;CudaPrecision&#39;</span><span class="p">,</span> <span class="n">precision</span><span class="p">)</span>
            <span class="n">platformObject</span><span class="o">.</span><span class="n">setPropertyDefaultValue</span><span class="p">(</span><span class="s">&#39;CudaUseBlockingSync&#39;</span><span class="p">,</span> <span class="s">&quot;true&quot;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">!!!!!!!!!!unknown platform!!!!!!!!!!!!!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">platform</span> <span class="o">=</span> <span class="n">platformObject</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">forceDict</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c"># Dictionary to store forces</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">integrator_type</span> <span class="o">=</span> <span class="n">integrator</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">integrator</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">integrator</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;langevin&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">integrator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">LangevinIntegrator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temperature</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">collisionRate</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestep</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">integrator</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;variablelangevin&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">integrator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">VariableLangevinIntegrator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temperature</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">collisionRate</span><span class="p">,</span> <span class="n">errorTol</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">integrator</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;verlet&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">integrator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">VariableVerletIntegrator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timestep</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">integrator</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;variableverlet&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">integrator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">VariableVerletIntegrator</span><span class="p">(</span><span class="n">errorTol</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">integrator</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;brownian&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">integrator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">BrownianIntegrator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temperature</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">collisionRate</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestep</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span> <span class="p">(</span><span class="s">&#39;please select from &quot;langevin&quot;, &quot;variablelangevin&quot;, &#39;</span>
                       <span class="s">&#39;&quot;verlet&quot;, &quot;variableVerlet&quot;, &#39;</span>
                       <span class="s">&#39;&quot;brownian&quot; or provide an integrator object&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">integrator</span> <span class="o">=</span> <span class="n">integrator</span>
</div>
<div class="viewcode-block" id="Simulation.saveFolder"><a class="viewcode-back" href="../openmmlib.html#openmmlib.Simulation.saveFolder">[docs]</a>    <span class="k">def</span> <span class="nf">saveFolder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        sets the folder where to save data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">            folder : string</span>
<span class="sd">                folder to save the data</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">folder</span> <span class="o">=</span> <span class="n">folder</span>
</div>
    <span class="k">def</span> <span class="nf">_exitProgram</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="k">print</span> <span class="n">line</span>
        <span class="k">print</span> <span class="s">&quot;--------------&gt; Bye &lt;---------------&quot;</span>
        <span class="nb">exit</span><span class="p">()</span>


<div class="viewcode-block" id="Simulation.setChains"><a class="viewcode-back" href="../openmmlib.html#openmmlib.Simulation.setChains">[docs]</a>    <span class="k">def</span> <span class="nf">setChains</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chains</span><span class="o">=</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets configuration of the chains in the system. This information is</span>
<span class="sd">        later used by the chain-forming methods, e.g. addHarmonicPolymerBonds()</span>
<span class="sd">        and addStiffness().</span>
<span class="sd">        This method supersedes the less general getLayout().</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        chains: list of tuples</span>
<span class="sd">            The list of chains in format [(start, end, isRing)]. The particle</span>
<span class="sd">            range should be semi-open, i.e. a chain (0,3,0) links</span>
<span class="sd">            the particles 0, 1 and 2. If bool(isRing) is True than the first</span>
<span class="sd">            and the last particles of the chain are linked into a ring.</span>
<span class="sd">            The default value links all particles of the system into one chain.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&quot;N&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Load the chain first, or provide chain length&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">chains</span> <span class="o">=</span> <span class="n">chains</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chains</span><span class="p">)):</span>
            <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">isRing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chains</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="k">if</span> <span class="p">(</span><span class="n">end</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">)</span> <span class="k">else</span> <span class="n">end</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">chains</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">isRing</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Simulation.getChains"><a class="viewcode-back" href="../openmmlib.html#openmmlib.Simulation.getChains">[docs]</a>    <span class="k">def</span> <span class="nf">getChains</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;returns configuration of chains&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">chains</span>
</div>
<div class="viewcode-block" id="Simulation.setLayout"><a class="viewcode-back" href="../openmmlib.html#openmmlib.Simulation.setLayout">[docs]</a>    <span class="k">def</span> <span class="nf">setLayout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&quot;chain&quot;</span><span class="p">,</span> <span class="n">chains</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">Nchains</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Deprecated method. Use setChains instead&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">!=</span> <span class="s">&quot;chain&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">chains</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">Nchains</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&quot;setLayout is deprecated. Use setChains&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Simulation.getLayout"><a class="viewcode-back" href="../openmmlib.html#openmmlib.Simulation.getLayout">[docs]</a>    <span class="k">def</span> <span class="nf">getLayout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;returns configuration of chains&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getChains</span><span class="p">()</span>
</div>
    <span class="k">def</span> <span class="nf">_loadParticles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&quot;system&quot;</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">loaded</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">mass</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">masses</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">addParticle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mass</span> <span class="o">*</span> <span class="n">mass</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;</span><span class="si">%d</span><span class="s"> particles loaded&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loaded</span> <span class="o">=</span> <span class="bp">True</span>


<div class="viewcode-block" id="Simulation.load"><a class="viewcode-back" href="../openmmlib.html#openmmlib.Simulation.load">[docs]</a>    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span>  <span class="c"># Input filename, or input data array</span>
             <span class="n">center</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>  <span class="c"># Shift center of mass to zero?</span>
             <span class="n">h5dictKey</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
             <span class="n">masses</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
             <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;loads data from file.</span>
<span class="sd">        Accepts text files, joblib files or pure data as Nx3 or 3xN array</span>

<span class="sd">        If h5dictKey is specified, uses new h5dict-based I/O</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        filename : joblib file, or text file name, or Nx3 or 3xN numpy array</span>
<span class="sd">            Input filename or array with data</span>

<span class="sd">        center : bool, optional</span>
<span class="sd">            Move center of mass to zero before starting the simulation</span>

<span class="sd">        h5dictKey : int or str, optional</span>
<span class="sd">            Indicates that you need to load from an h5dict</span>
<span class="sd">        masses : array</span>
<span class="sd">            Masses of each atom, measured in self.mass (default: 100 AMU,</span>
<span class="sd">            but could be modified by self.mass_scale)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">h5dictKey</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">mirnylib.h5dict</span> <span class="kn">import</span> <span class="n">h5dict</span>
            <span class="n">mydict</span> <span class="o">=</span> <span class="n">h5dict</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&quot;r&quot;</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">mydict</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">h5dictKey</span><span class="p">)]</span>

        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="s">&quot;checking for a text file here&quot;</span>
                <span class="n">line0</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">N</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line0</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;Cannot read text file...&quot;</span>\
                                    <span class="s">&quot; reading pickle file&quot;</span><span class="p">)</span>

                <span class="n">lines</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="n">data</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">j</span><span class="o">.</span><span class="n">split</span><span class="p">(</span>
                    <span class="p">)]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">lines</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">]</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">!=</span> <span class="n">N</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;N does not correspond&quot;</span>\
                                     <span class="s">&quot; to the number of lines!&quot;</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="s">&quot;loading from a joblib file here&quot;</span>
                <span class="n">mydict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">joblib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">mydict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;data&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">oldMetadata</span> <span class="o">=</span> <span class="n">data</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">filename</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_exitProgram</span><span class="p">(</span><span class="s">&quot;strange data file&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_exitProgram</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">!!!!!!!!!!file contains NANS!!!!!!!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">center</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">av</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">-=</span> <span class="n">av</span>

        <span class="k">if</span> <span class="n">center</span> <span class="o">==</span> <span class="s">&quot;zero&quot;</span><span class="p">:</span>
            <span class="n">minvalue</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">-=</span> <span class="n">minvalue</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">setData</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">randomizeData</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;center of mass is&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">print</span> <span class="s">&quot;Radius of gyration is,&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">RG</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">masses</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">masses</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">masses</span> <span class="o">=</span> <span class="n">masses</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&quot;chains&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setChains</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Simulation.save"><a class="viewcode-back" href="../openmmlib.html#openmmlib.Simulation.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&quot;auto&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Saves conformation plus some metadata.</span>
<span class="sd">        Metadata is not interpreted by this library, and is for your reference</span>

<span class="sd">        If data is saved to the .vtf format,</span>
<span class="sd">        the same filename should be specified each time.</span>
<span class="sd">        .vtf format is then viewable by VMD.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            mode : str</span>
<span class="sd">                &quot;h5dict&quot; : use build-in h5dict storage</span>
<span class="sd">                &quot;joblib&quot; : use joblib storage</span>
<span class="sd">                &quot;txt&quot; : use text file storage</span>
<span class="sd">                &quot;vtf&quot; : append data to the .vtf trajectory file</span>
<span class="sd">                &quot;auto&quot; : use h5dict if initialized, joblib otherwise</span>


<span class="sd">            filename : str or None</span>
<span class="sd">                Filename not needed for h5dict storage</span>
<span class="sd">                (use initStorage command) for joblib and txt,</span>
<span class="sd">                if filename not provided, it is created automatically.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s">&quot;vtf&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&quot;vtf&quot;</span><span class="p">):</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ff</span><span class="p">:</span>
                    <span class="n">ff</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;atom 0:</span><span class="si">%d</span><span class="s">  radius 1.2 name H </span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vtf</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ff</span><span class="p">:</span>
                <span class="n">ff</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;timestep</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">PBC</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
                    <span class="n">ff</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;pbc </span><span class="si">%lf</span><span class="s"> </span><span class="si">%lf</span><span class="s"> </span><span class="si">%lf</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">tuple</span><span class="p">([</span>
                        <span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">BoxSizeReal</span><span class="p">]))</span>
                <span class="n">data</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">getScaledData</span><span class="p">()</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;</span><span class="si">%.2lf</span><span class="s"> </span><span class="si">%.2lf</span><span class="s"> </span><span class="si">%.2lf</span><span class="s"> </span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
                <span class="n">ff</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s">&quot;auto&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&quot;storage&quot;</span><span class="p">):</span>
                <span class="n">mode</span> <span class="o">=</span> <span class="s">&quot;h5dict&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mode</span> <span class="o">=</span> <span class="s">&quot;joblib&quot;</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s">&quot;h5dict&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&quot;storage&quot;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">StandardError</span><span class="p">(</span><span class="s">&quot;Cannot save to h5dict!&quot;</span>\
                                    <span class="s">&quot; Initialize storage first!&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getData</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s">&quot;xyz&quot;</span><span class="p">:</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="s">&quot;block</span><span class="si">%d</span><span class="s">.xyz&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="s">&quot;block</span><span class="si">%d</span><span class="s">.dat&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s">&quot;joblib&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s">&quot;data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getData</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s">&quot;timestep&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timestep</span> <span class="o">/</span> <span class="n">fs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s">&quot;Collision rate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">collisionRate</span> <span class="o">/</span> <span class="n">ps</span><span class="p">)</span>
            <span class="n">joblib</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">compress</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

        <span class="k">elif</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="s">&quot;txt&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="s">&quot;xyz&quot;</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getData</span><span class="p">()</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s">&quot;xyz&quot;</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">particle</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s">&quot;txt&quot;</span><span class="p">:</span>
                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span>
                        <span class="s">&quot; &quot;</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">particle</span><span class="p">])</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;CA &quot;</span> <span class="o">+</span> <span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                        <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">particle</span><span class="p">])</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">myfile</span><span class="p">:</span>
                <span class="n">myfile</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Unknown mode : </span><span class="si">%s</span><span class="s">, use h5dict, joblib or txt&quot;</span> <span class="o">%</span>
                <span class="n">mode</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Simulation.initStorage"><a class="viewcode-back" href="../openmmlib.html#openmmlib.Simulation.initStorage">[docs]</a>    <span class="k">def</span> <span class="nf">initStorage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&quot;w-&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes an HDF5-based storage for multiple conformation.</span>

<span class="sd">        When the storage is initialized,</span>
<span class="sd">        save() by default saves to the storage.</span>

<span class="sd">        If &quot;r+&quot; mode is chosen, simulation is automaticaly set up</span>
<span class="sd">        to continue from existing conformation.</span>
<span class="sd">        In that case, last step is automatically determined, and data</span>
<span class="sd">        from second-to-last file is loaded.</span>

<span class="sd">        .. note :: Continue mode does not copy forces and layouts!</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        filename : str</span>
<span class="sd">            Filename of an h5dict storage file</span>

<span class="sd">        mode :</span>
<span class="sd">            &#39;w&#39;  - Create file, truncate if exists</span>
<span class="sd">            &#39;w-&#39; - Create file, fail if exists         (default)</span>
<span class="sd">            &#39;r+&#39; - Continue simulation, file must exist.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">mirnylib.h5dict</span> <span class="kn">import</span> <span class="n">h5dict</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;w&#39;</span><span class="p">,</span> <span class="s">&#39;w-&#39;</span><span class="p">,</span> <span class="s">&#39;r+&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Wrong mode to open file.&quot;</span>
                             <span class="s">&quot; Only &#39;w&#39;,&#39;w-&#39; and &#39;r+&#39; are supported&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="s">&quot;w-&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s">&quot;Cannot create file... file already exists.&quot;</span>\
                          <span class="s">&quot; Use mode =&#39;w&#39; to override&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">storage</span> <span class="o">=</span> <span class="n">h5dict</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s">&quot;r+&quot;</span><span class="p">:</span>
            <span class="n">myKeys</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">myKeys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="n">maxkey</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">myKeys</span><span class="p">)</span> <span class="k">if</span> <span class="n">myKeys</span> <span class="k">else</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="n">maxkey</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">maxkey</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)])</span>
</div>
<div class="viewcode-block" id="Simulation.getData"><a class="viewcode-back" href="../openmmlib.html#openmmlib.Simulation.getData">[docs]</a>    <span class="k">def</span> <span class="nf">getData</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Returns an Nx3 array of positions&quot;</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">/</span> <span class="n">nm</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s">&quot;float32&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Simulation.getScaledData"><a class="viewcode-back" href="../openmmlib.html#openmmlib.Simulation.getScaledData">[docs]</a>    <span class="k">def</span> <span class="nf">getScaledData</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns data, scaled back to PBC box &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">PBC</span> <span class="o">!=</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getData</span><span class="p">()</span>
        <span class="n">alldata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getData</span><span class="p">()</span>
        <span class="n">boxsize</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BoxSizeReal</span><span class="p">)</span>
        <span class="n">mults</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">alldata</span> <span class="o">/</span> <span class="n">boxsize</span><span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="p">:])</span>
        <span class="n">toRet</span> <span class="o">=</span> <span class="n">alldata</span> <span class="o">-</span> <span class="n">mults</span> <span class="o">*</span> <span class="n">boxsize</span><span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="p">:]</span>
        <span class="k">assert</span> <span class="n">toRet</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">toRet</span>
</div>
    <span class="k">def</span> <span class="nf">addUnits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coords</span><span class="p">):</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s">&quot;float&quot;</span><span class="p">)</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="n">units</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">nm</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">coords</span>

<div class="viewcode-block" id="Simulation.setData"><a class="viewcode-back" href="../openmmlib.html#openmmlib.Simulation.setData">[docs]</a>    <span class="k">def</span> <span class="nf">setData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets particle positions</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        data : Nx3 array-line</span>
<span class="sd">            Array of positions with distance ~1 between connected atoms.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s">&quot;float&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">units</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">nm</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&quot;context&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initPositions</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Simulation.randomizeData"><a class="viewcode-back" href="../openmmlib.html#openmmlib.Simulation.randomizeData">[docs]</a>    <span class="k">def</span> <span class="nf">randomizeData</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs automatically to offset data if it is integer based</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getData</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.0001</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setData</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Simulation.RG"><a class="viewcode-back" href="../openmmlib.html#openmmlib.Simulation.RG">[docs]</a>    <span class="k">def</span> <span class="nf">RG</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        Gyration ratius in units of length (bondlength).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getScaledData</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="mi">0</span><span class="p">)))</span>
</div>
<div class="viewcode-block" id="Simulation.RMAX"><a class="viewcode-back" href="../openmmlib.html#openmmlib.Simulation.RMAX">[docs]</a>    <span class="k">def</span> <span class="nf">RMAX</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">percentile</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Distance to the furthest from the origin particle.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getScaledData</span><span class="p">()</span>
        <span class="n">dists</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">percentile</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">dists</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">dists</span><span class="p">,</span> <span class="n">percentile</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Simulation.dist"><a class="viewcode-back" href="../openmmlib.html#openmmlib.Simulation.dist">[docs]</a>    <span class="k">def</span> <span class="nf">dist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates distance between particles i and j</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getData</span><span class="p">()</span>
        <span class="n">dif</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">dif</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="Simulation.useDomains"><a class="viewcode-back" href="../openmmlib.html#openmmlib.Simulation.useDomains">[docs]</a>    <span class="k">def</span> <span class="nf">useDomains</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domains</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets up domains for the simulation.</span>
<span class="sd">        Also, pickles domain vector to &quot;domains.dat&quot;.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        domains : boolean array or None</span>
<span class="sd">            N-long array with domain vector</span>
<span class="sd">        filename : str or None</span>
<span class="sd">            Filename with pickled domain vector</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">domains</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">domains</span> <span class="o">=</span> <span class="n">domains</span>

        <span class="k">elif</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">domains</span> <span class="o">=</span> <span class="n">cPickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">domains</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s">&quot;You have to specify domain vector or filename!&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domains</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_exitProgram</span><span class="p">(</span><span class="s">&quot;Wrong domain lengths&quot;</span><span class="p">)</span>

        <span class="n">cPickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domains</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">folder</span><span class="p">,</span>
            <span class="s">&quot;domains.dat&quot;</span><span class="p">),</span> <span class="s">&#39;wb&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&quot;storage&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="p">[</span><span class="s">&quot;domains&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domains</span>
</div>
    <span class="k">def</span> <span class="nf">_initHarmonicBondForce</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Internal, inits harmonic forse for polymer and non-polymer bonds&quot;</span>
        <span class="k">if</span> <span class="s">&quot;HarmonicBondForce&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">forceDict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">forceDict</span><span class="p">[</span><span class="s">&quot;HarmonicBondForce&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">HarmonicBondForce</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bondType</span> <span class="o">=</span> <span class="s">&quot;Harmonic&quot;</span>

    <span class="k">def</span> <span class="nf">_initGrosbergBondForce</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;inits Grosberg FENE bond force&quot;</span>
        <span class="k">if</span> <span class="s">&quot;GrosbergBondForce&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">forceDict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">force</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;- 0.5 * GROSk * GROSr0 * GROSr0 * log(1-(r/GROSr0)* (r / GROSr0))&quot;</span>
                <span class="s">&quot; + (4 * GROSe * ((GROSs/r)^12 - (GROSs/r)^6) + GROSe) * step(GROScut - r)&quot;</span><span class="p">)</span>
            <span class="n">bondforceGr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">CustomBondForce</span><span class="p">(</span><span class="n">force</span><span class="p">)</span>
            <span class="n">bondforceGr</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&quot;GROSk&quot;</span><span class="p">,</span> <span class="mi">30</span> <span class="o">*</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">kT</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conlen</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">conlen</span><span class="p">))</span>
            <span class="n">bondforceGr</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&quot;GROSr0&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">conlen</span> <span class="o">*</span> <span class="mf">1.5</span><span class="p">)</span>
            <span class="n">bondforceGr</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&#39;GROSe&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kT</span><span class="p">)</span>
            <span class="n">bondforceGr</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&#39;GROSs&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">conlen</span><span class="p">)</span>
            <span class="n">bondforceGr</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span>
                <span class="s">&quot;GROScut&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">conlen</span> <span class="o">*</span> <span class="mf">2.</span> <span class="o">**</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="mf">6.</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">forceDict</span><span class="p">[</span><span class="s">&quot;GrosbergBondForce&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bondforceGr</span>

    <span class="k">def</span> <span class="nf">_initAbsBondForce</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;inits abs(x) FENE bond force&quot;</span>
        <span class="k">if</span> <span class="s">&quot;AbsBondForce&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">forceDict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">force</span> <span class="o">=</span> <span class="s">&quot;(1. / ABSwiggle) * ABSunivK * &quot;</span>\
            <span class="s">&quot;(sqrt((r-ABSr0 * ABSconlen)* &quot;</span>\
            <span class="s">&quot; (r - ABSr0 * ABSconlen) + ABSa * ABSa) - ABSa)&quot;</span>

            <span class="n">bondforceAbs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">CustomBondForce</span><span class="p">(</span><span class="n">force</span><span class="p">)</span>
            <span class="n">bondforceAbs</span><span class="o">.</span><span class="n">addPerBondParameter</span><span class="p">(</span><span class="s">&quot;ABSwiggle&quot;</span><span class="p">)</span>
            <span class="n">bondforceAbs</span><span class="o">.</span><span class="n">addPerBondParameter</span><span class="p">(</span><span class="s">&quot;ABSr0&quot;</span><span class="p">)</span>
            <span class="n">bondforceAbs</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&quot;ABSunivK&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kT</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">conlen</span><span class="p">)</span>
            <span class="n">bondforceAbs</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&quot;ABSa&quot;</span><span class="p">,</span> <span class="mf">0.02</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">conlen</span><span class="p">)</span>
            <span class="n">bondforceAbs</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&quot;ABSconlen&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">conlen</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">forceDict</span><span class="p">[</span><span class="s">&quot;AbsBondForce&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bondforceAbs</span>

    <span class="k">def</span> <span class="nf">_initAbsDistanceLimitation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;inits abs(x) FENE bond force&quot;</span>
        <span class="k">if</span> <span class="s">&quot;AbsLimitation&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">forceDict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">force</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;(1. / ABSwiggle) * ABSunivK * step(r - ABSr0 * ABSconlen) &quot;</span>
                <span class="s">&quot;* (sqrt((r-ABSr0 * ABSconlen)&quot;</span>
                <span class="s">&quot;*(r - ABSr0 * ABSconlen) + ABSa * ABSa) - ABSa)&quot;</span><span class="p">)</span>
            <span class="n">bondforceAbsLim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">CustomBondForce</span><span class="p">(</span><span class="n">force</span><span class="p">)</span>
            <span class="n">bondforceAbsLim</span><span class="o">.</span><span class="n">addPerBondParameter</span><span class="p">(</span><span class="s">&quot;ABSwiggle&quot;</span><span class="p">)</span>
            <span class="n">bondforceAbsLim</span><span class="o">.</span><span class="n">addPerBondParameter</span><span class="p">(</span><span class="s">&quot;ABSr0&quot;</span><span class="p">)</span>
            <span class="n">bondforceAbsLim</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span>
                <span class="s">&quot;ABSunivK&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kT</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">conlen</span><span class="p">)</span>
            <span class="n">bondforceAbsLim</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&quot;ABSa&quot;</span><span class="p">,</span> <span class="mf">0.02</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">conlen</span><span class="p">)</span>
            <span class="n">bondforceAbsLim</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&quot;ABSconlen&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">conlen</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">forceDict</span><span class="p">[</span><span class="s">&quot;AbsLimitation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bondforceAbsLim</span>

    <span class="k">def</span> <span class="nf">addCenterOfMassRemover</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">remover</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">CMMotionRemover</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forceDict</span><span class="p">[</span><span class="s">&quot;CoM_Remover&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">remover</span>

<div class="viewcode-block" id="Simulation.addBond"><a class="viewcode-back" href="../openmmlib.html#openmmlib.Simulation.addBond">[docs]</a>    <span class="k">def</span> <span class="nf">addBond</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span>  <span class="c"># particles connected by bond</span>
                <span class="n">bondWiggleDistance</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
                <span class="c"># Flexibility of the bond,</span>
                <span class="c"># measured in distance at which energy equals kT</span>
                <span class="n">distance</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>  <span class="c"># Equilibrium length of the bond</span>
                <span class="n">bondType</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>  <span class="c"># Harmonic, Grosberg, ABS</span>
                <span class="n">verbose</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>  <span class="c"># Set this to False if you&#39;re in verbose mode</span>
                <span class="c"># and don&#39;t want to contaminate output by 10000 messages</span>
        <span class="sd">&quot;&quot;&quot;Adds bond between two particles, allows to specify parameters</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        i,j : int</span>
<span class="sd">            Particle numbers</span>
<span class="sd">        bondWiggleDistance : float</span>

<span class="sd">            Average displacement from the equilibrium bond distance</span>

<span class="sd">        bondType : &quot;Harmonic&quot; or &quot;Grosberg&quot;</span>
<span class="sd">            Type of bond. Distance and bondWiggleDistance can be</span>
<span class="sd">            specified for harmonic bonds only</span>

<span class="sd">        verbose : bool</span>
<span class="sd">            Set this to False if you&#39;re in verbose mode and don&#39;t want to</span>
<span class="sd">            print &quot;bond added&quot; message</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">verbose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">j</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Cannot add bond with monomers </span><span class="si">%d</span><span class="s">,</span><span class="si">%d</span><span class="s"> that&quot;</span>\
            <span class="s">&quot;are beyound the polymer length </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">))</span>
        <span class="n">bondSize</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">bondWiggleDistance</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">distance</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">distance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conlen</span> <span class="o">/</span> <span class="n">nm</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">distance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conlen</span> <span class="o">*</span> <span class="n">distance</span> <span class="o">/</span> <span class="n">nm</span>
        <span class="n">distance</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">distance</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">bondType</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">bondType</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bondType</span>

        <span class="k">if</span> <span class="n">bondType</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;harmonic&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_initHarmonicBondForce</span><span class="p">()</span>
            <span class="n">kbond</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">kT</span> <span class="o">/</span> <span class="p">(</span><span class="n">bondSize</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">conlen</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">kilojoule_per_mole</span> <span class="o">/</span> <span class="n">nm</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">forceDict</span><span class="p">[</span><span class="s">&quot;HarmonicBondForce&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">addBond</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">distance</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">kbond</span><span class="p">))</span>

        <span class="k">elif</span> <span class="n">bondType</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;grosberg&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_initGrosbergBondForce</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">forceDict</span><span class="p">[</span><span class="s">&quot;GrosbergBondForce&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">addBond</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="p">[])</span>
        <span class="k">elif</span> <span class="n">bondType</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;abs&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_initAbsBondForce</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">forceDict</span><span class="p">[</span><span class="s">&quot;AbsBondForce&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">addBond</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span>
                <span class="n">j</span><span class="p">),</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">bondWiggleDistance</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">distance</span><span class="p">)])</span>
        <span class="k">elif</span> <span class="n">bondType</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;abslim&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_initAbsDistanceLimitation</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">forceDict</span><span class="p">[</span><span class="s">&quot;AbsLimitation&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">addBond</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span>
                <span class="n">j</span><span class="p">),</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">bondWiggleDistance</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">distance</span><span class="p">)])</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_exitProgram</span><span class="p">(</span><span class="s">&quot;Bond type not known&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s"> bond added between </span><span class="si">%d</span><span class="s">,</span><span class="si">%d</span><span class="s">, wiggle </span><span class="si">%lf</span><span class="s"> dist </span><span class="si">%lf</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">bondType</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">bondWiggleDistance</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">distance</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="Simulation.addHarmonicPolymerBonds"><a class="viewcode-back" href="../openmmlib.html#openmmlib.Simulation.addHarmonicPolymerBonds">[docs]</a>    <span class="k">def</span> <span class="nf">addHarmonicPolymerBonds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wiggleDist</span><span class="o">=</span><span class="mf">0.05</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adds harmonic bonds connecting polymer chains</span>
<span class="sd">        wiggleDist controls the distance at which</span>
<span class="sd">        energy of the bond equals kT</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">isRing</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">chains</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">addBond</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">wiggleDist</span><span class="p">,</span> <span class="n">distance</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">bondType</span><span class="o">=</span><span class="s">&quot;Harmonic&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bondsForException</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">j</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">isRing</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">addBond</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">wiggleDist</span><span class="p">,</span>
                    <span class="n">distance</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bondType</span><span class="o">=</span><span class="s">&quot;Harmonic&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bondsForException</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s">&quot;ring bond added&quot;</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s">&quot;HarmonicPolymerBonds&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">({</span><span class="s">&quot;wiggleDist&quot;</span><span class="p">:</span> <span class="n">wiggleDist</span><span class="p">})</span>
</div>
<div class="viewcode-block" id="Simulation.addGrosbergPolymerBonds"><a class="viewcode-back" href="../openmmlib.html#openmmlib.Simulation.addGrosbergPolymerBonds">[docs]</a>    <span class="k">def</span> <span class="nf">addGrosbergPolymerBonds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adds FENE bonds according to Halverson-Grosberg paper.</span>
<span class="sd">        (Halverson, Jonathan D., et al. &quot;Molecular dynamics simulation study of</span>
<span class="sd">         nonconcatenated ring polymers in a melt. I. Statics.&quot;</span>
<span class="sd">         The Journal of chemical physics 134 (2011): 204904.)</span>

<span class="sd">        This method has a repulsive potential build-in,</span>
<span class="sd">        so that Grosberg bonds could be used with truncated potentials.</span>
<span class="sd">        Is of no use unless you really need to simulate Grosberg-type system.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        k : float, optional</span>
<span class="sd">            Arbitrary parameter; default value as in Grosberg paper.</span>

<span class="sd">         &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">isRing</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">chains</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">addBond</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bondType</span><span class="o">=</span><span class="s">&quot;Grosberg&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bondsForException</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">j</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">isRing</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">addBond</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">distance</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bondType</span><span class="o">=</span><span class="s">&quot;Harmonic&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bondsForException</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s">&quot;ring bond added&quot;</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s">&quot;GorsbergPolymerForce&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">({</span><span class="s">&quot;k&quot;</span><span class="p">:</span> <span class="n">k</span><span class="p">})</span>
</div>
<div class="viewcode-block" id="Simulation.addStiffness"><a class="viewcode-back" href="../openmmlib.html#openmmlib.Simulation.addStiffness">[docs]</a>    <span class="k">def</span> <span class="nf">addStiffness</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mf">1.5</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adds harmonic angle bonds. k specifies energy in kT at one radian</span>
<span class="sd">        If k is an array, it has to be of the length N.</span>
<span class="sd">        Xth value then specifies stiffness of the angle centered at</span>
<span class="sd">        monomer number X.</span>
<span class="sd">        Values for ends of the chain will be simply ignored.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        k : float or list of length N</span>
<span class="sd">            Stiffness of the bond.</span>
<span class="sd">            If list, then determines stiffness of the bond at monomer i.</span>
<span class="sd">            Potential is k * alpha^2 * 0.5 * kT</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="o">+</span> <span class="n">k</span>
        <span class="n">stiffForce</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">CustomAngleForce</span><span class="p">(</span>
            <span class="s">&quot;kT*angK * (theta - 3.141592) * (theta - 3.141592) * (0.5)&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forceDict</span><span class="p">[</span><span class="s">&quot;AngleForce&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stiffForce</span>
        <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">isRing</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">chains</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">end</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">stiffForce</span><span class="o">.</span><span class="n">addAngle</span><span class="p">(</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">k</span><span class="p">[</span><span class="n">j</span><span class="p">])])</span>
            <span class="k">if</span> <span class="n">isRing</span><span class="p">:</span>
                <span class="n">stiffForce</span><span class="o">.</span><span class="n">addAngle</span><span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">end</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="p">[</span><span class="n">k</span><span class="p">[</span><span class="n">end</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]])</span>
                <span class="n">stiffForce</span><span class="o">.</span><span class="n">addAngle</span><span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="n">k</span><span class="p">[</span><span class="n">start</span><span class="p">]])</span>

        <span class="n">stiffForce</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&quot;kT&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kT</span><span class="p">)</span>
        <span class="n">stiffForce</span><span class="o">.</span><span class="n">addPerAngleParameter</span><span class="p">(</span><span class="s">&quot;angK&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s">&quot;AngleForce&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">({</span><span class="s">&quot;stiffness&quot;</span><span class="p">:</span> <span class="n">k</span><span class="p">})</span>
</div>
<div class="viewcode-block" id="Simulation.addGrosbergStiffness"><a class="viewcode-back" href="../openmmlib.html#openmmlib.Simulation.addGrosbergStiffness">[docs]</a>    <span class="k">def</span> <span class="nf">addGrosbergStiffness</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mf">1.5</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adds stiffness according to the Grosberg paper.</span>
<span class="sd">        (Halverson, Jonathan D., et al. &quot;Molecular dynamics simulation study of</span>
<span class="sd">         nonconcatenated ring polymers in a melt. I. Statics.&quot;</span>
<span class="sd">         The Journal of chemical physics 134 (2011): 204904.)</span>

<span class="sd">        Parameters are synchronized with normal stiffness</span>

<span class="sd">        If k is an array, it has to be of the length N.</span>
<span class="sd">        Xth value then specifies stiffness of the angle centered at</span>
<span class="sd">        monomer number X.</span>
<span class="sd">        Values for ends of the chain will be simply ignored.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        k : float or N-long list of floats</span>
<span class="sd">            Synchronized with regular stiffness.</span>
<span class="sd">            Default value is very flexible, as in Grosberg paper.</span>
<span class="sd">            Default value maximizes entanglement length.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="o">+</span> <span class="n">k</span>
        <span class="n">stiffForce</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">CustomAngleForce</span><span class="p">(</span>
            <span class="s">&quot;GRk * kT * (1 - cos(theta - 3.141592))&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forceDict</span><span class="p">[</span><span class="s">&quot;AngleForce&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stiffForce</span>

        <span class="n">stiffForce</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&quot;kT&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kT</span><span class="p">)</span>
        <span class="n">stiffForce</span><span class="o">.</span><span class="n">addPerAngleParameter</span><span class="p">(</span><span class="s">&quot;GRk&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">isRing</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">chains</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">end</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">stiffForce</span><span class="o">.</span><span class="n">addAngle</span><span class="p">(</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="n">k</span><span class="p">[</span><span class="n">j</span><span class="p">]])</span>
            <span class="k">if</span> <span class="n">isRing</span><span class="p">:</span>
                <span class="n">stiffForce</span><span class="o">.</span><span class="n">addAngle</span><span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">end</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="p">[</span><span class="n">k</span><span class="p">[</span><span class="n">end</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]])</span>
                <span class="n">stiffForce</span><span class="o">.</span><span class="n">addAngle</span><span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="n">k</span><span class="p">[</span><span class="n">start</span><span class="p">]])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s">&quot;GrosbergAngleForce&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">({</span><span class="s">&quot;stiffness&quot;</span><span class="p">:</span> <span class="n">k</span><span class="p">})</span>
</div>
<div class="viewcode-block" id="Simulation.addMinimizingRepulsiveForce"><a class="viewcode-back" href="../openmmlib.html#openmmlib.Simulation.addMinimizingRepulsiveForce">[docs]</a>    <span class="k">def</span> <span class="nf">addMinimizingRepulsiveForce</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds a special force which could be use for very efficient resolution of crossings</span>
<span class="sd">        Use this force if your monomers are all &quot;on top of each other&quot;</span>
<span class="sd">        E.g. if you start your simulations with fractional brownyan motion with h &lt; 0.4</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conlen</span> <span class="o">*</span> <span class="mf">1.3</span>

        <span class="n">nbCutOffDist</span> <span class="o">=</span> <span class="n">radius</span> <span class="o">*</span> <span class="mf">1.</span>
        <span class="n">repul_energy</span> <span class="o">=</span> <span class="s">&quot;1000* REPe * (1-r/REPr)^2 &quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">forceDict</span><span class="p">[</span><span class="s">&quot;NonbondedMinim&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">CustomNonbondedForce</span><span class="p">(</span>
            <span class="n">repul_energy</span><span class="p">)</span>
        <span class="n">repulforceGr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forceDict</span><span class="p">[</span><span class="s">&quot;NonbondedMinim&quot;</span><span class="p">]</span>
        <span class="n">repulforceGr</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&#39;REPe&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kT</span><span class="p">)</span>
        <span class="n">repulforceGr</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&#39;REPr&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kT</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">):</span>
            <span class="n">repulforceGr</span><span class="o">.</span><span class="n">addParticle</span><span class="p">(())</span>
        <span class="n">repulforceGr</span><span class="o">.</span><span class="n">setCutoffDistance</span><span class="p">(</span><span class="n">nbCutOffDist</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="Simulation.addGrosbergRepulsiveForce"><a class="viewcode-back" href="../openmmlib.html#openmmlib.Simulation.addGrosbergRepulsiveForce">[docs]</a>    <span class="k">def</span> <span class="nf">addGrosbergRepulsiveForce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trunc</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">radiusMult</span><span class="o">=</span><span class="mf">1.</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This is the fastest non-transparent repulsive force.</span>
<span class="sd">        Done according to the paper:</span>
<span class="sd">        (Halverson, Jonathan D., et al. &quot;Molecular dynamics simulation study of</span>
<span class="sd">         nonconcatenated ring polymers in a melt. I. Statics.&quot;</span>
<span class="sd">         The Journal of chemical physics 134 (2011): 204904.)</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        trunc : None or float</span>
<span class="sd">             truncation energy in kT, used for chain crossing.</span>
<span class="sd">             Value of 1.5 yields frequent passing,</span>
<span class="sd">             3 - average passing, 5 - rare passing.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conlen</span> <span class="o">*</span> <span class="n">radiusMult</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s">&quot;GrosbergRepulsiveForce&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">({</span><span class="s">&quot;trunc&quot;</span><span class="p">:</span> <span class="n">trunc</span><span class="p">})</span>
        <span class="n">nbCutOffDist</span> <span class="o">=</span> <span class="n">radius</span> <span class="o">*</span> <span class="mf">2.</span> <span class="o">**</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="mf">6.</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">trunc</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">repul_energy</span> <span class="o">=</span> <span class="s">&quot;4 * REPe * ((REPsigma/r)^12 - (REPsigma/r)^6) + REPe&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">repul_energy</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s">&quot;step(REPcut2 - REPU) * REPU&quot;</span>
                <span class="s">&quot; + step(REPU - REPcut2) * REPcut2 * (1 + tanh(REPU/REPcut2 - 1));&quot;</span>
                <span class="s">&quot;REPU = 4 * REPe * ((REPsigma/r2)^12 - (REPsigma/r2)^6) + REPe;&quot;</span>
                <span class="s">&quot;r2 = (r^10. + (REPsigma03)^10.)^0.1&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forceDict</span><span class="p">[</span><span class="s">&quot;Nonbonded&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">CustomNonbondedForce</span><span class="p">(</span>
            <span class="n">repul_energy</span><span class="p">)</span>
        <span class="n">repulforceGr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forceDict</span><span class="p">[</span><span class="s">&quot;Nonbonded&quot;</span><span class="p">]</span>
        <span class="n">repulforceGr</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&#39;REPe&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kT</span><span class="p">)</span>

        <span class="n">repulforceGr</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&#39;REPsigma&#39;</span><span class="p">,</span> <span class="n">radius</span><span class="p">)</span>
        <span class="n">repulforceGr</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&#39;REPsigma03&#39;</span><span class="p">,</span> <span class="mf">0.3</span> <span class="o">*</span> <span class="n">radius</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">trunc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">repulforceGr</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&#39;REPcut&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kT</span> <span class="o">*</span> <span class="n">trunc</span><span class="p">)</span>
            <span class="n">repulforceGr</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&#39;REPcut2&#39;</span><span class="p">,</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">trunc</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">kT</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">):</span>
            <span class="n">repulforceGr</span><span class="o">.</span><span class="n">addParticle</span><span class="p">(())</span>

        <span class="n">repulforceGr</span><span class="o">.</span><span class="n">setCutoffDistance</span><span class="p">(</span><span class="n">nbCutOffDist</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Simulation.addPolynomialRepulsiveForce"><a class="viewcode-back" href="../openmmlib.html#openmmlib.Simulation.addPolynomialRepulsiveForce">[docs]</a>    <span class="k">def</span> <span class="nf">addPolynomialRepulsiveForce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trunc</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">radiusMult</span><span class="o">=</span><span class="mf">1.</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This is a simple polynomial repulsive potential. It has the value</span>
<span class="sd">        of `trunc` at zero, stays flat until 0.6-0.7 and then drops to zero</span>
<span class="sd">        together with its first derivative at r=1.0.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        trunc : float</span>
<span class="sd">            the energy value around r=0</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conlen</span> <span class="o">*</span> <span class="n">radiusMult</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s">&quot;PolynomialRepulsiveForce&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">({</span><span class="s">&quot;trunc&quot;</span><span class="p">:</span> <span class="n">trunc</span><span class="p">})</span>
        <span class="n">nbCutOffDist</span> <span class="o">=</span> <span class="n">radius</span>
        <span class="n">repul_energy</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s">&quot;rsc12 * (rsc2 - 1.0) * REPe / REPemin + REPe;&quot;</span>
            <span class="s">&quot;rsc12 = rsc4 * rsc4 * rsc4;&quot;</span>
            <span class="s">&quot;rsc4 = rsc2 * rsc2;&quot;</span>
            <span class="s">&quot;rsc2 = rsc * rsc;&quot;</span>
            <span class="s">&quot;rsc = r / REPsigma * REPrmin;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forceDict</span><span class="p">[</span><span class="s">&quot;Nonbonded&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">CustomNonbondedForce</span><span class="p">(</span>
            <span class="n">repul_energy</span><span class="p">)</span>
        <span class="n">repulforceGr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forceDict</span><span class="p">[</span><span class="s">&quot;Nonbonded&quot;</span><span class="p">]</span>

        <span class="n">repulforceGr</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&#39;REPe&#39;</span><span class="p">,</span> <span class="n">trunc</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">kT</span><span class="p">)</span>
        <span class="n">repulforceGr</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&#39;REPsigma&#39;</span><span class="p">,</span> <span class="n">radius</span><span class="p">)</span>
        <span class="c"># Coefficients for x^8*(x*x-1)</span>
        <span class="c"># repulforceGr.addGlobalParameter(&#39;REPemin&#39;, 256.0 / 3125.0)</span>
        <span class="c"># repulforceGr.addGlobalParameter(&#39;REPrmin&#39;, 2.0 / np.sqrt(5.0))</span>
        <span class="c"># Coefficients for x^12*(x*x-1)</span>
        <span class="n">repulforceGr</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&#39;REPemin&#39;</span><span class="p">,</span> <span class="mf">46656.0</span> <span class="o">/</span> <span class="mf">823543.0</span><span class="p">)</span>
        <span class="n">repulforceGr</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&#39;REPrmin&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">6.0</span> <span class="o">/</span> <span class="mf">7.0</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">):</span>
            <span class="n">repulforceGr</span><span class="o">.</span><span class="n">addParticle</span><span class="p">(())</span>

        <span class="n">repulforceGr</span><span class="o">.</span><span class="n">setCutoffDistance</span><span class="p">(</span><span class="n">nbCutOffDist</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Simulation.addSmoothSquareWellForce"><a class="viewcode-back" href="../openmmlib.html#openmmlib.Simulation.addSmoothSquareWellForce">[docs]</a>    <span class="k">def</span> <span class="nf">addSmoothSquareWellForce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="n">repulsionEnergy</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">repulsionRadius</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span>
        <span class="n">attractionEnergy</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">attractionRadius</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span>
        <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is a simple and fast polynomial force that looks like a smoothed</span>
<span class="sd">        version of the square-well potential. The energy equals `repulsionEnergy`</span>
<span class="sd">        around r=0, stays flat until 0.6-0.7, then drops to zero together</span>
<span class="sd">        with its first derivative at r=1.0. After that it drop down to</span>
<span class="sd">        `attractionEnergy` and gets back to zero at r=`attractionRadius`.</span>

<span class="sd">        The energy function is based on polynomials of 12th power. Both the</span>
<span class="sd">        function and its first derivative is continuous everywhere within its</span>
<span class="sd">        domain and they both get to zero at the boundary.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        repulsionEnergy: float</span>
<span class="sd">            the heigth of the repulsive part of the potential.</span>
<span class="sd">            E(0) = `repulsionEnergy`</span>
<span class="sd">        repulsionRadius: float</span>
<span class="sd">            the radius of the repulsive part of the potential.</span>
<span class="sd">            E(`repulsionRadius`) = 0,</span>
<span class="sd">            E&#39;(`repulsionRadius`) = 0</span>
<span class="sd">        attractionEnergy: float</span>
<span class="sd">            the depth of the attractive part of the potential.</span>
<span class="sd">            E(`repulsionRadius`/2 + `attractionRadius`/2) = `attractionEnergy`</span>
<span class="sd">        attractionEnergy: float</span>
<span class="sd">            the maximal range of the attractive part of the potential.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nbCutOffDist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conlen</span> <span class="o">*</span> <span class="n">attractionRadius</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s">&quot;PolynomialAttractiveForce&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">({</span><span class="s">&quot;trunc&quot;</span><span class="p">:</span> <span class="n">repulsionEnergy</span><span class="p">})</span>
        <span class="n">energy</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s">&quot;step(REPsigma - r) * Erep + step(r - REPsigma) * Eattr;&quot;</span>
            <span class="s">&quot;&quot;</span>
            <span class="s">&quot;Erep = rsc12 * (rsc2 - 1.0) * REPe / emin12 + REPe;&quot;</span>
            <span class="s">&quot;rsc12 = rsc4 * rsc4 * rsc4;&quot;</span>
            <span class="s">&quot;rsc4 = rsc2 * rsc2;&quot;</span>
            <span class="s">&quot;rsc2 = rsc * rsc;&quot;</span>
            <span class="s">&quot;rsc = r / REPsigma * rmin12;&quot;</span>
            <span class="s">&quot;&quot;</span>
            <span class="s">&quot;Eattr = - rshft12 * (rshft2 - 1.0) * ATTRe / emin12 - ATTRe;&quot;</span>
            <span class="s">&quot;rshft12 = rshft4 * rshft2 * rshft4;&quot;</span>
            <span class="s">&quot;rshft4 = rshft2 * rshft2;&quot;</span>
            <span class="s">&quot;rshft2 = rshft * rshft;&quot;</span>
            <span class="s">&quot;rshft = (r - REPsigma - ATTRdelta) / ATTRdelta * rmin12&quot;</span>

            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forceDict</span><span class="p">[</span><span class="s">&quot;Nonbonded&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">CustomNonbondedForce</span><span class="p">(</span>
            <span class="n">energy</span><span class="p">)</span>
        <span class="n">repulforceGr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forceDict</span><span class="p">[</span><span class="s">&quot;Nonbonded&quot;</span><span class="p">]</span>

        <span class="n">repulforceGr</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&#39;REPe&#39;</span><span class="p">,</span> <span class="n">repulsionEnergy</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">kT</span><span class="p">)</span>
        <span class="n">repulforceGr</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&#39;REPsigma&#39;</span><span class="p">,</span> <span class="n">repulsionRadius</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">conlen</span><span class="p">)</span>

        <span class="n">repulforceGr</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&#39;ATTRe&#39;</span><span class="p">,</span> <span class="n">attractionEnergy</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">kT</span><span class="p">)</span>
        <span class="n">repulforceGr</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&#39;ATTRdelta&#39;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conlen</span> <span class="o">*</span> <span class="p">(</span><span class="n">attractionRadius</span> <span class="o">-</span> <span class="n">repulsionRadius</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span>
        <span class="c"># Coefficients for the minimum of x^12*(x*x-1)</span>
        <span class="n">repulforceGr</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&#39;emin12&#39;</span><span class="p">,</span> <span class="mf">46656.0</span> <span class="o">/</span> <span class="mf">823543.0</span><span class="p">)</span>
        <span class="n">repulforceGr</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&#39;rmin12&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">6.0</span> <span class="o">/</span> <span class="mf">7.0</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">):</span>
            <span class="n">repulforceGr</span><span class="o">.</span><span class="n">addParticle</span><span class="p">(())</span>

        <span class="n">repulforceGr</span><span class="o">.</span><span class="n">setCutoffDistance</span><span class="p">(</span><span class="n">nbCutOffDist</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Simulation.addSmoothSquareWellTailedForce"><a class="viewcode-back" href="../openmmlib.html#openmmlib.Simulation.addSmoothSquareWellTailedForce">[docs]</a>    <span class="k">def</span> <span class="nf">addSmoothSquareWellTailedForce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="n">repulsionEnergy</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">repulsionRadius</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span>
        <span class="n">attractionEnergy</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">attractionRadius</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span>
        <span class="n">tailEnergy</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">tailRadius</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span>
        <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is almost the same potential as in `addSmoothSquareWellTailedForce`.</span>
<span class="sd">        The only difference is that the attractive part of the potential</span>
<span class="sd">        flattens out to the value of `tailEnergy` at r=`attractionRadius` and</span>
<span class="sd">        then goes quadratically to zero at `tailRadius`.</span>
<span class="sd">        Please, refer to the documentation for `addSmoothSquareWellForce`</span>
<span class="sd">        for the details of the repulsive and attractive parts of the potential.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        kwargs:</span>
<span class="sd">            same as in `addSmoothSquareWellForce`.</span>
<span class="sd">        tailEnergy:</span>
<span class="sd">            the depth of the tail part of the potential.</span>
<span class="sd">        tailRadius:</span>
<span class="sd">            the maximal range of the tail part of the potential.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s">&quot;PolynomialAttractiveForce&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">({</span><span class="s">&quot;trunc&quot;</span><span class="p">:</span> <span class="n">repulsionEnergy</span><span class="p">})</span>
        <span class="n">energy</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s">&quot;step(REPsigma - r) * Erep &quot;</span>
            <span class="s">&quot;+ step(r - REPsigma) * step(REPsigma + ATTRdelta - r) * Eattr_inner&quot;</span>
            <span class="s">&quot;+ step(r - REPsigma - ATTRdelta) * step(REPsigma + 2.0 * ATTRdelta - r) * Eattr_outer&quot;</span>
            <span class="s">&quot;+ step(r - REPsigma - ATTRdelta) * Etail;&quot;</span>
            <span class="s">&quot;&quot;</span>
            <span class="s">&quot;Erep = rsc12 * (rsc2 - 1.0) * REPe / emin12 + REPe;&quot;</span>
            <span class="s">&quot;rsc12 = rsc4 * rsc4 * rsc4;&quot;</span>
            <span class="s">&quot;rsc4 = rsc2 * rsc2;&quot;</span>
            <span class="s">&quot;rsc2 = rsc * rsc;&quot;</span>
            <span class="s">&quot;rsc = r / REPsigma * rmin12;&quot;</span>
            <span class="s">&quot;&quot;</span>
            <span class="s">&quot;Eattr_inner = - poly * ATTRe;&quot;</span>
            <span class="s">&quot;Eattr_outer = - poly * (ATTRe - TAILe) - TAILe;&quot;</span>
            <span class="s">&quot;poly = rshft12 * (rshft2 - 1.0) / emin12 + 1.0;&quot;</span>
            <span class="s">&quot;rshft12 = rshft4 * rshft4 * rshft4;&quot;</span>
            <span class="s">&quot;rshft4 = rshft2 * rshft2;&quot;</span>
            <span class="s">&quot;rshft2 = rshft * rshft;&quot;</span>
            <span class="s">&quot;rshft = (r - REPsigma - ATTRdelta) / ATTRdelta * rmin12;&quot;</span>
            <span class="s">&quot;&quot;</span>
            <span class="s">&quot;Etail = - TAILe * rtail * rtail * (rtail - 1.0) * (rtail - 1.0) * 16.0;&quot;</span>
            <span class="s">&quot;rtail = (r - REPsigma - 2 * ATTRdelta) / TAILr / 2.0 + 0.5;&quot;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forceDict</span><span class="p">[</span><span class="s">&quot;Nonbonded&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">CustomNonbondedForce</span><span class="p">(</span>
            <span class="n">energy</span><span class="p">)</span>
        <span class="n">repulforceGr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forceDict</span><span class="p">[</span><span class="s">&quot;Nonbonded&quot;</span><span class="p">]</span>

        <span class="n">repulforceGr</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&#39;REPe&#39;</span><span class="p">,</span> <span class="n">repulsionEnergy</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">kT</span><span class="p">)</span>
        <span class="n">repulforceGr</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&#39;REPsigma&#39;</span><span class="p">,</span> <span class="n">repulsionRadius</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">conlen</span><span class="p">)</span>

        <span class="n">repulforceGr</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&#39;ATTRe&#39;</span><span class="p">,</span> <span class="n">attractionEnergy</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">kT</span><span class="p">)</span>
        <span class="n">repulforceGr</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&#39;ATTRdelta&#39;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conlen</span> <span class="o">*</span> <span class="p">(</span><span class="n">attractionRadius</span> <span class="o">-</span> <span class="n">repulsionRadius</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span>

        <span class="n">repulforceGr</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&#39;TAILe&#39;</span><span class="p">,</span> <span class="n">tailEnergy</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">kT</span><span class="p">)</span>
        <span class="n">repulforceGr</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&#39;TAILr&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">tailRadius</span> <span class="o">-</span> <span class="n">attractionRadius</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">kT</span><span class="p">)</span>

        <span class="c"># Coefficients for the minimum of x^12*(x*x-1)</span>
        <span class="n">repulforceGr</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&#39;emin12&#39;</span><span class="p">,</span> <span class="mf">46656.0</span> <span class="o">/</span> <span class="mf">823543.0</span><span class="p">)</span>
        <span class="n">repulforceGr</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&#39;rmin12&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">6.0</span> <span class="o">/</span> <span class="mf">7.0</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">):</span>
            <span class="n">repulforceGr</span><span class="o">.</span><span class="n">addParticle</span><span class="p">(())</span>

        <span class="n">repulforceGr</span><span class="o">.</span><span class="n">setCutoffDistance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conlen</span> <span class="o">*</span> <span class="n">tailRadius</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Simulation.addLennardJonesForce"><a class="viewcode-back" href="../openmmlib.html#openmmlib.Simulation.addLennardJonesForce">[docs]</a>    <span class="k">def</span> <span class="nf">addLennardJonesForce</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span> <span class="n">domains</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">epsilonRep</span><span class="o">=</span><span class="mf">0.24</span><span class="p">,</span> <span class="n">epsilonAttr</span><span class="o">=</span><span class="mf">0.27</span><span class="p">,</span>
        <span class="n">blindFraction</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">sigmaRep</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">sigmaAttr</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds a lennard-jones force, that allows for mutual attraction.</span>
<span class="sd">        This is the slowest force out of all repulsive.</span>

<span class="sd">        .. note ::</span>
<span class="sd">            This is the only force that allows for so-called &quot;exceptions&#39;.</span>
<span class="sd">            Exceptions allow you to change parameters of the force</span>
<span class="sd">            for a specific pair of particles.</span>
<span class="sd">            This can be used to create short-range attraction between</span>
<span class="sd">            pairs of particles.</span>
<span class="sd">            See manual for Openmm.NonbondedForce.addException.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        cutoff : float, optional</span>
<span class="sd">            Cutoff value. Default is good.</span>
<span class="sd">        domains : bool, optional</span>
<span class="sd">            Use domains, defined by</span>
<span class="sd">            :py:func:&#39;setDomains &lt;Simulation.setDomains&gt;&#39;</span>
<span class="sd">        epsilonRep : float, optional</span>
<span class="sd">            Epsilon (attraction strength) for LJ-force for all particles</span>
<span class="sd">            (except for domain) in kT</span>
<span class="sd">        epsilonAttr : float, optional</span>
<span class="sd">            Epsilon for attractive domain (if domains are used) in kT</span>
<span class="sd">        blindFraction : float, 0&lt;x&lt;1</span>
<span class="sd">            Fraction of particles that are &quot;transparent&quot; -</span>
<span class="sd">            used here instead of truncation</span>
<span class="sd">        sigmaRep, sigmaAttr: float, optional</span>
<span class="sd">            Radius of particles in the LJ force. For advanced fine-tuning.</span>

<span class="sd">         &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s">&quot;LennardJonesForce&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">({</span><span class="s">&quot;cutoff&quot;</span><span class="p">:</span> <span class="n">cutoff</span><span class="p">,</span>
                  <span class="s">&quot;domains&quot;</span><span class="p">:</span> <span class="n">domains</span><span class="p">,</span> <span class="s">&quot;epsilonRep&quot;</span><span class="p">:</span> <span class="n">epsilonRep</span><span class="p">,</span>
                  <span class="s">&quot;epsilonAttr&quot;</span><span class="p">:</span> <span class="n">epsilonAttr</span><span class="p">,</span> <span class="s">&quot;blindFraction&quot;</span><span class="p">:</span> <span class="n">blindFraction</span><span class="p">})</span>

        <span class="k">if</span> <span class="n">blindFraction</span> <span class="o">&gt;</span> <span class="mf">0.99</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_exitProgram</span><span class="p">(</span><span class="s">&quot;why do you need this force without particles???&quot;</span>\
                             <span class="s">&quot; set blindFraction between 0 and 1&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">sigmaRep</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">sigmaAttr</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">):</span>
            <span class="n">sigmaAttr</span> <span class="o">=</span> <span class="n">sigmaRep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conlen</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sigmaAttr</span> <span class="o">=</span> <span class="n">sigmaAttr</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">conlen</span>
            <span class="n">sigmaRep</span> <span class="o">=</span> <span class="n">sigmaRep</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">conlen</span>

        <span class="n">epsilonRep</span> <span class="o">=</span> <span class="n">epsilonRep</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">kT</span>
        <span class="n">epsilonAttr</span> <span class="o">=</span> <span class="n">epsilonAttr</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">kT</span>

        <span class="n">nbCutOffDist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conlen</span> <span class="o">*</span> <span class="n">cutoff</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epsilonRep</span> <span class="o">=</span> <span class="n">epsilonRep</span>
        <span class="n">repulforce</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">NonbondedForce</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">forceDict</span><span class="p">[</span><span class="s">&quot;Nonbonded&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">repulforce</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">):</span>
            <span class="n">particleParameters</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">blindFraction</span><span class="p">:</span>
                <span class="n">particleParameters</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">sigmaRep</span><span class="p">)</span>
                <span class="n">particleParameters</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">epsilonRep</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">domains</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">domains</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">particleParameters</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">sigmaAttr</span><span class="p">)</span>
                        <span class="n">particleParameters</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">epsilonAttr</span><span class="p">)</span>

            <span class="n">repulforce</span><span class="o">.</span><span class="n">addParticle</span><span class="p">(</span><span class="o">*</span><span class="n">particleParameters</span><span class="p">)</span>

        <span class="n">repulforce</span><span class="o">.</span><span class="n">setCutoffDistance</span><span class="p">(</span><span class="n">nbCutOffDist</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Simulation.addSoftLennardJonesForce"><a class="viewcode-back" href="../openmmlib.html#openmmlib.Simulation.addSoftLennardJonesForce">[docs]</a>    <span class="k">def</span> <span class="nf">addSoftLennardJonesForce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">0.42</span><span class="p">,</span> <span class="n">trunc</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="mf">2.5</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A softened version of lennard-Jones force.</span>
<span class="sd">        Now we&#39;re moving to polynomial forces, so go there instead.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">nbCutOffDist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conlen</span> <span class="o">*</span> <span class="n">cutoff</span>

        <span class="n">repul_energy</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s">&#39;step(REPcut2 - REPU) * REPU +&#39;</span>
            <span class="s">&#39; step(REPU - REPcut2) * REPcut2 * (1 + tanh(REPU/REPcut2 - 1));&#39;</span>
            <span class="s">&#39;REPU = 4 * REPe * ((REPsigma/r2)^12 - (REPsigma/r2)^6);&#39;</span>
            <span class="s">&#39;r2 = (r^10. + (REPsigma03)^10.)^0.1&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forceDict</span><span class="p">[</span><span class="s">&quot;Nonbonded&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">CustomNonbondedForce</span><span class="p">(</span>
            <span class="n">repul_energy</span><span class="p">)</span>
        <span class="n">repulforceGr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forceDict</span><span class="p">[</span><span class="s">&quot;Nonbonded&quot;</span><span class="p">]</span>
        <span class="n">repulforceGr</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&#39;REPe&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kT</span> <span class="o">*</span> <span class="n">epsilon</span><span class="p">)</span>

        <span class="n">repulforceGr</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&#39;REPsigma&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">conlen</span><span class="p">)</span>
        <span class="n">repulforceGr</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&#39;REPsigma03&#39;</span><span class="p">,</span> <span class="mf">0.3</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">conlen</span><span class="p">)</span>
        <span class="n">repulforceGr</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&#39;REPcut&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kT</span> <span class="o">*</span> <span class="n">trunc</span><span class="p">)</span>
        <span class="n">repulforceGr</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&#39;REPcut2&#39;</span><span class="p">,</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">trunc</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">kT</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">):</span>
            <span class="n">repulforceGr</span><span class="o">.</span><span class="n">addParticle</span><span class="p">(())</span>

        <span class="n">repulforceGr</span><span class="o">.</span><span class="n">setCutoffDistance</span><span class="p">(</span><span class="n">nbCutOffDist</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Simulation.addMutualException"><a class="viewcode-back" href="../openmmlib.html#openmmlib.Simulation.addMutualException">[docs]</a>    <span class="k">def</span> <span class="nf">addMutualException</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">particles</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;used to exclude a bunch of particles</span>
<span class="sd">        from calculation of nonbonded force</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        particles : list</span>
<span class="sd">            List of particles for whom to exclude nonbonded force.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">particles</span><span class="p">:</span>  <span class="c"># xrange(len(particles)):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">particles</span><span class="p">:</span>  <span class="c"># xrange(len(particles)):</span>
                <span class="k">if</span> <span class="n">j</span> <span class="o">&gt;</span> <span class="n">i</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">bondsForException</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="Simulation.addInteraction"><a class="viewcode-back" href="../openmmlib.html#openmmlib.Simulation.addInteraction">[docs]</a>    <span class="k">def</span> <span class="nf">addInteraction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adds attractive short-range interaction of strength epsilon</span>
<span class="sd">        between particles i,j and a few neighboring particles</span>
<span class="sd">        requires :py:func:&#39;LennardJones Force&lt;Simulation.addLennardJonesForce&gt;&#39;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        i,j : int</span>
<span class="sd">            Interacting particles</span>
<span class="sd">        epsilon : float</span>
<span class="sd">            LJ strength</span>
<span class="sd">        sigma : float, optional</span>
<span class="sd">            LJ length. If you increase it past 1.5, note the cutoff!</span>
<span class="sd">        length : int, optional, default = 3</span>
<span class="sd">            Number of particles around i,j that also attract each other</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s">&quot;interactions&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s">&quot;interactions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s">&quot;interactions&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">forceDict</span><span class="p">[</span><span class="s">&quot;Nonbonded&quot;</span><span class="p">])</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">NonbondedForce</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s">&quot;Cannot add interactions&quot;</span>\
                      <span class="s">&quot; without Lennard-Jones nonbonded force&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">sigma</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">sigma</span> <span class="o">=</span> <span class="mf">1.1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">conlen</span>
        <span class="n">epsilon</span> <span class="o">=</span> <span class="n">epsilon</span> <span class="o">*</span> <span class="n">units</span><span class="o">.</span><span class="n">kilocalorie_per_mole</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">-</span> <span class="n">length</span><span class="p">):</span>
            <span class="k">print</span> <span class="s">&quot;!!!!!!!!!bond with </span><span class="si">%d</span><span class="s"> and </span><span class="si">%d</span><span class="s"> is out of range!!!!!&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">repulforce</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forceDict</span><span class="p">[</span><span class="s">&quot;Nonbonded&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">t1</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="n">length</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="p">(</span><span class="n">length</span> <span class="o">-</span> <span class="n">length</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">t2</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">j</span> <span class="o">-</span> <span class="n">length</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="p">(</span><span class="n">length</span> <span class="o">-</span> <span class="n">length</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)):</span>
                <span class="n">repulforce</span><span class="o">.</span><span class="n">addException</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s">&quot;Exception added between&quot;</span>\
                    <span class="s">&quot; particles </span><span class="si">%d</span><span class="s"> and </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="n">length</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="n">length</span><span class="p">):</span>
            <span class="n">repulforce</span><span class="o">.</span><span class="n">setParticleParameters</span><span class="p">(</span>
                <span class="n">tt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">conlen</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilonRep</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">j</span> <span class="o">-</span> <span class="n">length</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="n">length</span><span class="p">):</span>
            <span class="n">repulforce</span><span class="o">.</span><span class="n">setParticleParameters</span><span class="p">(</span>
                <span class="n">tt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">conlen</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilonRep</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Simulation.addCylindricalConfinement"><a class="viewcode-back" href="../openmmlib.html#openmmlib.Simulation.addCylindricalConfinement">[docs]</a>    <span class="k">def</span> <span class="nf">addCylindricalConfinement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mi">9999</span><span class="p">):</span>
        <span class="s">&quot;As it says.&quot;</span>

        <span class="k">if</span> <span class="n">bottom</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="ne">DeprecationWarning</span><span class="p">(</span>
                <span class="s">&quot;Use bottom=0 instead of bottom = True! &quot;</span><span class="p">))</span>
            <span class="n">bottom</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s">&quot;CylindricalConfinement&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">({</span><span class="s">&quot;r&quot;</span><span class="p">:</span> <span class="n">r</span><span class="p">,</span>
            <span class="s">&quot;bottom&quot;</span><span class="p">:</span> <span class="n">bottom</span><span class="p">,</span> <span class="s">&quot;k&quot;</span><span class="p">:</span> <span class="n">k</span><span class="p">,</span> <span class="s">&quot;top&quot;</span><span class="p">:</span> <span class="n">top</span><span class="p">})</span>

        <span class="k">if</span> <span class="n">bottom</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">extforce2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">CustomExternalForce</span><span class="p">(</span>
                <span class="s">&quot;step(r-CYLaa) * CYLkb * (sqrt((r-CYLaa)*(r-CYLaa) + CYLt*CYLt) - CYLt)&quot;</span>
                <span class="s">&quot;+ step(-z + CYLbot) * CYLkb * (sqrt((z - CYLbot)^2 + CYLt^2) - CYLt) &quot;</span>
                <span class="s">&quot;+ step(z - CYLtop) * CYLkb * (sqrt((z - CYLtop)^2 + CYLt^2) - CYLt);&quot;</span>
                <span class="s">&quot;r = sqrt(x^2 + y^2 + CYLtt^2)&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">extforce2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">CustomExternalForce</span><span class="p">(</span>
                <span class="s">&quot;step(r-CYLaa) * CYLkb * (sqrt((r-CYLaa)*(r-CYLaa) + CYLt*CYLt) - CYLt);&quot;</span>
                <span class="s">&quot;r = sqrt(x^2 + y^2 + CYLtt^2)&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">forceDict</span><span class="p">[</span><span class="s">&quot;CylindricalConfinement&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">extforce2</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">):</span>
            <span class="n">extforce2</span><span class="o">.</span><span class="n">addParticle</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">extforce2</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&quot;CYLkb&quot;</span><span class="p">,</span> <span class="n">k</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">kT</span> <span class="o">/</span> <span class="n">nm</span><span class="p">)</span>
        <span class="n">extforce2</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&quot;CYLtop&quot;</span><span class="p">,</span> <span class="n">top</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">conlen</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bottom</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">extforce2</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&quot;CYLbot&quot;</span><span class="p">,</span> <span class="n">bottom</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">conlen</span><span class="p">)</span>
        <span class="n">extforce2</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&quot;CYLkt&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kT</span><span class="p">)</span>
        <span class="n">extforce2</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&quot;CYLweired&quot;</span><span class="p">,</span> <span class="n">nm</span><span class="p">)</span>
        <span class="n">extforce2</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&quot;CYLaa&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="n">nm</span><span class="p">)</span>
        <span class="n">extforce2</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&quot;CYLt&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="n">k</span><span class="p">))</span> <span class="o">*</span> <span class="n">nm</span><span class="p">)</span>
        <span class="n">extforce2</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&quot;CYLtt&quot;</span><span class="p">,</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="n">nm</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Simulation.addSphericalConfinement"><a class="viewcode-back" href="../openmmlib.html#openmmlib.Simulation.addSphericalConfinement">[docs]</a>    <span class="k">def</span> <span class="nf">addSphericalConfinement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">r</span><span class="o">=</span><span class="s">&quot;density&quot;</span><span class="p">,</span>  <span class="c"># radius... by default uses certain density</span>
                <span class="n">k</span><span class="o">=</span><span class="mf">5.</span><span class="p">,</span>  <span class="c"># How steep the walls are</span>
                <span class="n">density</span><span class="o">=.</span><span class="mi">3</span><span class="p">):</span>  <span class="c"># target density, measured in particles</span>
                                <span class="c"># per cubic nanometer (bond size is 1 nm)</span>
        <span class="sd">&quot;&quot;&quot;Constrain particles to be within a sphere.</span>
<span class="sd">        With no parameters creates sphere with density .3</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        r : float or &quot;density&quot;, optional</span>
<span class="sd">            Radius of confining sphere. If &quot;density&quot; requires density,</span>
<span class="sd">            or assumes density = .3</span>
<span class="sd">        k : float, optional</span>
<span class="sd">            Steepness of the confining potential, in kT/nm</span>
<span class="sd">        density : float, optional, &lt;1</span>
<span class="sd">            Density for autodetection of confining radius.</span>
<span class="sd">            Density is calculated in particles per nm^3,</span>
<span class="sd">            i.e. at density 1 each sphere has a 1x1x1 cube.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s">&quot;SphericalConfinement&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">({</span><span class="s">&quot;r&quot;</span><span class="p">:</span> <span class="n">r</span><span class="p">,</span> <span class="s">&quot;k&quot;</span><span class="p">:</span> <span class="n">k</span><span class="p">,</span>
            <span class="s">&quot;density&quot;</span><span class="p">:</span> <span class="n">density</span><span class="p">})</span>

        <span class="n">spherForce</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">CustomExternalForce</span><span class="p">(</span>
            <span class="s">&quot;step(r-SPHaa) * SPHkb * (sqrt((r-SPHaa)*(r-SPHaa) + SPHt*SPHt) - SPHt) &quot;</span>
            <span class="s">&quot;;r = sqrt(x^2 + y^2 + z^2 + SPHtt^2)&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forceDict</span><span class="p">[</span><span class="s">&quot;SphericalConfinement&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spherForce</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">):</span>
            <span class="n">spherForce</span><span class="o">.</span><span class="n">addParticle</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">if</span> <span class="n">r</span> <span class="o">==</span> <span class="s">&quot;density&quot;</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="mf">3.141592</span> <span class="o">*</span> <span class="n">density</span><span class="p">))</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="mf">3.</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sphericalConfinementRadius</span> <span class="o">=</span> <span class="n">r</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;Spherical confinement with radius = </span><span class="si">%lf</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">r</span>
        <span class="c"># assigning parameters of the force</span>
        <span class="n">spherForce</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&quot;SPHkb&quot;</span><span class="p">,</span> <span class="n">k</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">kT</span> <span class="o">/</span> <span class="n">nm</span><span class="p">)</span>
        <span class="n">spherForce</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&quot;SPHaa&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="n">nm</span><span class="p">)</span>
        <span class="n">spherForce</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&quot;SPHt&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="n">nm</span> <span class="o">/</span> <span class="mf">10.</span><span class="p">)</span>
        <span class="n">spherForce</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&quot;SPHtt&quot;</span><span class="p">,</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="n">nm</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">r</span>
</div>
    <span class="k">def</span> <span class="nf">addAndersenThermostat</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s">&quot;AndersenThermostat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">({})</span>
        <span class="n">andersenThermo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">AndersenThermostat</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">temperature</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">collisionRate</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forceDict</span><span class="p">[</span><span class="s">&quot;AndersenThermostat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">andersenThermo</span>

<div class="viewcode-block" id="Simulation.excludeSphere"><a class="viewcode-back" href="../openmmlib.html#openmmlib.Simulation.excludeSphere">[docs]</a>    <span class="k">def</span> <span class="nf">excludeSphere</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)):</span>
        <span class="sd">&quot;&quot;&quot;Excludes particles from a sphere of radius r at certain position.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">spherForce</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">CustomExternalForce</span><span class="p">(</span>
            <span class="s">&quot;step(EXaa-r) * EXkb * (sqrt((r-EXaa)*(r-EXaa) + EXt*EXt) - EXt) ;&quot;</span>
            <span class="s">&quot;r = sqrt((x-EXx)^2 + (y-EXy)^2 + (z-EXz)^2 + EXtt^2)&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forceDict</span><span class="p">[</span><span class="s">&quot;ExcludeSphere&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spherForce</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">):</span>
            <span class="n">spherForce</span><span class="o">.</span><span class="n">addParticle</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">[])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sphericalConfinementRadius</span> <span class="o">=</span> <span class="n">r</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;Spherical confinement with radius = </span><span class="si">%lf</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">r</span>
        <span class="c"># assigning parameters of the force</span>
        <span class="n">spherForce</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&quot;EXkb&quot;</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">kT</span> <span class="o">/</span> <span class="n">nm</span><span class="p">)</span>
        <span class="n">spherForce</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&quot;EXaa&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="mf">1.</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">nm</span><span class="p">)</span>
        <span class="n">spherForce</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&quot;EXt&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">nm</span> <span class="o">/</span> <span class="mf">10.</span><span class="p">)</span>
        <span class="n">spherForce</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&quot;EXtt&quot;</span><span class="p">,</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="n">nm</span><span class="p">)</span>
        <span class="n">spherForce</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&quot;EXx&quot;</span><span class="p">,</span> <span class="n">position</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">conlen</span><span class="p">)</span>
        <span class="n">spherForce</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&quot;EXy&quot;</span><span class="p">,</span> <span class="n">position</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">conlen</span><span class="p">)</span>
        <span class="n">spherForce</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&quot;EXz&quot;</span><span class="p">,</span> <span class="n">position</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">conlen</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Simulation.addLaminaAttraction"><a class="viewcode-back" href="../openmmlib.html#openmmlib.Simulation.addLaminaAttraction">[docs]</a>    <span class="k">def</span> <span class="nf">addLaminaAttraction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Attracts one domain to the lamina. Infers radius</span>
<span class="sd">        from spherical confinement, that has to be initialized already.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        width : float, optional</span>
<span class="sd">            Width of attractive layer next to the lamina, nm.</span>
<span class="sd">        depth : float, optional</span>
<span class="sd">            Depth of attractive potential in kT</span>
<span class="sd">        r : float, optional</span>
<span class="sd">            Radius of an attractive cage. If not specified, inferred</span>
<span class="sd">            from previously defined spherical potential.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s">&quot;laminaAttraction&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">({</span><span class="s">&quot;width&quot;</span><span class="p">:</span> <span class="n">width</span><span class="p">,</span>
            <span class="s">&quot;depth&quot;</span><span class="p">:</span> <span class="n">depth</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">:</span> <span class="n">r</span><span class="p">})</span>
        <span class="n">laminaForce</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">CustomExternalForce</span><span class="p">(</span>
            <span class="s">&quot;step(LAMr-LAMaa + LAMwidth) * step(LAMaa + LAMwidth - LAMr) &quot;</span>
            <span class="s">&quot;* LAMdepth * (LAMr-LAMaa + LAMwidth) * (LAMaa + LAMwidth - LAMr) &quot;</span>
            <span class="s">&quot;/ (LAMwidth * LAMwidth);&quot;</span>
            <span class="s">&quot;LAMr = sqrt(x^2 + y^2 + z^2 + LAMtt^2)&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forceDict</span><span class="p">[</span><span class="s">&quot;Lamina attraction&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">laminaForce</span>

        <span class="c"># adding all the particles on which force acts</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">domains</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>
                <span class="n">laminaForce</span><span class="o">.</span><span class="n">addParticle</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">if</span> <span class="n">r</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sphericalConfinementRadius</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;No spherical confinement radius defined&quot;</span>\
                                 <span class="s">&quot; yet. Apply spherical confinement first!&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;Lamina attraction added with r = </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">r</span>

        <span class="n">laminaForce</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&quot;LAMaa&quot;</span><span class="p">,</span> <span class="n">r</span> <span class="o">*</span> <span class="n">nm</span><span class="p">)</span>
        <span class="n">laminaForce</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&quot;LAMwidth&quot;</span><span class="p">,</span> <span class="n">width</span> <span class="o">*</span> <span class="n">nm</span><span class="p">)</span>
        <span class="n">laminaForce</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&quot;LAMdepth&quot;</span><span class="p">,</span> <span class="n">depth</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">kT</span><span class="p">)</span>
        <span class="n">laminaForce</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&quot;LAMtt&quot;</span><span class="p">,</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="n">nm</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Simulation.tetherParticles"><a class="viewcode-back" href="../openmmlib.html#openmmlib.Simulation.tetherParticles">[docs]</a>    <span class="k">def</span> <span class="nf">tetherParticles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">particles</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">positions</span><span class="o">=</span><span class="s">&quot;current&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;tethers particles in the &#39;particles&#39; array.</span>
<span class="sd">        Increase k to tether them stronger, but watch the system!</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        particles : list of ints</span>
<span class="sd">            List of particles to be tethered (fixed in space)</span>
<span class="sd">        k : int, optional</span>
<span class="sd">            Steepness of the tethering potential.</span>
<span class="sd">            Values &gt;30 will require decreasing potential,</span>
<span class="sd">            but will make tethering rock solid.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s">&quot;TetheredParticles&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">({</span><span class="s">&quot;particles&quot;</span><span class="p">:</span> <span class="n">particles</span><span class="p">,</span> <span class="s">&quot;k&quot;</span><span class="p">:</span> <span class="n">k</span><span class="p">})</span>
        <span class="k">if</span> <span class="s">&quot;Tethering Force&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">forceDict</span><span class="p">:</span>
            <span class="n">tetherForce</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">CustomExternalForce</span><span class="p">(</span>
              <span class="s">&quot; TETHkb * ((x - TETHx0)^2 + (y - TETHy0)^2 + (z - TETHz0)^2)&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">forceDict</span><span class="p">[</span><span class="s">&quot;Tethering Force&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tetherForce</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tetherForce</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forceDict</span><span class="p">[</span><span class="s">&quot;Tethering Force&quot;</span><span class="p">]</span>

        <span class="c"># assigning parameters of the force</span>
        <span class="n">tetherForce</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&quot;TETHkb&quot;</span><span class="p">,</span> <span class="n">k</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">kT</span> <span class="o">/</span> <span class="n">nm</span><span class="p">)</span>
        <span class="n">tetherForce</span><span class="o">.</span><span class="n">addPerParticleParameter</span><span class="p">(</span><span class="s">&quot;TETHx0&quot;</span><span class="p">)</span>
        <span class="n">tetherForce</span><span class="o">.</span><span class="n">addPerParticleParameter</span><span class="p">(</span><span class="s">&quot;TETHy0&quot;</span><span class="p">)</span>
        <span class="n">tetherForce</span><span class="o">.</span><span class="n">addPerParticleParameter</span><span class="p">(</span><span class="s">&quot;TETHz0&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">positions</span> <span class="o">==</span> <span class="s">&quot;current&quot;</span><span class="p">:</span>
            <span class="n">positions</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">particles</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">addUnits</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pos</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">particles</span><span class="p">,</span> <span class="n">positions</span><span class="p">):</span>  <span class="c"># adding all the particles on which force acts</span>
            <span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">tetherForce</span><span class="o">.</span><span class="n">addParticle</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">pos</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;particle </span><span class="si">%d</span><span class="s"> tethered! &quot;</span> <span class="o">%</span> <span class="n">i</span>
</div>
<div class="viewcode-block" id="Simulation.addGravity"><a class="viewcode-back" href="../openmmlib.html#openmmlib.Simulation.addGravity">[docs]</a>    <span class="k">def</span> <span class="nf">addGravity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;adds force pulling downwards in z direction</span>
<span class="sd">        When using cutoff, acts only when z&gt;cutoff&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s">&quot;gravity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">({</span><span class="s">&quot;k&quot;</span><span class="p">:</span> <span class="n">k</span><span class="p">,</span> <span class="s">&quot;cutoff&quot;</span><span class="p">:</span> <span class="n">cutoff</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">cutoff</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">gravity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">CustomExternalForce</span><span class="p">(</span><span class="s">&quot;kG * z&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gravity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">CustomExternalForce</span><span class="p">(</span>
                <span class="s">&quot;kG * (z - cutoffG) * step(z - cutoffG)&quot;</span><span class="p">)</span>
            <span class="n">gravity</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&quot;cutoffG&quot;</span><span class="p">,</span> <span class="n">cutoff</span> <span class="o">*</span> <span class="n">nm</span><span class="p">)</span>
        <span class="n">gravity</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&quot;kG&quot;</span><span class="p">,</span> <span class="n">k</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">kT</span> <span class="o">/</span> <span class="p">(</span><span class="n">nm</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">):</span>
            <span class="n">gravity</span><span class="o">.</span><span class="n">addParticle</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forceDict</span><span class="p">[</span><span class="s">&quot;Gravity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gravity</span>
</div>
<div class="viewcode-block" id="Simulation.addPullForce"><a class="viewcode-back" href="../openmmlib.html#openmmlib.Simulation.addPullForce">[docs]</a>    <span class="k">def</span> <span class="nf">addPullForce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">particles</span><span class="p">,</span> <span class="n">forces</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;adds force pulling on each particle</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">pullForce</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">CustomExternalForce</span><span class="p">(</span>
            <span class="s">&quot;PULLx * x + PULLy * y + PULLz * z&quot;</span><span class="p">)</span>
        <span class="n">pullForce</span><span class="o">.</span><span class="n">addPerParticleParameter</span><span class="p">(</span><span class="s">&quot;PULLx&quot;</span><span class="p">)</span>
        <span class="n">pullForce</span><span class="o">.</span><span class="n">addPerParticleParameter</span><span class="p">(</span><span class="s">&quot;PULLy&quot;</span><span class="p">)</span>
        <span class="n">pullForce</span><span class="o">.</span><span class="n">addPerParticleParameter</span><span class="p">(</span><span class="s">&quot;PULLz&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">num</span><span class="p">,</span> <span class="n">force</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">particles</span><span class="p">,</span> <span class="n">forces</span><span class="p">):</span>
            <span class="n">force</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kT</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">conlen</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">force</span><span class="p">]</span>
            <span class="n">pullForce</span><span class="o">.</span><span class="n">addParticle</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">force</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forceDict</span><span class="p">[</span><span class="s">&quot;PullForce&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pullForce</span>
</div>
    <span class="k">def</span> <span class="nf">_applyForces</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adds all particles to the system.</span>
<span class="sd">        Then applies all the forces in the forcedict.</span>
<span class="sd">        Forces should not be modified after that, unless you do it carefully</span>
<span class="sd">        (see openmm reference).&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">forcesApplied</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loadParticles</span><span class="p">()</span>

        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bondsForException</span>
        <span class="k">print</span> <span class="s">&quot;Number of exceptions:&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">exc</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
            <span class="n">exc</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">exc</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">exc</span><span class="p">]</span>
            <span class="n">exc</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">exc</span><span class="p">))</span>  <span class="c"># only unique pairs are left</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">forceDict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>  <span class="c"># Adding exceptions</span>
            <span class="n">force</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forceDict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">force</span><span class="p">,</span> <span class="s">&quot;addException&quot;</span><span class="p">):</span>
                <span class="k">print</span> <span class="s">&#39;Add exceptions for {0} force&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">exc</span><span class="p">:</span>
                    <span class="n">force</span><span class="o">.</span><span class="n">addException</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                        <span class="nb">int</span><span class="p">(</span><span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">force</span><span class="p">,</span> <span class="s">&quot;addExclusion&quot;</span><span class="p">):</span>
                <span class="k">print</span> <span class="s">&#39;Add exclusions for {0} force&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">exc</span><span class="p">:</span>
                    <span class="c"># force.addExclusion(*pair)</span>
                    <span class="n">force</span><span class="o">.</span><span class="n">addExclusion</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">force</span><span class="p">,</span> <span class="s">&quot;CutoffNonPeriodic&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span>
                                                    <span class="n">force</span><span class="p">,</span> <span class="s">&quot;CutoffPeriodic&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">PBC</span><span class="p">:</span>
                    <span class="n">force</span><span class="o">.</span><span class="n">setNonbondedMethod</span><span class="p">(</span><span class="n">force</span><span class="o">.</span><span class="n">CutoffPeriodic</span><span class="p">)</span>
                    <span class="k">print</span> <span class="s">&quot;Using periodic boundary conditions!!!!&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">force</span><span class="o">.</span><span class="n">setNonbondedMethod</span><span class="p">(</span><span class="n">force</span><span class="o">.</span><span class="n">CutoffNonPeriodic</span><span class="p">)</span>
            <span class="k">print</span> <span class="s">&quot;adding force &quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">addForce</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">forceDict</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">integrator</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">platform</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initPositions</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initVelocities</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forcesApplied</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&quot;storage&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&quot;metadata&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="p">[</span><span class="s">&quot;metadata&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span>

<div class="viewcode-block" id="Simulation.initVelocities"><a class="viewcode-back" href="../openmmlib.html#openmmlib.Simulation.initVelocities">[docs]</a>    <span class="k">def</span> <span class="nf">initVelocities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mult</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initializes particles velocities</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        mult : float, optional</span>
<span class="sd">            Multiply velosities by this. Is good for a cold/hot start.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;No context, cannot set velocs.&quot;</span>\
                             <span class="s">&quot;Initialize context before that&quot;</span><span class="p">)</span>

        <span class="n">sigma</span> <span class="o">=</span> <span class="n">units</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kT</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">getParticleMass</span><span class="p">(</span>
            <span class="mi">0</span><span class="p">))</span>  <span class="c"># calculating mean velocity</span>
        <span class="n">velocs</span> <span class="o">=</span> <span class="n">units</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span><span class="n">mult</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span>
            <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="mi">3</span><span class="p">)),</span> <span class="n">units</span><span class="o">.</span><span class="n">meter</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">sigma</span> <span class="o">/</span> <span class="n">units</span><span class="o">.</span><span class="n">meter</span><span class="p">)</span>
        <span class="c"># Guide to simtk.unit: 1. Always use units.quantity.</span>
        <span class="c"># 2. Avoid dimensionless shit.</span>
        <span class="c"># 3. If you have to, create fake units, as done here with meters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">setVelocities</span><span class="p">(</span><span class="n">velocs</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Simulation.initPositions"><a class="viewcode-back" href="../openmmlib.html#openmmlib.Simulation.initPositions">[docs]</a>    <span class="k">def</span> <span class="nf">initPositions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sends particle coordinates to OpenMM system.</span>
<span class="sd">        If system has exploded, this is</span>
<span class="sd">         used in the code to reset coordinates. &quot;&quot;&quot;</span>

        <span class="k">print</span> <span class="s">&quot;Positions... &quot;</span><span class="p">,</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;No context, cannot set velocs.&quot;</span>\
                             <span class="s">&quot; Initialize context before that&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">setPositions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&quot; loaded!&quot;</span><span class="p">,</span>
        <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">getState</span><span class="p">(</span><span class="n">getPositions</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">getEnergy</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="c"># get state of a system: positions, energies</span>
        <span class="n">eP</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">getPotentialEnergy</span><span class="p">()</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">kT</span>
        <span class="k">print</span> <span class="s">&quot;potential energy is </span><span class="si">%lf</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">eP</span>
</div>
<div class="viewcode-block" id="Simulation.reinitialize"><a class="viewcode-back" href="../openmmlib.html#openmmlib.Simulation.reinitialize">[docs]</a>    <span class="k">def</span> <span class="nf">reinitialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mult</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reinitializes the OpenMM context object.</span>
<span class="sd">        This should be called if low-level parameters,</span>
<span class="sd">        such as forces, have changed.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        mult : float, optional</span>
<span class="sd">            mult to be passed to</span>
<span class="sd">             :py:func:&#39;initVelocities &lt;Simulation.initVelocities&gt;&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">reinitialize</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initPositions</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initVelocities</span><span class="p">(</span><span class="n">mult</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Simulation.localEnergyMinimization"><a class="viewcode-back" href="../openmmlib.html#openmmlib.Simulation.localEnergyMinimization">[docs]</a>    <span class="k">def</span> <span class="nf">localEnergyMinimization</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tolerance</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">maxIterations</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="s">&quot;A wrapper to the build-in OpenMM Local Energy Minimization&quot;</span>
        <span class="k">print</span> <span class="s">&quot;Performing local energy minimization&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_applyForces</span><span class="p">()</span>
        <span class="n">oldName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;minim&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">getState</span><span class="p">(</span><span class="n">getPositions</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                                           <span class="n">getEnergy</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">eK</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">getKineticEnergy</span><span class="p">()</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">kT</span><span class="p">)</span>
        <span class="n">eP</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">getPotentialEnergy</span><span class="p">()</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">kT</span>
        <span class="n">locTime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">getTime</span><span class="p">()</span>
        <span class="k">print</span> <span class="s">&quot;before minimization eK={0}, eP={1}, time={2}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">eK</span><span class="p">,</span> <span class="n">eP</span><span class="p">,</span> <span class="n">locTime</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">LocalEnergyMinimizer</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">tolerance</span><span class="p">,</span> <span class="n">maxIterations</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">getState</span><span class="p">(</span><span class="n">getPositions</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                                           <span class="n">getEnergy</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">eK</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">getKineticEnergy</span><span class="p">()</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">kT</span><span class="p">)</span>
        <span class="n">eP</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">getPotentialEnergy</span><span class="p">()</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">kT</span>
        <span class="n">locTime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">getTime</span><span class="p">()</span>
        <span class="k">print</span> <span class="s">&quot;after minimization eK={0}, eP={1}, time={2}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">eK</span><span class="p">,</span> <span class="n">eP</span><span class="p">,</span> <span class="n">locTime</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">oldName</span>
</div>
<div class="viewcode-block" id="Simulation.energyMinimization"><a class="viewcode-back" href="../openmmlib.html#openmmlib.Simulation.energyMinimization">[docs]</a>    <span class="k">def</span> <span class="nf">energyMinimization</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stepsPerIteration</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                           <span class="n">maxIterations</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
                           <span class="n">failNotConverged</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Runs system at smaller timestep and higher collision</span>
<span class="sd">        rate to resolve possible conflicts.</span>

<span class="sd">        Now we&#39;re moving towards local energy minimization,</span>
<span class="sd">        this is here for backwards compatibility.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">print</span> <span class="s">&quot;Performing energy minimization&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_applyForces</span><span class="p">()</span>
        <span class="n">oldName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;minim&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">maxIterations</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">maxIterations</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s">&quot;Please stop using the old notation and read the new energy minimization code&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">failNotConverged</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">True</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">failNotConverged</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">False</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s">&quot;Please stop using the old notation and read the new energy minimization code&quot;</span><span class="p">)</span>

        <span class="n">def_step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">integrator</span><span class="o">.</span><span class="n">getStepSize</span><span class="p">()</span>
        <span class="n">def_fric</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">integrator</span><span class="o">.</span><span class="n">getFriction</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">minimizeDrop</span><span class="p">():</span>
            <span class="n">drop</span> <span class="o">=</span> <span class="mf">10.</span>
            <span class="k">for</span> <span class="n">dummy</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">maxIterations</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">drop</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">drop</span> <span class="o">=</span> <span class="mf">1.</span>
                <span class="k">if</span> <span class="n">drop</span> <span class="o">&gt;</span> <span class="mi">10000</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&quot;Timestep too low. Perhaps, &quot;</span>\
                                       <span class="s">&quot;something is wrong!&quot;</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">integrator</span><span class="o">.</span><span class="n">setStepSize</span><span class="p">(</span><span class="n">def_step</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">drop</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">integrator</span><span class="o">.</span><span class="n">setFriction</span><span class="p">(</span><span class="n">def_fric</span> <span class="o">*</span> <span class="n">drop</span><span class="p">)</span>
                <span class="c"># self.reinitialize()</span>
                <span class="n">numAttempts</span> <span class="o">=</span> <span class="mi">5</span>
                <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">numAttempts</span><span class="p">):</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">doBlock</span><span class="p">(</span><span class="n">stepsPerIteration</span><span class="p">,</span> <span class="n">increment</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                        <span class="n">reinitialize</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                    <span class="c"># self.initVelocities()</span>
                    <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
                        <span class="n">drop</span> <span class="o">*=</span> <span class="mi">2</span>
                        <span class="k">print</span> <span class="s">&quot;Timestep decreased {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="n">drop</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">initVelocities</span><span class="p">()</span>
                        <span class="k">break</span>
                    <span class="k">if</span> <span class="n">attempt</span> <span class="o">==</span> <span class="n">numAttempts</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">drop</span> <span class="o">==</span> <span class="mf">1.</span><span class="p">:</span>
                            <span class="k">return</span> <span class="mi">0</span>
                        <span class="n">drop</span> <span class="o">/=</span> <span class="mi">2</span>
                        <span class="k">print</span> <span class="s">&quot;Timestep decreased by {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">drop</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">initVelocities</span><span class="p">()</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>

        <span class="k">if</span> <span class="n">failNotConverged</span> <span class="ow">and</span> <span class="p">(</span><span class="n">minimizeDrop</span><span class="p">()</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s">&quot;Reached maximum number of iterations and still not converged</span><span class="se">\n</span><span class="s">&quot;</span>\
                <span class="s">&quot;increase maxIterations or set failNotConverged=False&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">oldName</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">integrator</span><span class="o">.</span><span class="n">setFriction</span><span class="p">(</span><span class="n">def_fric</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">integrator</span><span class="o">.</span><span class="n">setStepSize</span><span class="p">(</span><span class="n">def_step</span><span class="p">)</span>
        <span class="c"># self.reinitialize()</span>
        <span class="k">print</span> <span class="s">&quot;Finished energy minimization&quot;</span>
</div>
<div class="viewcode-block" id="Simulation.doBlock"><a class="viewcode-back" href="../openmmlib.html#openmmlib.Simulation.doBlock">[docs]</a>    <span class="k">def</span> <span class="nf">doBlock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">increment</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">reinitialize</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;performs one block of simulations, doing steps timesteps,</span>
<span class="sd">        or steps_per_block if not specified.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        steps : int or None</span>
<span class="sd">            Number of timesteps to perform. If not specified, tries to</span>
<span class="sd">            infer it from self.steps_per_block</span>
<span class="sd">        increment : bool, optional</span>
<span class="sd">            If true, will not increment self.steps counter</span>
<span class="sd">        num : int or None, optional</span>
<span class="sd">            If specified, will split the block in num subblocks.</span>
<span class="sd">            Default value is 10.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">forcesApplied</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;applying forces&quot;</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_applyForces</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">forcesApplied</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="n">increment</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">steps</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">steps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps_per_block</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">increment</span> <span class="o">==</span> <span class="bp">True</span><span class="p">)</span> <span class="ow">and</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">%</span> <span class="mi">50</span><span class="p">)</span> <span class="o">==</span> <span class="mi">25</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">printStats</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
            <span class="k">print</span> <span class="s">&quot;bl=</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">),</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="k">print</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">num</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">num</span> <span class="o">=</span> <span class="n">steps</span> <span class="o">/</span> <span class="mi">5</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">steps</span> <span class="o">/</span> <span class="n">num</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s">&quot;performing integration&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">integrator</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>  <span class="c"># integrate!</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">steps</span> <span class="o">%</span> <span class="n">num</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">integrator</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">steps</span> <span class="o">%</span> <span class="n">num</span><span class="p">)</span>

            <span class="c"># get state of a system: positions, energies</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">getState</span><span class="p">(</span><span class="n">getPositions</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                               <span class="n">getEnergy</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

            <span class="n">b</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">getPositions</span><span class="p">(</span><span class="n">asNumpy</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">newcoords</span> <span class="o">=</span> <span class="n">coords</span> <span class="o">/</span> <span class="n">nm</span>
            <span class="c"># calculate energies in KT/particle</span>
            <span class="n">eK</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">getKineticEnergy</span><span class="p">()</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">kT</span><span class="p">)</span>
            <span class="n">eP</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">getPotentialEnergy</span><span class="p">()</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">kT</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">velocityReinitialize</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">eK</span> <span class="o">&gt;</span> <span class="mf">2.4</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s">&quot;(i)&quot;</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">initVelocities</span><span class="p">()</span>
            <span class="k">print</span> <span class="s">&quot;pos[1]=[</span><span class="si">%.1lf</span><span class="s"> </span><span class="si">%.1lf</span><span class="s"> </span><span class="si">%.1lf</span><span class="s">]&quot;</span> <span class="o">%</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">newcoords</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>

            <span class="k">if</span> <span class="p">((</span><span class="n">numpy</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">newcoords</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">())</span> <span class="ow">or</span> <span class="p">(</span><span class="n">eK</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">eKcritical</span><span class="p">)</span> <span class="ow">or</span>
                <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">eK</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">eP</span><span class="p">))):</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">setPositions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">initVelocities</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">reinitialize</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s">&quot;eK={0}, eP={1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">eK</span><span class="p">,</span> <span class="n">eP</span><span class="p">)</span>
                    <span class="k">return</span> <span class="bp">False</span>
                <span class="k">print</span> <span class="s">&quot;eK={0}, eP={1}, trying one more time at step {2} &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">eK</span><span class="p">,</span> <span class="n">eP</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dif</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">newcoords</span> <span class="o">-</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">getData</span><span class="p">())</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)))</span>
                <span class="k">print</span> <span class="s">&quot;dr=</span><span class="si">%.2lf</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dif</span><span class="p">,),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">coords</span>
                <span class="k">print</span> <span class="s">&quot;t=</span><span class="si">%2.1lf</span><span class="s">ps&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">getTime</span><span class="p">()</span> <span class="o">/</span> <span class="n">ps</span><span class="p">),</span>
                <span class="k">print</span> <span class="s">&quot;kin=</span><span class="si">%.2lf</span><span class="s"> pot=</span><span class="si">%.2lf</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">eK</span><span class="p">,</span>
                    <span class="n">eP</span><span class="p">),</span> <span class="s">&quot;Rg=</span><span class="si">%.3lf</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">RG</span><span class="p">(),</span>
                <span class="k">print</span> <span class="s">&quot;SPS=</span><span class="si">%.0lf</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">steps</span> <span class="o">/</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">b</span> <span class="o">-</span> <span class="n">a</span><span class="p">)))</span>
                <span class="k">break</span>

            <span class="k">if</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">localEnergyMinimization</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">attempt</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_exitProgram</span><span class="p">(</span><span class="s">&quot;exceeded number of attempts&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s">&quot;Ep&quot;</span><span class="p">:</span><span class="n">eP</span><span class="p">,</span> <span class="s">&quot;Ek&quot;</span><span class="p">:</span><span class="n">eK</span><span class="p">}</span>
</div>
<div class="viewcode-block" id="Simulation.printStats"><a class="viewcode-back" href="../openmmlib.html#openmmlib.Simulation.printStats">[docs]</a>    <span class="k">def</span> <span class="nf">printStats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Prints detailed statistics of a system.</span>
<span class="sd">        Will be run every 50 steps</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">getState</span><span class="p">(</span><span class="n">getPositions</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
            <span class="n">getVelocities</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">getEnergy</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="n">eP</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">getPotentialEnergy</span><span class="p">()</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">getPositions</span><span class="p">()</span> <span class="o">/</span> <span class="n">nm</span><span class="p">)</span>
        <span class="n">bonds</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">sbonds</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">bonds</span><span class="p">)</span>
        <span class="n">vel</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">getVelocities</span><span class="p">()</span>
        <span class="n">mass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">getParticleMass</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">vkT</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vel</span> <span class="o">/</span> <span class="n">units</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kT</span> <span class="o">/</span> <span class="n">mass</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">velocs</span> <span class="o">=</span> <span class="n">vkT</span>
        <span class="n">EkPerParticle</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">vkT</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">cm</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">centredPos</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">-</span> <span class="n">cm</span><span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">dists</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">centredPos</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">per95</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">dists</span><span class="p">,</span> <span class="mi">95</span><span class="p">)</span>
        <span class="n">den</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.95</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">)</span> <span class="o">/</span> <span class="p">((</span><span class="mf">4.</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">per95</span> <span class="o">**</span> <span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">per5</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">dists</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
        <span class="n">den5</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.05</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">)</span> <span class="o">/</span> <span class="p">((</span><span class="mf">4.</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">per5</span> <span class="o">**</span> <span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">pos</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">pos</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="n">minmedmax</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>

        <span class="k">print</span>
        <span class="k">print</span> <span class="s">&quot;Statistics for the simulation </span><span class="si">%s</span><span class="s">, number of particles: </span><span class="si">%d</span><span class="s">, &quot;</span>\
        <span class="s">&quot; number of chains: </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chains</span><span class="p">))</span>
        <span class="k">print</span>
        <span class="k">print</span> <span class="s">&quot;Statistics for particle position&quot;</span>
        <span class="k">print</span> <span class="s">&quot;     mean position is: &quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
            <span class="n">pos</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="s">&quot;  Rg = &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">RG</span><span class="p">()</span>
        <span class="k">print</span> <span class="s">&quot;     median bond size is &quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">bonds</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&quot;     three shortest/longest (&lt;10)/ bonds are &quot;</span><span class="p">,</span> <span class="n">sbonds</span><span class="p">[</span>
            <span class="p">:</span><span class="mi">3</span><span class="p">],</span> <span class="s">&quot;  &quot;</span><span class="p">,</span> <span class="n">sbonds</span><span class="p">[</span><span class="n">sbonds</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">][</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">sbonds</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;longest 10 bonds are&quot;</span><span class="p">,</span> <span class="n">sbonds</span><span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">:]</span>

        <span class="k">print</span> <span class="s">&quot;     95 percentile of distance to center is:   &quot;</span><span class="p">,</span> <span class="n">per95</span>
        <span class="k">print</span> <span class="s">&quot;     density of closest 95% monomers is:   &quot;</span><span class="p">,</span> <span class="n">den</span>
        <span class="k">print</span> <span class="s">&quot;     density of the core monomers is:   &quot;</span><span class="p">,</span> <span class="n">den5</span>
        <span class="k">print</span> <span class="s">&quot;     min/median/mean/max coordinates are: &quot;</span>
        <span class="k">print</span> <span class="s">&quot;     x: </span><span class="si">%.2lf</span><span class="s">, </span><span class="si">%.2lf</span><span class="s">, </span><span class="si">%.2lf</span><span class="s">, </span><span class="si">%.2lf</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">minmedmax</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&quot;     y: </span><span class="si">%.2lf</span><span class="s">, </span><span class="si">%.2lf</span><span class="s">, </span><span class="si">%.2lf</span><span class="s">, </span><span class="si">%.2lf</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">minmedmax</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&quot;     z: </span><span class="si">%.2lf</span><span class="s">, </span><span class="si">%.2lf</span><span class="s">, </span><span class="si">%.2lf</span><span class="s">, </span><span class="si">%.2lf</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">minmedmax</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
        <span class="k">print</span>
        <span class="k">print</span> <span class="s">&quot;Statistics for velocities:&quot;</span>
        <span class="k">print</span> <span class="s">&quot;     mean kinetic energy is: &quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
            <span class="n">EkPerParticle</span><span class="p">),</span> <span class="s">&quot;should be:&quot;</span><span class="p">,</span> <span class="mf">1.5</span>
        <span class="k">print</span> <span class="s">&quot;     fastest particles are (in kT): &quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span>
            <span class="n">EkPerParticle</span><span class="p">)[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span>

        <span class="k">print</span>
        <span class="k">print</span> <span class="s">&quot;Statistics for the system:&quot;</span>
        <span class="k">print</span> <span class="s">&quot;     Forces are: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">forceDict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">print</span> <span class="s">&quot;     Number of exceptions:  &quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bondsForException</span><span class="p">)</span>
        <span class="k">print</span>
        <span class="k">print</span> <span class="s">&quot;Potential Energy Ep = &quot;</span><span class="p">,</span> <span class="n">eP</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">kT</span>
</div>
<div class="viewcode-block" id="Simulation.show"><a class="viewcode-back" href="../openmmlib.html#openmmlib.Simulation.show">[docs]</a>    <span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shifts</span><span class="o">=</span><span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;shows system in rasmol by drawing spheres</span>
<span class="sd">        draws 4 spheres in between any two points (5 * N spheres total)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># if you want to change positions of the spheres along each segment,</span>
        <span class="c"># change these numbers: e.g. [0,.1, .2 ...  .9] will draw 10 spheres,</span>
        <span class="c"># and this will look better</span>

        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getData</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;wrong data!&quot;</span>
            <span class="k">return</span>
        <span class="c"># determining the 95 percentile distance between particles,</span>
        <span class="n">meandist</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)),</span> <span class="mi">95</span><span class="p">)</span>
        <span class="c"># rescaling the data, so that bonds are of the order of 1.</span>
        <span class="c"># This is because rasmol spheres are of the fixed diameter.</span>
        <span class="n">data</span> <span class="o">/=</span> <span class="n">meandist</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">:</span>  <span class="c"># system is sufficiently large</span>
            <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
                <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">dist</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="n">b</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">dist</span> <span class="o">&lt;</span> <span class="mf">1.3</span><span class="p">:</span>
                    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="s">&quot;Too many particles are close together. &quot;</span>\
                    <span class="s">&quot;This will cause rasmol to choke&quot;</span><span class="p">)</span>

        <span class="n">rascript</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">()</span>
        <span class="c"># writing the rasmol script. Spacefill controls radius of the sphere.</span>
        <span class="n">rascript</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&quot;&quot;wireframe off</span>
<span class="s">        color temperature</span>
<span class="s">        spacefill 100</span>
<span class="s">        background white</span>
<span class="s">        &quot;&quot;&quot;</span><span class="p">)</span>
        <span class="n">rascript</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="c"># creating the array, linearly chanhing from -225 to 225</span>
        <span class="c"># to serve as an array of colors</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">int</span><span class="p">((</span><span class="n">j</span> <span class="o">*</span> <span class="mf">450.</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)))</span> <span class="o">-</span>
            <span class="mi">225</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))])</span>

        <span class="c"># creating spheres along the trajectory</span>
        <span class="n">newData</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">shifts</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">shifts</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">4</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">shifts</span><span class="p">)):</span>
            <span class="n">newData</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">shifts</span><span class="p">),</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">shifts</span><span class="p">[</span>
                <span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">shifts</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">newData</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">shifts</span><span class="p">),</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">newData</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">newData</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">towrite</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">()</span>
        <span class="n">towrite</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%d</span><span class="se">\n\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">newData</span><span class="p">)))</span>
        <span class="c"># number of atoms and a blank line after is a requirement of rasmol</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">newData</span><span class="p">:</span>
            <span class="n">towrite</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;CA</span><span class="se">\t</span><span class="si">%lf</span><span class="se">\t</span><span class="si">%lf</span><span class="se">\t</span><span class="si">%lf</span><span class="se">\t</span><span class="si">%d</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
        <span class="n">towrite</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="s">&quot;TODO: rewrite using subprocess.popen&quot;</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s">&quot;posix&quot;</span><span class="p">:</span>  <span class="c"># if linux</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;rasmol -xyz </span><span class="si">%s</span><span class="s"> -script </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">towrite</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">rascript</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c"># if windows</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;C:/RasWin/raswin.exe -xyz </span><span class="si">%s</span><span class="s"> -script </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                                        <span class="n">towrite</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">rascript</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

        <span class="n">rascript</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">towrite</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

</div></div>
<div class="viewcode-block" id="SimulationWithCrosslinks"><a class="viewcode-back" href="../openmmlib.html#openmmlib.SimulationWithCrosslinks">[docs]</a><span class="k">class</span> <span class="nc">SimulationWithCrosslinks</span><span class="p">(</span><span class="n">Simulation</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A subclass used to do simulations for the Metaphase project</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">addConsecutiveRandomBonds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loopSize</span><span class="p">,</span> <span class="n">bondWiggle</span><span class="p">,</span> <span class="n">bondLength</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
                                  <span class="n">smeerLoopSize</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">distanceBetweenBonds</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                  <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">loopSize</span> <span class="o">*</span> <span class="n">smeerLoopSize</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">shift</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">shift</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">begin</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">distanceBetweenBonds</span><span class="p">)</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">b1</span> <span class="o">=</span> <span class="n">begin</span>
            <span class="n">b2</span> <span class="o">=</span> <span class="n">begin</span> <span class="o">+</span> <span class="n">loopSize</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">shift</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">b2</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">-</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">-</span> <span class="n">b1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">5</span> <span class="o">*</span> <span class="n">distanceBetweenBonds</span> <span class="o">+</span> <span class="mi">5</span><span class="p">):</span>
                    <span class="n">b2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">distanceBetweenBonds</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">break</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">addBond</span><span class="p">(</span><span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">,</span> <span class="n">bondWiggle</span><span class="p">,</span> <span class="n">bondLength</span><span class="p">,</span>
                         <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
            <span class="n">begin</span> <span class="o">=</span> <span class="n">b2</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">distanceBetweenBonds</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;bond added between </span><span class="si">%d</span><span class="s"> and </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">addDoubleRandomLengthBonds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bondlength</span><span class="p">,</span> <span class="n">bondRange</span><span class="p">,</span> <span class="n">distance</span><span class="p">):</span>
        <span class="n">begin</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="n">started</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">past</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">past</span>
            <span class="n">b1</span> <span class="o">=</span> <span class="n">begin</span>
            <span class="n">b2</span> <span class="o">=</span> <span class="n">begin</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span>
                <span class="mf">0.5</span> <span class="o">*</span> <span class="n">bondlength</span><span class="p">,</span> <span class="mf">1.7</span> <span class="o">*</span> <span class="n">bondlength</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">b2</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">-</span> <span class="mi">4</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addBond</span><span class="p">(</span><span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">,</span> <span class="n">bondRange</span><span class="p">,</span> <span class="n">distance</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;bond added between </span><span class="si">%d</span><span class="s"> and </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">started</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">addBond</span><span class="p">(</span><span class="n">past</span><span class="p">,</span> <span class="n">b2</span><span class="p">,</span> <span class="n">bondRange</span><span class="p">,</span> <span class="n">distance</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s">&quot;bond added between </span><span class="si">%d</span><span class="s"> and </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">past</span><span class="p">,</span> <span class="n">b2</span><span class="p">)</span>
                <span class="n">past</span> <span class="o">=</span> <span class="n">b1</span>
            <span class="n">started</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">begin</span> <span class="o">=</span> <span class="n">b2</span>

<div class="viewcode-block" id="SimulationWithCrosslinks.addAttractionToTheCore"><a class="viewcode-back" href="../openmmlib.html#openmmlib.SimulationWithCrosslinks.addAttractionToTheCore">[docs]</a>    <span class="k">def</span> <span class="nf">addAttractionToTheCore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="n">coreParticles</span><span class="o">=</span><span class="p">[]):</span>

        <span class="sd">&quot;&quot;&quot;Attracts a subset of particles to the core,</span>
<span class="sd">         repells the rest from the core&quot;&quot;&quot;</span>

        <span class="n">attractForce</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">CustomExternalForce</span><span class="p">(</span>
            <span class="s">&quot; COREk * ((COREr - CORErn) ^ 2)  ; &quot;</span>\
            <span class="s">&quot;COREr = sqrt(x^2 + y^2 + COREtt^2)&quot;</span><span class="p">)</span>
        <span class="n">attractForce</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span>
            <span class="s">&quot;COREk&quot;</span><span class="p">,</span> <span class="n">k</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">kT</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conlen</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">conlen</span><span class="p">))</span>
        <span class="n">attractForce</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&quot;CORErn&quot;</span><span class="p">,</span> <span class="n">r0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">conlen</span><span class="p">)</span>
        <span class="n">attractForce</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&quot;COREtt&quot;</span><span class="p">,</span> <span class="mf">0.001</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">conlen</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forceDict</span><span class="p">[</span><span class="s">&quot;CoreAttraction&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">attractForce</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">coreParticles</span><span class="p">:</span>
            <span class="n">attractForce</span><span class="o">.</span><span class="n">addParticle</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="p">[])</span>

        <span class="k">if</span> <span class="n">r0</span> <span class="o">&gt;</span> <span class="mf">0.1</span><span class="p">:</span>

            <span class="n">excludeForce</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">CustomExternalForce</span><span class="p">(</span>
                <span class="s">&quot; CORE2k * ((CORE2r - CORE2rn) ^ 2) * step(CORE2rn - CORE2r) ;&quot;</span>
                <span class="s">&quot;CORE2r = sqrt(x^2 + y^2 + CORE2tt^2)&quot;</span><span class="p">)</span>
            <span class="n">excludeForce</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&quot;CORE2k&quot;</span><span class="p">,</span> <span class="n">k</span> <span class="o">*</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">kT</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conlen</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">conlen</span><span class="p">))</span>
            <span class="n">excludeForce</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&quot;CORE2rn&quot;</span><span class="p">,</span> <span class="n">r0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">conlen</span><span class="p">)</span>
            <span class="n">excludeForce</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&quot;CORE2tt&quot;</span><span class="p">,</span> <span class="mf">0.001</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">conlen</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">forceDict</span><span class="p">[</span><span class="s">&quot;CoreExclusion&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">excludeForce</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">):</span>
                <span class="n">excludeForce</span><span class="o">.</span><span class="n">addParticle</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">[])</span>
</div>
<div class="viewcode-block" id="SimulationWithCrosslinks.fixParticlesZCoordinate"><a class="viewcode-back" href="../openmmlib.html#openmmlib.SimulationWithCrosslinks.fixParticlesZCoordinate">[docs]</a>    <span class="k">def</span> <span class="nf">fixParticlesZCoordinate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">particles</span><span class="p">,</span> <span class="n">zCoordinates</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
                                <span class="n">useOtherAxis</span><span class="o">=</span><span class="s">&quot;z&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&quot;abs&quot;</span><span class="p">,</span> <span class="n">gap</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Limits position of a set of particles in z coordinate</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        particles : list</span>
<span class="sd">            List of particles to be fixed.</span>
<span class="sd">        zCoordinates : list, or tuple of length 2</span>
<span class="sd">            If has length of particles, then should contain all Z coordinates</span>
<span class="sd">            If has length 2, then contains z coordinates of first and</span>
<span class="sd">            Nth particles, and the rest is approximated linearly.</span>
<span class="sd">        k : float, optional</span>
<span class="sd">            Strength of attraction, measured in kT/(bondlength)</span>
<span class="sd">        useOtherAxis : &quot;x&quot;,&quot;y&quot; or &quot;z&quot;, optional</span>
<span class="sd">            Apply the same in the other dimension</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">particles</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">zCoordinates</span><span class="p">):</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">zCoordinates</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
            <span class="n">start</span><span class="p">,</span> <span class="n">stop</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">zCoordinates</span><span class="p">)</span>
            <span class="n">zCoordinates</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">par</span> <span class="ow">in</span> <span class="n">particles</span><span class="p">:</span>
                <span class="n">zCoordinates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span>
                    <span class="n">stop</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">par</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">)))</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="s">&quot;abs&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">gap</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">):</span>
            <span class="n">zFixForce</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">CustomExternalForce</span><span class="p">(</span>
            <span class="s">&quot;ZFIXk * (sqrt((</span><span class="si">%s</span><span class="s"> - ZFIXr0)^2 + ZFIXa^2) - ZFIXa)&quot;</span> <span class="o">%</span> <span class="p">(</span>
                                                           <span class="n">useOtherAxis</span><span class="p">,))</span>
            <span class="n">zFixForce</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&quot;ZFIXk&quot;</span><span class="p">,</span> <span class="n">k</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">kT</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conlen</span><span class="p">))</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="s">&quot;abs&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">gap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">):</span>
            <span class="n">zFixForce</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">CustomExternalForce</span><span class="p">(</span>
            <span class="s">&quot;ZFIXk * step(</span><span class="si">%s</span><span class="s"> - ZFIXr0 - ZFIXgap * 0.5) *&quot;</span>\
            <span class="s">&quot; (sqrt((</span><span class="si">%s</span><span class="s"> - ZFIXr0 - ZFIXgap * 0.5)^2 + ZFIXa^2) - ZFIXa) + &quot;</span>\
            <span class="s">&quot;ZFIXk * step(-</span><span class="si">%s</span><span class="s"> + ZFIXr0 - ZFIXgap * 0.5) * &quot;</span>\
            <span class="s">&quot;(sqrt((-</span><span class="si">%s</span><span class="s"> + ZFIXr0 - ZFIXgap * 0.5)^2 + ZFIXa^2) - ZFIXa)&quot;</span>\
            <span class="o">%</span> <span class="p">(</span><span class="n">useOtherAxis</span><span class="p">,</span> <span class="n">useOtherAxis</span><span class="p">,</span> <span class="n">useOtherAxis</span><span class="p">,</span> <span class="n">useOtherAxis</span><span class="p">))</span>

            <span class="n">zFixForce</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&quot;ZFIXk&quot;</span><span class="p">,</span> <span class="n">k</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">kT</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conlen</span><span class="p">))</span>
            <span class="n">zFixForce</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&quot;ZFIXgap&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">conlen</span> <span class="o">*</span> <span class="n">gap</span><span class="p">)</span>

        <span class="k">elif</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="s">&quot;quadratic&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">gap</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">):</span>
            <span class="n">zFixForce</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">CustomExternalForce</span><span class="p">(</span>
                <span class="s">&quot;ZFIXk * ((</span><span class="si">%s</span><span class="s"> - ZFIXr0)^2)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">useOtherAxis</span><span class="p">,))</span>
            <span class="n">zFixForce</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&quot;ZFIXk&quot;</span><span class="p">,</span> <span class="n">k</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">kT</span> <span class="o">/</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conlen</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">conlen</span><span class="p">))</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="s">&quot;quadratic&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">gap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">):</span>
            <span class="n">zFixForce</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">CustomExternalForce</span><span class="p">(</span>
            <span class="s">&quot;ZFIXk * (step(</span><span class="si">%s</span><span class="s"> - ZFIXr0 - ZFIXgap * 0.5) * &quot;</span>\
            <span class="s">&quot;(</span><span class="si">%s</span><span class="s"> - ZFIXr0 - ZFIXgap * 0.5)^2 +  &quot;</span>\
            <span class="s">&quot;step(-</span><span class="si">%s</span><span class="s"> + ZFIXr0 - ZFIXgap * 0.5) * &quot;</span>\
            <span class="s">&quot;(-</span><span class="si">%s</span><span class="s"> + ZFIXr0 - ZFIXgap * 0.5)^2)&quot;</span> \
            <span class="o">%</span> <span class="p">(</span><span class="n">useOtherAxis</span><span class="p">,</span> <span class="n">useOtherAxis</span><span class="p">,</span> <span class="n">useOtherAxis</span><span class="p">,</span> <span class="n">useOtherAxis</span><span class="p">))</span>

            <span class="n">zFixForce</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&quot;ZFIXk&quot;</span><span class="p">,</span> <span class="n">k</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">kT</span> <span class="o">/</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conlen</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">conlen</span><span class="p">))</span>
            <span class="n">zFixForce</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&quot;ZFIXgap&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">conlen</span> <span class="o">*</span> <span class="n">gap</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&quot;Not implemented&quot;</span><span class="p">)</span>

        <span class="n">zFixForce</span><span class="o">.</span><span class="n">addPerParticleParameter</span><span class="p">(</span><span class="s">&quot;ZFIXr0&quot;</span><span class="p">)</span>

        <span class="n">zFixForce</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&quot;ZFIXa&quot;</span><span class="p">,</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">conlen</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">par</span><span class="p">,</span> <span class="n">zcoor</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">particles</span><span class="p">,</span> <span class="n">zCoordinates</span><span class="p">):</span>
            <span class="n">zFixForce</span><span class="o">.</span><span class="n">addParticle</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">par</span><span class="p">),</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">zcoor</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forceDict</span><span class="p">[</span><span class="s">&quot;fixZCoordinates&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">zFixForce</span>

</div></div>
<div class="viewcode-block" id="ExperimentalSimulation"><a class="viewcode-back" href="../openmmlib.html#openmmlib.ExperimentalSimulation">[docs]</a><span class="k">class</span> <span class="nc">ExperimentalSimulation</span><span class="p">(</span><span class="n">Simulation</span><span class="p">):</span>
    <span class="s">&quot;contains some experimental features&quot;</span>

<div class="viewcode-block" id="ExperimentalSimulation.quickLoad"><a class="viewcode-back" href="../openmmlib.html#openmmlib.ExperimentalSimulation.quickLoad">[docs]</a>    <span class="k">def</span> <span class="nf">quickLoad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&quot;chain&quot;</span><span class="p">,</span> <span class="n">Nchains</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                  <span class="n">trunc</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">confinementDensity</span><span class="o">=</span><span class="s">&quot;NoConfinement&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;quickly loads a set of repulsive chains,</span>
<span class="sd">        possibly adds spherical confinement&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setLayout</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">Nchains</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addHarmonicPolymerBonds</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addSimpleRepulsiveForce</span><span class="p">(</span><span class="n">trunc</span><span class="o">=</span><span class="n">trunc</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">confinementDensity</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addSphericalConfinement</span><span class="p">(</span><span class="n">density</span><span class="o">=</span><span class="n">confinementDensity</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ExperimentalSimulation.createWalls"><a class="viewcode-back" href="../openmmlib.html#openmmlib.ExperimentalSimulation.createWalls">[docs]</a>    <span class="k">def</span> <span class="nf">createWalls</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
        <span class="s">&quot;creates walls at x = left, x = right, x direction only&quot;</span>
        <span class="k">if</span> <span class="n">left</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1.</span> <span class="o">*</span> <span class="n">nm</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">left</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">*</span> <span class="n">nm</span> <span class="o">*</span> <span class="n">left</span>
        <span class="k">if</span> <span class="n">right</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1.</span> <span class="o">*</span> <span class="n">nm</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">right</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">*</span> <span class="n">nm</span> <span class="o">*</span> <span class="n">right</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;left wall created at &quot;</span><span class="p">,</span> <span class="n">left</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">*</span> <span class="n">nm</span><span class="p">)</span>
            <span class="k">print</span> <span class="s">&quot;right wall created at &quot;</span><span class="p">,</span> <span class="n">right</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">*</span> <span class="n">nm</span><span class="p">)</span>

        <span class="n">extforce2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">CustomExternalForce</span><span class="p">(</span>
            <span class="s">&quot; WALLk * (sqrt((x - WALLright) * (x-WALLright) + WALLa * WALLa ) - WALLa) * step(x-WALLright) &quot;</span>
            <span class="s">&quot;+ WALLk * (sqrt((x - WALLleft) * (x-WALLleft) + WALLa * WALLa ) - WALLa) * step(WALLleft - x) &quot;</span><span class="p">)</span>
        <span class="n">extforce2</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&quot;WALLk&quot;</span><span class="p">,</span> <span class="n">k</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">kT</span> <span class="o">/</span> <span class="n">nm</span><span class="p">)</span>
        <span class="n">extforce2</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&quot;WALLleft&quot;</span><span class="p">,</span> <span class="n">left</span><span class="p">)</span>
        <span class="n">extforce2</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&quot;WALLright&quot;</span><span class="p">,</span> <span class="n">right</span><span class="p">)</span>
        <span class="n">extforce2</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&quot;WALLa&quot;</span><span class="p">,</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">nm</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">):</span>
            <span class="n">extforce2</span><span class="o">.</span><span class="n">addParticle</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forceDict</span><span class="p">[</span><span class="s">&quot;WALL Force&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">extforce2</span>
</div>
<div class="viewcode-block" id="ExperimentalSimulation.addSphericalWell"><a class="viewcode-back" href="../openmmlib.html#openmmlib.ExperimentalSimulation.addSphericalWell">[docs]</a>    <span class="k">def</span> <span class="nf">addSphericalWell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;pushes particles towards a boundary</span>
<span class="sd">        of a cylindrical well to create uniform well coverage&quot;&quot;&quot;</span>

        <span class="n">extforce4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">CustomExternalForce</span><span class="p">(</span>
            <span class="s">&quot;WELLdepth * (((sin((WELLr * 3.141592 * 0.5) / WELLwidth)) ^ 10)  -1) * step(-WELLr + WELLwidth);&quot;</span>
            <span class="s">&quot;WELLr = sqrt(x^2 + y^2 + z^2 + WELLtt^2)&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forceDict</span><span class="p">[</span><span class="s">&quot;Well attraction&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">extforce4</span>

        <span class="c"># adding all the particles on which force acts</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">domains</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>
                <span class="n">extforce4</span><span class="o">.</span><span class="n">addParticle</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">if</span> <span class="n">r</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sphericalConfinementRadius</span> <span class="o">*</span> <span class="mf">0.5</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">exit</span><span class="p">(</span><span class="s">&quot;No spherical confinement radius defined yet.&quot;</span>\
                     <span class="s">&quot; Apply spherical confinement first!&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;Well attraction added with r = </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">r</span>

        <span class="c"># assigning parameters of the force</span>
        <span class="n">extforce4</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&quot;WELLwidth&quot;</span><span class="p">,</span> <span class="n">r</span> <span class="o">*</span> <span class="n">nm</span><span class="p">)</span>
        <span class="n">extforce4</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&quot;WELLdepth&quot;</span><span class="p">,</span> <span class="n">depth</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">kT</span><span class="p">)</span>
        <span class="n">extforce4</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&quot;WELLtt&quot;</span><span class="p">,</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="n">nm</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="YeastSimulation"><a class="viewcode-back" href="../openmmlib.html#openmmlib.YeastSimulation">[docs]</a><span class="k">class</span> <span class="nc">YeastSimulation</span><span class="p">(</span><span class="n">Simulation</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class is maintained by Geoff to do simulations for the Yeast project</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="YeastSimulation.addNucleolus"><a class="viewcode-back" href="../openmmlib.html#openmmlib.YeastSimulation.addNucleolus">[docs]</a>    <span class="k">def</span> <span class="nf">addNucleolus</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="s">&quot;method&quot;</span>
        <span class="k">if</span> <span class="n">r</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sphericalConfinementRadius</span>

        <span class="n">extforce3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">CustomExternalForce</span><span class="p">(</span>
            <span class="s">&quot;step(r-NUCaa) * NUCkb * (sqrt((r-NUCaa)*(r-NUCaa) + NUCt*NUCt) - NUCt);&quot;</span>
            <span class="s">&quot;r = sqrt(x^2 + y^2 + (z + NUCoffset )^2 + NUCtt^2)&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">forceDict</span><span class="p">[</span><span class="s">&quot;NucleolusConfinement&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">extforce3</span>
        <span class="c"># adding all the particles on which force acts</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;NUCleolus confinement from radius = </span><span class="si">%lf</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">r</span>
        <span class="c"># assigning parameters of the force</span>
        <span class="n">extforce3</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&quot;NUCkb&quot;</span><span class="p">,</span> <span class="n">k</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">kT</span> <span class="o">/</span> <span class="n">nm</span><span class="p">)</span>
        <span class="n">extforce3</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&quot;NUCaa&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="n">nm</span> <span class="o">*</span> <span class="mf">1.75</span><span class="p">)</span>
        <span class="n">extforce3</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&quot;NUCoffset&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="n">nm</span> <span class="o">*</span> <span class="mf">1.1</span><span class="p">)</span>
        <span class="n">extforce3</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&quot;NUCt&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="n">nm</span> <span class="o">/</span> <span class="mf">10.</span><span class="p">)</span>
        <span class="n">extforce3</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&quot;NUCtt&quot;</span><span class="p">,</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="n">nm</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">):</span>
            <span class="n">extforce3</span><span class="o">.</span><span class="n">addParticle</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">[])</span>
</div>
    <span class="k">def</span> <span class="nf">addLaminaAttraction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">particles</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">extforce3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mm</span><span class="o">.</span><span class="n">CustomExternalForce</span><span class="p">(</span>
            <span class="s">&quot;-1 * step(LAMr-LAMaa + LAMwidth) * step(LAMaa + LAMwidth - LAMr) * LAMdepth&quot;</span>
            <span class="s">&quot;* abs( (LAMr-LAMaa + LAMwidth) * (LAMaa + LAMwidth - LAMr)) / (LAMwidth * LAMwidth);&quot;</span>
            <span class="s">&quot;LAMr = sqrt(x^2 + y^2 + z^2 + LAMtt^2)&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forceDict</span><span class="p">[</span><span class="s">&quot;Lamina attraction&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">extforce3</span>

        <span class="c"># re-defines lamina attraction based on particle index instead of domains.</span>

        <span class="c"># adding all the particles on which force acts</span>
        <span class="k">if</span> <span class="n">particles</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">):</span>
                <span class="n">extforce3</span><span class="o">.</span><span class="n">addParticle</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">[])</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s">&quot;particle </span><span class="si">%d</span><span class="s"> laminated! &quot;</span> <span class="o">%</span> <span class="n">i</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">particles</span><span class="p">:</span>
                <span class="n">extforce3</span><span class="o">.</span><span class="n">addParticle</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">[])</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s">&quot;particle </span><span class="si">%d</span><span class="s"> laminated! &quot;</span> <span class="o">%</span> <span class="n">i</span>

        <span class="k">if</span> <span class="n">r</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sphericalConfinementRadius</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">exit</span><span class="p">(</span><span class="s">&quot;No spherical confinement radius defined yet.&quot;</span>\
                     <span class="s">&quot;Apply spherical confinement first!&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;Lamina attraction added with r = </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">r</span>

        <span class="c"># assigning parameters of the force</span>
        <span class="n">extforce3</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&quot;LAMaa&quot;</span><span class="p">,</span> <span class="n">r</span> <span class="o">*</span> <span class="n">nm</span><span class="p">)</span>
        <span class="n">extforce3</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&quot;LAMwidth&quot;</span><span class="p">,</span> <span class="n">width</span> <span class="o">*</span> <span class="n">nm</span><span class="p">)</span>
        <span class="n">extforce3</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&quot;LAMdepth&quot;</span><span class="p">,</span> <span class="n">depth</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">kT</span><span class="p">)</span>
        <span class="n">extforce3</span><span class="o">.</span><span class="n">addGlobalParameter</span><span class="p">(</span><span class="s">&quot;LAMtt&quot;</span><span class="p">,</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="n">nm</span><span class="p">)</span>

</div>
<span class="k">class</span> <span class="nc">GrandeSimulation</span><span class="p">(</span><span class="n">Simulation</span><span class="p">,</span>
                       <span class="n">SimulationWithCrosslinks</span><span class="p">,</span>
                       <span class="n">ExperimentalSimulation</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../np-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">Wrapper for Openmm to perform polymer simulations and chromatin modelling 0.4 documentation</a> &raquo;</li>
          <li><a href="index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, Maxim Imakaev, Anton Goloborodko, Geoffrey Fudenberg, Leonid Mirny.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.3.
    </div>
  </body>
</html>