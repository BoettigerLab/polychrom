<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>polymerutils &mdash; Wrapper for Openmm to perform polymer simulations and chromatin modelling 0.4 documentation</title>
    
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.4',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="Wrapper for Openmm to perform polymer simulations and chromatin modelling 0.4 documentation" href="../index.html" />
    <link rel="up" title="Module code" href="index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../np-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">Wrapper for Openmm to perform polymer simulations and chromatin modelling 0.4 documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for polymerutils</h1><div class="highlight"><pre>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">joblib</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">sqrt</span><span class="p">,</span> <span class="n">sin</span><span class="p">,</span> <span class="n">cos</span>
<span class="kn">import</span> <span class="nn">numpy</span>

<span class="kn">import</span> <span class="nn">scipy</span><span class="o">,</span> <span class="nn">scipy.stats</span>

<div class="viewcode-block" id="Cload"><a class="viewcode-back" href="../polymerutils.html#polymerutils.Cload">[docs]</a><span class="k">def</span> <span class="nf">Cload</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;fast polymer loader using weave.inline</span>

<span class="sd">    ..warning:: About to be deprecated</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">N</span><span class="p">),</span> <span class="n">order</span><span class="o">=</span><span class="s">&quot;C&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
    <span class="n">code</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">    #line 85 &quot;binary_search.py&quot;</span>
<span class="s">    using namespace std;</span>
<span class="s">    FILE *in;</span>
<span class="s">    const char * myfile = filename.c_str();</span>
<span class="s">    in = fopen(myfile,&quot;r&quot;);</span>
<span class="s">    int dummy;</span>
<span class="s">    dummy = fscanf(in,&quot;</span><span class="si">%d</span><span class="s">&quot;,&amp;dummy);</span>
<span class="s">    for (int i = 0; i &lt; N; i++)</span>
<span class="s">    {</span>
<span class="s">    dummy = fscanf(in,&quot;</span><span class="si">%lf</span><span class="s"> </span><span class="si">%lf</span><span class="s"> </span><span class="si">%lf</span><span class="s"> &quot;,&amp;ret[i],&amp;ret[i + N],&amp;ret[i + 2 * N]);</span>
<span class="s">    if (dummy &lt; 3){printf(&quot;Error in the file!!!&quot;);throw -1;}</span>
<span class="s">    }</span>
<span class="s">    &quot;&quot;&quot;</span>
    <span class="n">support</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">    #include &lt;math.h&gt;</span>
<span class="s">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">weave</span>
    <span class="n">weave</span><span class="o">.</span><span class="n">inline</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;filename&#39;</span><span class="p">,</span> <span class="s">&#39;N&#39;</span><span class="p">,</span> <span class="s">&#39;ret&#39;</span><span class="p">],</span> <span class="n">extra_compile_args</span><span class="o">=</span><span class="p">[</span>
        <span class="s">&#39;-march=native -malign-double&#39;</span><span class="p">],</span> <span class="n">support_code</span><span class="o">=</span><span class="n">support</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">center</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">ret</span> <span class="o">-=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[:,</span> <span class="bp">None</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">ret</span><span class="o">.</span><span class="n">T</span>

</div>
<div class="viewcode-block" id="load"><a class="viewcode-back" href="../polymerutils.html#polymerutils.load">[docs]</a><span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">h5dictKey</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Universal load function for any type of data file&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s">&quot;File not found :( </span><span class="se">\n</span><span class="s"> </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="s">&quot;checking for a text file&quot;</span>
        <span class="n">line0</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">N</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line0</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;Cannot read text file... reading pickle file&quot;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">Cload</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">!=</span> <span class="n">N</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;N does not correspond to the number of lines!&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="s">&quot;loading from a joblib file here&quot;</span>
        <span class="n">mydict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">joblib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">mydict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;data&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="s">&quot;checking for h5dict file &quot;</span>
        <span class="kn">from</span> <span class="nn">mirnylib.h5dict</span> <span class="kn">import</span> <span class="n">h5dict</span>
        <span class="n">mydict</span> <span class="o">=</span> <span class="n">h5dict</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;r&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">h5dictKey</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="n">mydict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;H5Dict has more than one key. Please specify the key.&quot;</span><span class="p">)</span>
            <span class="n">h5dictKey</span> <span class="o">=</span> <span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">h5dictKey</span> <span class="ow">in</span> <span class="n">mydict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">mydict</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">h5dictKey</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">data</span>
    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s">&quot;Failed to open file&quot;</span><span class="p">)</span>

</div>
<span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&quot;txt&quot;</span><span class="p">,</span> <span class="n">h5dictKey</span><span class="o">=</span><span class="s">&quot;1&quot;</span><span class="p">,</span> <span class="n">pdbGroups</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

    <span class="n">h5dictKey</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">h5dictKey</span><span class="p">)</span>
    <span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s">&quot;h5dict&quot;</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">mirnylib.h5dict</span> <span class="kn">import</span> <span class="n">h5dict</span>
        <span class="n">mydict</span> <span class="o">=</span> <span class="n">h5dict</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&quot;w&quot;</span><span class="p">)</span>
        <span class="n">mydict</span><span class="p">[</span><span class="n">h5dictKey</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
        <span class="k">del</span> <span class="n">mydict</span>
        <span class="k">return</span>

    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s">&quot;joblib&quot;</span><span class="p">:</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s">&quot;data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
        <span class="n">joblib</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">compress</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s">&quot;txt&quot;</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">particle</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;{0} {1} {2}</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">particle</span><span class="p">))</span>


        <span class="k">if</span> <span class="n">filename</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">lines</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">myfile</span><span class="p">:</span>
                <span class="n">myfile</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&quot;writelines&quot;</span><span class="p">):</span>
            <span class="n">filename</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">lines</span>



    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s">&#39;pdb&#39;</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-</span> <span class="mi">100</span><span class="p">)[</span><span class="bp">None</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">retret</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">n</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">st</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">st</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">pdbGroups</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">pdbGroups</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;A&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pdbGroups</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">pdbGroups</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)),</span> <span class="n">data</span><span class="p">,</span> <span class="n">pdbGroups</span><span class="p">):</span>
            <span class="n">atomNum</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">90000</span>
            <span class="n">segmentNum</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">90000</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">line</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">line</span><span class="p">]</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="s">&quot;ATOM&quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="n">ret</span> <span class="o">+</span> <span class="s">&quot;</span><span class="si">%i</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">atomNum</span><span class="p">),</span> <span class="mi">13</span><span class="p">)</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="n">ret</span> <span class="o">+</span> <span class="s">&quot;CA&quot;</span><span class="p">,</span> <span class="mi">17</span><span class="p">)</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="n">ret</span> <span class="o">+</span> <span class="s">&quot;ALA&quot;</span><span class="p">,</span> <span class="mi">21</span><span class="p">)</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="n">ret</span> <span class="o">+</span> <span class="n">group</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">22</span><span class="p">)</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="n">ret</span> <span class="o">+</span> <span class="s">&quot;</span><span class="si">%i</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">atomNum</span><span class="p">),</span> <span class="mi">30</span><span class="p">)</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="n">ret</span> <span class="o">+</span> <span class="p">(</span><span class="s">&quot;</span><span class="si">%8.3f</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="mi">37</span><span class="p">)</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="n">ret</span> <span class="o">+</span> <span class="p">(</span><span class="s">&quot;</span><span class="si">%8.3f</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="mi">45</span><span class="p">)</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="n">ret</span> <span class="o">+</span> <span class="p">(</span><span class="s">&quot;</span><span class="si">%8.3f</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="mi">53</span><span class="p">)</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="n">ret</span> <span class="o">+</span> <span class="p">(</span><span class="s">&quot; 1.00&quot;</span><span class="p">),</span> <span class="mi">61</span><span class="p">)</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="n">ret</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">8</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)),</span> <span class="mi">67</span><span class="p">)</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="mi">73</span><span class="p">)</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="n">ret</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">segmentNum</span><span class="p">),</span> <span class="mi">77</span><span class="p">)</span>
            <span class="n">retret</span> <span class="o">+=</span> <span class="p">(</span><span class="n">ret</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>

        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">retret</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Unknown mode : </span><span class="si">%s</span><span class="s">, use h5dict, joblib, txt or pdb&quot;</span> <span class="o">%</span> <span class="n">mode</span><span class="p">)</span>

<div class="viewcode-block" id="rotation_matrix"><a class="viewcode-back" href="../polymerutils.html#polymerutils.rotation_matrix">[docs]</a><span class="k">def</span> <span class="nf">rotation_matrix</span><span class="p">(</span><span class="n">rotate</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculates rotation matrix based on three rotation angles&quot;&quot;&quot;</span>
    <span class="n">tx</span><span class="p">,</span> <span class="n">ty</span><span class="p">,</span> <span class="n">tz</span> <span class="o">=</span> <span class="n">rotate</span>
    <span class="n">Rx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">tx</span><span class="p">),</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">tx</span><span class="p">)],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">tx</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">tx</span><span class="p">)]])</span>
    <span class="n">Ry</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">ty</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">ty</span><span class="p">)],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">ty</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">ty</span><span class="p">)]])</span>
    <span class="n">Rz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">tz</span><span class="p">),</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">tz</span><span class="p">),</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">tz</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">tz</span><span class="p">),</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Rx</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ry</span><span class="p">,</span> <span class="n">Rz</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="msd"><a class="viewcode-back" href="../polymerutils.html#polymerutils.msd">[docs]</a><span class="k">def</span> <span class="nf">msd</span><span class="p">(</span><span class="n">data1</span><span class="p">,</span> <span class="n">data2</span><span class="p">,</span> <span class="n">rotate</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mi">999999</span><span class="p">,</span> <span class="n">fullReturn</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An utility to calculate mean square displacement between two polymer conformations</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    data1, dat2 : Mx3 array</span>
<span class="sd">        First conformation</span>
<span class="sd">    rotate : bool (true by default)</span>
<span class="sd">        Compensate for rotation and displacement between conformation</span>
<span class="sd">    N : int (optional)</span>
<span class="sd">        If conformations are large, use only M monomers for comparison.</span>
<span class="sd">        If N &gt; M (num. of particles), use all monomers (default)</span>
<span class="sd">    fullReturn : bool, default=False</span>
<span class="sd">        Return information about all displacements</span>

<span class="sd">    returns</span>
<span class="sd">    -------</span>

<span class="sd">    MSD : float</span>
<span class="sd">        Diplacement between conformation</span>
<span class="sd">    if fullReturn==False: dictionary of results</span>
<span class="sd">        See the end of the code for reference</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">scipy.optimize</span>

    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;Please use polymerCython.fastMSD; this function will be deprecated&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">distN</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="n">N</span><span class="p">):</span>

        <span class="n">num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">/</span> <span class="n">N</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">newa</span> <span class="o">=</span> <span class="n">a</span><span class="p">[::</span><span class="n">num</span><span class="p">]</span>
        <span class="n">newb</span> <span class="o">=</span> <span class="n">b</span><span class="p">[::</span><span class="n">num</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">newa</span> <span class="o">-</span> <span class="n">newb</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">distance</span><span class="p">(</span><span class="n">rotate_shift</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="n">N</span><span class="p">):</span>
    <span class="c">#    print rotate</span>
        <span class="n">rotate</span> <span class="o">=</span> <span class="n">rotate_shift</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="n">rotate_shift</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span>
        <span class="n">rotated</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">data2</span><span class="p">,</span> <span class="n">rotation_matrix</span><span class="p">(</span><span class="n">rotate</span><span class="p">))</span>
        <span class="n">shifted</span> <span class="o">=</span> <span class="n">rotated</span> <span class="o">+</span> <span class="n">shift</span><span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="p">:]</span>
        <span class="k">return</span> <span class="n">distN</span><span class="p">(</span><span class="n">data1</span><span class="p">,</span> <span class="n">shifted</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="n">N</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">rotate</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">distN</span><span class="p">(</span><span class="n">data1</span><span class="p">,</span> <span class="n">data2</span><span class="p">,</span> <span class="mi">999999</span><span class="p">)</span>

    <span class="n">optimal</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">fmin</span><span class="p">(</span><span class="n">distance</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">xtol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span> <span class="n">ftol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">)</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data1</span><span class="p">))</span>
    <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="n">mydist</span> <span class="o">=</span> <span class="n">distance</span><span class="p">(</span><span class="n">optimal</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mi">999999</span><span class="p">)</span>
    <span class="n">shuffled</span> <span class="o">=</span> <span class="n">distN</span><span class="p">(</span><span class="n">data1</span><span class="p">,</span> <span class="n">data1</span><span class="p">[</span><span class="n">r</span><span class="p">],</span> <span class="n">N</span><span class="o">=</span><span class="mi">999999</span><span class="p">)</span>
    <span class="n">original</span> <span class="o">=</span> <span class="n">distN</span><span class="p">(</span><span class="n">data1</span><span class="p">,</span> <span class="n">data2</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mi">999999</span><span class="p">)</span>
    <span class="k">print</span> <span class="s">&quot;shuffled distance = &quot;</span><span class="p">,</span> <span class="n">shuffled</span>
    <span class="k">print</span> <span class="s">&quot;original distance =&quot;</span><span class="p">,</span> <span class="n">original</span>
    <span class="k">print</span> <span class="s">&quot;optimized distance= &quot;</span><span class="p">,</span> <span class="n">mydist</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">fullReturn</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">mydist</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s">&quot;optimized&quot;</span><span class="p">:</span><span class="n">mydist</span><span class="p">,</span> <span class="s">&quot;original&quot;</span><span class="p">:</span><span class="n">original</span><span class="p">,</span>
                <span class="s">&quot;shuffled&quot;</span><span class="p">:</span><span class="n">shuffled</span><span class="p">,</span> <span class="s">&quot;angle&quot;</span><span class="p">:</span><span class="n">optimal</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span>
                <span class="s">&quot;shift&quot;</span><span class="p">:</span><span class="n">optimal</span><span class="p">[</span><span class="mi">3</span><span class="p">:]}</span>

</div>
<span class="k">def</span> <span class="nf">bondLengths</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">bonds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">bonds</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">persistenceLength</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">bonds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">lens</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">bonds</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">bondCosines</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">bonds</span><span class="p">,</span> <span class="n">bonds</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">/</span> <span class="n">lens</span><span class="p">[:,</span> <span class="bp">None</span><span class="p">]</span> <span class="o">/</span> <span class="n">lens</span><span class="p">[:,</span> <span class="bp">None</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
    <span class="n">avgCosines</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">bondCosines</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">lens</span><span class="o">.</span><span class="n">size</span><span class="p">)])</span>
    <span class="n">truncCosines</span> <span class="o">=</span> <span class="n">avgCosines</span><span class="p">[:</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">avgCosines</span> <span class="o">&lt;</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">e</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">e</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
    <span class="n">slope</span><span class="p">,</span> <span class="n">intercept</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">linregress</span><span class="p">(</span>
        <span class="nb">range</span><span class="p">(</span><span class="n">truncCosines</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">truncCosines</span><span class="p">))</span>
    <span class="k">return</span> <span class="o">-</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">slope</span>


<span class="k">def</span> <span class="nf">generateRandomLooping</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">oneMoverPerBp</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">numSteps</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">length</span>
    <span class="n">myarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
    <span class="n">movers</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">onsetRate</span> <span class="o">=</span> <span class="n">length</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">oneMoverPerBp</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">initMovers</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">movers</span><span class="p">:</span>
            <span class="n">myarray</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">myarray</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">addMovers</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">poisson</span><span class="p">(</span><span class="n">onsetRate</span><span class="p">)):</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">myarray</span><span class="p">[</span><span class="n">pos</span><span class="p">:</span><span class="n">pos</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">movers</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">pos</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">myarray</span><span class="p">[</span><span class="n">pos</span><span class="p">:</span><span class="n">pos</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">translocateMovers</span><span class="p">():</span>
        <span class="n">moved</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">mover</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">movers</span><span class="p">):</span>
            <span class="n">left</span><span class="p">,</span> <span class="n">right</span> <span class="o">=</span> <span class="n">mover</span>
            <span class="k">if</span> <span class="n">left</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">myarray</span><span class="p">[</span><span class="n">left</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">myarray</span><span class="p">[</span><span class="n">left</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">myarray</span><span class="p">[</span><span class="n">left</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">left</span> <span class="o">=</span> <span class="n">left</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="n">moved</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">if</span> <span class="n">right</span> <span class="o">&lt;</span> <span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">myarray</span><span class="p">[</span><span class="n">right</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">myarray</span><span class="p">[</span><span class="n">right</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">myarray</span><span class="p">[</span><span class="n">right</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">right</span> <span class="o">=</span> <span class="n">right</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="n">moved</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">movers</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">moved</span>

    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">numSteps</span><span class="p">):</span>
        <span class="n">addMovers</span><span class="p">()</span>
        <span class="n">translocateMovers</span><span class="p">()</span>
    <span class="k">while</span> <span class="n">translocateMovers</span><span class="p">():</span>
        <span class="k">pass</span>
    <span class="k">return</span> <span class="n">movers</span>


<div class="viewcode-block" id="create_spiral"><a class="viewcode-back" href="../polymerutils.html#polymerutils.create_spiral">[docs]</a><span class="k">def</span> <span class="nf">create_spiral</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a &quot;propagating spiral&quot;, often used as a starting conformation.</span>
<span class="sd">    Run it with r1=10, r2 = 13, N=5000, and see what it does.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Pi</span> <span class="o">=</span> <span class="mf">3.141592</span>
    <span class="n">points</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">finished</span> <span class="o">=</span> <span class="p">[</span><span class="bp">False</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">rad</span><span class="p">(</span><span class="n">phi</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">phi</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">Pi</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">ang</span><span class="p">(</span><span class="n">rad</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">Pi</span> <span class="o">*</span> <span class="n">rad</span>

    <span class="k">def</span> <span class="nf">coord</span><span class="p">(</span><span class="n">phi</span><span class="p">):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">rad</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="n">r</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">fullcoord</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">coord</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">z</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">dist</span><span class="p">(</span><span class="n">phi1</span><span class="p">,</span> <span class="n">phi2</span><span class="p">):</span>
        <span class="n">c1</span> <span class="o">=</span> <span class="n">coord</span><span class="p">(</span><span class="n">phi1</span><span class="p">)</span>
        <span class="n">c2</span> <span class="o">=</span> <span class="n">coord</span><span class="p">(</span><span class="n">phi2</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">c1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">c2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">c1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">c2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">d</span>

    <span class="k">def</span> <span class="nf">nextphi</span><span class="p">(</span><span class="n">phi</span><span class="p">):</span>
        <span class="n">phi1</span> <span class="o">=</span> <span class="n">phi</span>
        <span class="n">phi2</span> <span class="o">=</span> <span class="n">phi</span> <span class="o">+</span> <span class="mf">0.7</span> <span class="o">*</span> <span class="n">Pi</span>
        <span class="n">mid</span> <span class="o">=</span> <span class="n">phi2</span>
        <span class="k">while</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dist</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="n">mid</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.00001</span><span class="p">:</span>
            <span class="n">mid</span> <span class="o">=</span> <span class="p">(</span><span class="n">phi1</span> <span class="o">+</span> <span class="n">phi2</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span>
            <span class="k">if</span> <span class="n">dist</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="n">mid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">phi2</span> <span class="o">=</span> <span class="n">mid</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">phi1</span> <span class="o">=</span> <span class="n">mid</span>
        <span class="k">return</span> <span class="n">mid</span>

    <span class="k">def</span> <span class="nf">prevphi</span><span class="p">(</span><span class="n">phi</span><span class="p">):</span>

        <span class="n">phi1</span> <span class="o">=</span> <span class="n">phi</span>
        <span class="n">phi2</span> <span class="o">=</span> <span class="n">phi</span> <span class="o">-</span> <span class="mf">0.7</span> <span class="o">*</span> <span class="n">Pi</span>
        <span class="n">mid</span> <span class="o">=</span> <span class="n">phi2</span>

        <span class="k">while</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dist</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="n">mid</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.00001</span><span class="p">:</span>
            <span class="n">mid</span> <span class="o">=</span> <span class="p">(</span><span class="n">phi1</span> <span class="o">+</span> <span class="n">phi2</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span>
            <span class="k">if</span> <span class="n">dist</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="n">mid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">phi2</span> <span class="o">=</span> <span class="n">mid</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">phi1</span> <span class="o">=</span> <span class="n">mid</span>
        <span class="k">return</span> <span class="n">mid</span>

    <span class="k">def</span> <span class="nf">add_point</span><span class="p">(</span><span class="n">point</span><span class="p">,</span> <span class="n">points</span><span class="o">=</span><span class="n">points</span><span class="p">,</span> <span class="n">finished</span><span class="o">=</span><span class="n">finished</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)</span> <span class="o">==</span> <span class="n">N</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">finished</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="bp">True</span><span class="p">):</span>
            <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
            <span class="n">finished</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">print</span> <span class="s">&quot;finished!!!&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">point</span><span class="p">)</span>

    <span class="n">z</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">forward</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">curphi</span> <span class="o">=</span> <span class="n">ang</span><span class="p">(</span><span class="n">r1</span><span class="p">)</span>
    <span class="n">add_point</span><span class="p">(</span><span class="n">fullcoord</span><span class="p">(</span><span class="n">curphi</span><span class="p">,</span> <span class="n">z</span><span class="p">))</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">finished</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">forward</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">curphi</span> <span class="o">=</span> <span class="n">nextphi</span><span class="p">(</span><span class="n">curphi</span><span class="p">)</span>
            <span class="n">add_point</span><span class="p">(</span><span class="n">fullcoord</span><span class="p">(</span><span class="n">curphi</span><span class="p">,</span> <span class="n">z</span><span class="p">))</span>
            <span class="k">if</span><span class="p">(</span><span class="n">rad</span><span class="p">(</span><span class="n">curphi</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">r2</span><span class="p">):</span>
                <span class="n">forward</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="n">z</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">add_point</span><span class="p">(</span><span class="n">fullcoord</span><span class="p">(</span><span class="n">curphi</span><span class="p">,</span> <span class="n">z</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">curphi</span> <span class="o">=</span> <span class="n">prevphi</span><span class="p">(</span><span class="n">curphi</span><span class="p">)</span>
            <span class="n">add_point</span><span class="p">(</span><span class="n">fullcoord</span><span class="p">(</span><span class="n">curphi</span><span class="p">,</span> <span class="n">z</span><span class="p">))</span>
            <span class="k">if</span><span class="p">(</span><span class="n">rad</span><span class="p">(</span><span class="n">curphi</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">r1</span><span class="p">):</span>
                <span class="n">forward</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">z</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">add_point</span><span class="p">(</span><span class="n">fullcoord</span><span class="p">(</span><span class="n">curphi</span><span class="p">,</span> <span class="n">z</span><span class="p">))</span>

</div>
<span class="k">def</span> <span class="nf">create_random_walk</span><span class="p">(</span><span class="n">step_size</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">segment_length</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="n">N</span> <span class="o">//</span> <span class="n">segment_length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                      <span class="n">segment_length</span><span class="p">)</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">theta</span><span class="p">[:</span><span class="n">N</span><span class="p">]</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="n">N</span> <span class="o">//</span> <span class="n">segment_length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                  <span class="n">segment_length</span><span class="p">)</span>
    <span class="n">u</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">u</span><span class="p">[:</span><span class="n">N</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1.0</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">step_size</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">u</span> <span class="o">*</span> <span class="n">u</span><span class="p">)</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">step_size</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">u</span> <span class="o">*</span> <span class="n">u</span><span class="p">)</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">step_size</span> <span class="o">*</span> <span class="n">u</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>


<span class="n">matlabImported</span> <span class="o">=</span> <span class="bp">False</span>
<span class="k">def</span> <span class="nf">createFBM</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">H</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">matlabImported</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">mlabwrap</span>
        <span class="kn">from</span> <span class="nn">mlabwrap</span> <span class="kn">import</span> <span class="n">mlab</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">mlab</span><span class="o">.</span><span class="n">wfbm</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">mlab</span><span class="o">.</span><span class="n">wfbm</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">mlab</span><span class="o">.</span><span class="n">wfbm</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">length</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="n">result</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
    <span class="n">result</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span>
    <span class="n">result</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">z</span>
    <span class="k">return</span> <span class="n">result</span>


<div class="viewcode-block" id="grow_rw"><a class="viewcode-back" href="../polymerutils.html#polymerutils.grow_rw">[docs]</a><span class="k">def</span> <span class="nf">grow_rw</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s">&quot;line&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This does not grow a random walk, but the name stuck.</span>

<span class="sd">    What it does - it grows a polymer in the middle of the sizeXsizeXsize box.</span>
<span class="sd">    It can start with a small ring in the middle (method=&quot;standart&quot;),</span>
<span class="sd">    or it can start with a line (&quot;method=line&quot;).</span>
<span class="sd">    If method=&quot;linear&quot;, then it grows a linearly organized chain from 0 to size.</span>

<span class="sd">    step has to be less than size^3</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">numpy</span> <span class="o">=</span> <span class="n">np</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">size</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s">&quot;standard&quot;</span><span class="p">:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="p">[(</span><span class="n">t</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">t</span><span class="p">),</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">t</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">t</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">t</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">t</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">t</span><span class="p">)]</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s">&quot;line&quot;</span><span class="p">:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
            <span class="n">a</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">t</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">a</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">t</span><span class="p">,</span> <span class="n">t</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>

    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s">&quot;linear&quot;</span><span class="p">:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">a</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">t</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">step</span> <span class="o">%</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;select methon from line, standard, linear&quot;</span><span class="p">)</span>

    <span class="n">b</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="nb">int</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">a</span><span class="p">:</span>
        <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">((</span><span class="n">step</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span><span class="p">):</span>
        <span class="c"># print len(a)</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">t</span><span class="p">])</span> <span class="o">-</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">t</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span>
                <span class="n">t0</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">t</span><span class="p">])</span>
                <span class="n">t1</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">t</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">t</span><span class="p">])</span> <span class="o">-</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="n">t0</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">t</span><span class="p">])</span>
                <span class="n">t1</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">cur_direction</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">direction</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">direction</span> <span class="o">!=</span> <span class="n">cur_direction</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>
                <span class="n">shift</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">shift</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">shiftar</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
            <span class="n">shiftar</span><span class="p">[</span><span class="n">direction</span><span class="p">]</span> <span class="o">=</span> <span class="n">shift</span>
            <span class="n">t3</span> <span class="o">=</span> <span class="n">t0</span> <span class="o">+</span> <span class="n">shiftar</span>
            <span class="n">t4</span> <span class="o">=</span> <span class="n">t1</span> <span class="o">+</span> <span class="n">shiftar</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">t3</span><span class="p">)]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">t4</span><span class="p">)]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">t3</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">t4</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">t3</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">t4</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">):</span>
                <span class="n">a</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">t3</span><span class="p">))</span>
                <span class="n">a</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">t4</span><span class="p">))</span>
                <span class="n">b</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">t3</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">b</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">t4</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">break</span>
        <span class="c"># print a</span>
    <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

</div>
<span class="k">def</span> <span class="nf">_test</span><span class="p">():</span>

    <span class="k">print</span> <span class="s">&quot;testing save/load&quot;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="mi">20000</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="n">save</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s">&quot;bla&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&quot;txt&quot;</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">load</span><span class="p">(</span><span class="s">&quot;bla&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">-</span> <span class="n">a</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">&lt;</span> <span class="mf">0.00001</span>

    <span class="n">save</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s">&quot;bla&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&quot;joblib&quot;</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">load</span><span class="p">(</span><span class="s">&quot;bla&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">-</span> <span class="n">a</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">&lt;</span> <span class="mf">0.00001</span>

    <span class="n">save</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="s">&quot;bla&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&quot;h5dict&quot;</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">load</span><span class="p">(</span><span class="s">&quot;bla&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">-</span> <span class="n">a</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">&lt;</span> <span class="mf">0.00001</span>

    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s">&quot;bla&quot;</span><span class="p">)</span>

    <span class="k">print</span> <span class="s">&quot;Finished testing save/load, successfull&quot;</span>


<div class="viewcode-block" id="createSpiralRing"><a class="viewcode-back" href="../polymerutils.html#polymerutils.createSpiralRing">[docs]</a><span class="k">def</span> <span class="nf">createSpiralRing</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">twist</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">offsetPerParticle</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a ring of length N. Then creates a spiral</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">mirnylib</span> <span class="kn">import</span> <span class="n">numutils</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">numutils</span><span class="o">.</span><span class="n">isInteger</span><span class="p">(</span><span class="n">N</span> <span class="o">*</span> <span class="n">offsetPerParticle</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)):</span>
        <span class="k">print</span> <span class="n">N</span> <span class="o">*</span> <span class="n">offsetPerParticle</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;offsetPerParticle*N should be multitudes of 2*Pi&quot;</span><span class="p">)</span>
    <span class="n">totalTwist</span> <span class="o">=</span> <span class="n">twist</span> <span class="o">*</span> <span class="n">N</span>
    <span class="n">totalTwist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">totalTwist</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">N</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="c"># print alpha</span>
    <span class="n">twistPerParticle</span> <span class="o">=</span> <span class="n">totalTwist</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="o">+</span> <span class="n">offsetPerParticle</span>
    <span class="n">R</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
    <span class="n">twist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span> <span class="o">*</span> <span class="n">twistPerParticle</span><span class="p">)</span> <span class="o">+</span> <span class="n">offset</span>
    <span class="c"># print twist</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="n">R</span> <span class="o">+</span> <span class="n">r</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">twist</span><span class="p">)</span>
    <span class="n">z</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">+</span> <span class="n">r</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">twist</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">x0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s">&quot;C&quot;</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="smooth_conformation"><a class="viewcode-back" href="../polymerutils.html#polymerutils.smooth_conformation">[docs]</a><span class="k">def</span> <span class="nf">smooth_conformation</span><span class="p">(</span><span class="n">conformation</span><span class="p">,</span> <span class="n">n_avg</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Smooth a conformation using moving average.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">conformation</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">conformation</span> <span class="o">=</span> <span class="n">conformation</span><span class="o">.</span><span class="n">T</span>
    <span class="n">new_conformation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">conformation</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">conformation</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n_avg</span><span class="p">:</span>
            <span class="n">new_conformation</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">conformation</span><span class="p">[:</span><span class="n">i</span> <span class="o">+</span> <span class="n">n_avg</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">N</span> <span class="o">-</span> <span class="n">n_avg</span><span class="p">:</span>
            <span class="n">new_conformation</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">conformation</span><span class="p">[</span><span class="o">-</span><span class="p">(</span><span class="n">N</span> <span class="o">-</span> <span class="n">i</span> <span class="o">+</span> <span class="n">n_avg</span><span class="p">):]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_conformation</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">conformation</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">n_avg</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">n_avg</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">new_conformation</span>

</div>
<div class="viewcode-block" id="distance_matrix"><a class="viewcode-back" href="../polymerutils.html#polymerutils.distance_matrix">[docs]</a><span class="k">def</span> <span class="nf">distance_matrix</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A brute-force to find a matrix of distances between i-th and j-th</span>
<span class="sd">    particles.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        d1 : numpy.array</span>
<span class="sd">            If the only array supplied, find the pairwise distances.</span>
<span class="sd">        d2 : numpy.array</span>
<span class="sd">            If supplied, find distances from every point in d1 to</span>
<span class="sd">            every point in d2.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">d2</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">dists</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">d1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">d1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dists</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">dists</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(((</span><span class="n">d1</span> <span class="o">-</span> <span class="n">d1</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span> <span class="o">**</span> <span class="mf">0.5</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dists</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">d1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">d2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">d1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">dists</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(((</span><span class="n">d2</span> <span class="o">-</span> <span class="n">d1</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span> <span class="o">**</span> <span class="mf">0.5</span>
    <span class="k">return</span> <span class="n">dists</span>

</div>
<div class="viewcode-block" id="endtoend"><a class="viewcode-back" href="../polymerutils.html#polymerutils.endtoend">[docs]</a><span class="k">def</span> <span class="nf">endtoend</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A brute-force method to find average end-to-end distance v.s. separation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dists</span> <span class="o">=</span> <span class="n">distance_matrix</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
    <span class="n">avgdists</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">dists</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dists</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
    <span class="k">return</span> <span class="n">avgdists</span>

</div>
<div class="viewcode-block" id="getCloudGeometry"><a class="viewcode-back" href="../polymerutils.html#polymerutils.getCloudGeometry">[docs]</a><span class="k">def</span> <span class="nf">getCloudGeometry</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">frac</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">numSegments</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">widthPercentile</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Trace the centerline of an extended cloud of points and determine</span>
<span class="sd">    its length and width.</span>

<span class="sd">    The function switches to the principal axes of the cloud (e1,e2,e3)</span>
<span class="sd">    and applies LOWESS to define the centerline as (x2,x3)=f(x1).</span>
<span class="sd">    The length is then determined as the total length of the centerline.</span>
<span class="sd">    The width is determined as the median shortest distance from the points of</span>
<span class="sd">    clouds to the centerline.</span>
<span class="sd">    On top of that, the cloud can be chopped into `numSegments` in the order</span>
<span class="sd">    of data entries in `d`. The centerline is then determined independently for</span>
<span class="sd">    each segment.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    d : np.array, 3xN</span>
<span class="sd">        an array of coordinates</span>

<span class="sd">    frac : float</span>
<span class="sd">        The fraction of all points used to determine the local position and</span>
<span class="sd">        slope of the centerline in LOWESS.</span>

<span class="sd">    numSegments : int</span>
<span class="sd">        The number of segments to split `d` into. The centerline in fit</span>
<span class="sd">        independently for each data segment.</span>

<span class="sd">    widthPercentile : float</span>
<span class="sd">        The width is determined at `widthPercentile` of shortest distances</span>
<span class="sd">        from the points to the centerline. The default value is 50, i.e. the</span>
<span class="sd">        width is the median distance to the centerline.</span>

<span class="sd">    delta : float</span>
<span class="sd">        The parameter of LOWESS. According to the documentation:</span>
<span class="sd">        &quot;delta can be used to save computations. For each x_i, regressions are</span>
<span class="sd">        skipped for points closer than delta. The next regression is fit for the</span>
<span class="sd">        farthest point within delta of x_i and all points in between are</span>
<span class="sd">        estimated by linearly interpolating between the two regression fits.&quot;</span>

<span class="sd">    Return</span>
<span class="sd">    ------</span>

<span class="sd">        (length, width) : (float, float)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">import</span> <span class="nn">statsmodels</span>
    <span class="kn">import</span> <span class="nn">statsmodels.nonparametric</span>
    <span class="kn">import</span> <span class="nn">statsmodels.nonparametric.smoothers_lowess</span>
    <span class="kn">from</span> <span class="nn">mirnylib</span> <span class="kn">import</span> <span class="n">numutils</span>

    <span class="n">dists</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">length</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">segm</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numSegments</span><span class="p">):</span>
        <span class="n">segmd</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">segm</span> <span class="o">*</span> <span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="n">numSegments</span><span class="p">)</span> <span class="p">:</span> <span class="p">(</span><span class="n">segm</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="n">numSegments</span><span class="p">)]</span>
        <span class="p">(</span><span class="n">e1</span><span class="p">,</span> <span class="n">e2</span><span class="p">),</span> <span class="n">_</span> <span class="o">=</span> <span class="n">numutils</span><span class="o">.</span><span class="n">PCA</span><span class="p">(</span><span class="n">segmd</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">e3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">e1</span><span class="p">,</span> <span class="n">e2</span><span class="p">)</span>
        <span class="n">xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">segmd</span><span class="p">,</span> <span class="n">e1</span><span class="p">)</span>
        <span class="n">ys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">segmd</span><span class="p">,</span> <span class="n">e2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">segmd</span><span class="p">,</span> <span class="n">e3</span><span class="p">)])</span>
        <span class="n">ys_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span>
            <span class="n">statsmodels</span><span class="o">.</span><span class="n">nonparametric</span><span class="o">.</span><span class="n">smoothers_lowess</span><span class="o">.</span><span class="n">lowess</span><span class="p">(</span>
                        <span class="n">ys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xs</span><span class="p">,</span> <span class="n">frac</span><span class="o">=</span><span class="n">frac</span><span class="p">,</span> <span class="n">return_sorted</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="mi">10</span><span class="p">),</span>
            <span class="n">statsmodels</span><span class="o">.</span><span class="n">nonparametric</span><span class="o">.</span><span class="n">smoothers_lowess</span><span class="o">.</span><span class="n">lowess</span><span class="p">(</span>
                        <span class="n">ys</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">xs</span><span class="p">,</span> <span class="n">frac</span><span class="o">=</span><span class="n">frac</span><span class="p">,</span> <span class="n">return_sorted</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                         <span class="n">delta</span><span class="o">=</span><span class="mi">10</span><span class="p">)])</span>
        <span class="n">order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span>
        <span class="n">fit_d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">xs</span><span class="p">[</span><span class="n">order</span><span class="p">],</span>
                           <span class="n">ys_pred</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">order</span><span class="p">],</span>
                           <span class="n">ys_pred</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">order</span><span class="p">]])</span><span class="o">.</span><span class="n">T</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xs</span><span class="p">)):</span>
            <span class="n">dists</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">(((</span><span class="n">fit_d</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ys</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">ys</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]]))</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>

        <span class="n">length</span> <span class="o">+=</span> <span class="p">(((</span><span class="n">fit_d</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">fit_d</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">width</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">dists</span><span class="p">,</span> <span class="n">widthPercentile</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">length</span><span class="p">,</span> <span class="n">width</span>


</div>
<span class="k">def</span> <span class="nf">_getLinkingNumber</span><span class="p">(</span><span class="n">data1</span><span class="p">,</span> <span class="n">data2</span><span class="p">,</span> <span class="n">randomOffset</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">data1</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data1</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">data2</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data2</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span>
    <span class="n">data1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">data1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s">&quot;C&quot;</span><span class="p">)</span>
    <span class="n">data2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">data2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s">&quot;C&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">randomOffset</span><span class="p">:</span>
        <span class="n">data1</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">data1</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.0000001</span>
        <span class="n">data2</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">data2</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.0000001</span>
    <span class="n">olddata</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">data1</span><span class="p">,</span> <span class="n">data2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">olddata</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">olddata</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s">&quot;C&quot;</span><span class="p">)</span>
    <span class="n">M</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data1</span><span class="p">)</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">olddata</span><span class="p">)</span>
    <span class="n">returnArray</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
    <span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">weave</span>

    <span class="n">support</span> <span class="o">=</span> <span class="s">r&quot;&quot;&quot;</span>
<span class="s">#include &lt;stdio.h&gt;</span>
<span class="s">#include &lt;stdlib.h&gt;</span>

<span class="s">double *cross(double *v1, double *v2) {</span>
<span class="s">    double *v1xv2 = new double[3];</span>
<span class="s">    v1xv2[0]=-v1[2]*v2[1] + v1[1]*v2[2];</span>
<span class="s">    v1xv2[1]=v1[2]*v2[0] - v1[0]*v2[2];</span>
<span class="s">    v1xv2[2]=-v1[1]*v2[0] + v1[0]*v2[1];</span>
<span class="s">    return v1xv2;</span>
<span class="s">}</span>

<span class="s">double *linearCombo(double *v1, double *v2, double s1, double s2) {</span>
<span class="s">    double *c = new double[3];</span>
<span class="s">    c[0]=s1*v1[0]+s2*v2[0];</span>
<span class="s">    c[1]=s1*v1[1]+s2*v2[1];</span>
<span class="s">    c[2]=s1*v1[2]+s2*v2[2];</span>
<span class="s">        return c;</span>
<span class="s">}</span>

<span class="s">long int intersectValue(double *p1, double *v1, double *p2, double *v2) {</span>
<span class="s">    int x=0;</span>
<span class="s">    double *v2xp2 = cross(v2,p2), *v2xp1 = cross(v2,p1), *v2xv1 = cross(v2,v1);</span>
<span class="s">    double *v1xp1 = cross(v1,p1), *v1xp2 = cross(v1,p2), *v1xv2 = cross(v1,v2);</span>
<span class="s">    double t1 = (v2xp2[2]-v2xp1[2])/v2xv1[2];</span>
<span class="s">    double t2 = (v1xp1[2]-v1xp2[2])/v1xv2[2];</span>
<span class="s">    if(t1&lt;0 || t1&gt;1 || t2&lt;0 || t2&gt;1) {</span>
<span class="s">        free(v2xp2);free(v2xp1);free(v2xv1);free(v1xp1);free(v1xp2);free(v1xv2);</span>
<span class="s">        return 0;</span>
<span class="s">    }</span>
<span class="s">    else {</span>
<span class="s">        if(v1xv2[2]&gt;=0) x=1;</span>
<span class="s">        else x=-1;</span>
<span class="s">    }</span>
<span class="s">    double *inter1 = linearCombo(p1,v1,1,t1), *inter2 = linearCombo(p2,v2,1,t2);</span>
<span class="s">    double z1 = inter1[2];</span>
<span class="s">    double z2 = inter2[2];</span>

<span class="s">    free(v2xp2);free(v2xp1);free(v2xv1);free(v1xp1);free(v1xp2);free(v1xv2);free(inter1);free(inter2);</span>
<span class="s">    if(z1&gt;=z2) return x;</span>
<span class="s">    else return -x;</span>
<span class="s">}</span>
<span class="s">    &quot;&quot;&quot;</span>

    <span class="n">code</span> <span class="o">=</span> <span class="s">r&quot;&quot;&quot;</span>
<span class="s">    #line 1149 &quot;numutils.py&quot;</span>
<span class="s">    double **data = new double*[N];</span>
<span class="s">    long int i,j;</span>
<span class="s">    for(i=0;i&lt;N;i++) {</span>

<span class="s">        data[i] = new double[3];</span>
<span class="s">        data[i][0]=olddata[3*i];</span>
<span class="s">        data[i][1]=olddata[3*i+1];</span>
<span class="s">        data[i][2]=olddata[3*i + 2];</span>
<span class="s">    }</span>

<span class="s">    long int L = 0;</span>
<span class="s">        for(i=0;i&lt;M;i++) {</span>
<span class="s">            for(j=M;j&lt;N;j++) {</span>
<span class="s">                double *v1, *v2;</span>
<span class="s">                if(i&lt;M-1) v1 = linearCombo(data[i+1],data[i],1,-1);</span>
<span class="s">                else v1 = linearCombo(data[0],data[M-1],1,-1);</span>

<span class="s">                if(j&lt;N-1) v2 = linearCombo(data[j+1],data[j],1,-1);</span>
<span class="s">                else v2 = linearCombo(data[M],data[N-1],1,-1);</span>
<span class="s">                L+=intersectValue(data[i],v1,data[j],v2);</span>
<span class="s">                free(v1);free(v2);</span>
<span class="s">            }</span>
<span class="s">        }</span>

<span class="s">    returnArray[0] =  L;</span>

<span class="s">&quot;&quot;&quot;</span>
    <span class="n">M</span><span class="p">,</span> <span class="n">N</span>  <span class="c"># Eclipse warning removal</span>
    <span class="n">weave</span><span class="o">.</span><span class="n">inline</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;M&#39;</span><span class="p">,</span> <span class="s">&#39;olddata&#39;</span><span class="p">,</span> <span class="s">&#39;N&#39;</span><span class="p">,</span> <span class="s">&quot;returnArray&quot;</span><span class="p">],</span> <span class="n">extra_compile_args</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;-march=native -malign-double -O3&#39;</span><span class="p">],</span> <span class="n">support_code</span><span class="o">=</span><span class="n">support</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">returnArray</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>



<div class="viewcode-block" id="findSimplifiedPolymer"><a class="viewcode-back" href="../polymerutils.html#polymerutils.findSimplifiedPolymer">[docs]</a><span class="k">def</span> <span class="nf">findSimplifiedPolymer</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;a weave.inline wrapper for polymer simplification code</span>
<span class="sd">    Calculates a simplified topologically equivalent polymer ring&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Wrong dimensions of data&quot;</span><span class="p">)</span>
    <span class="n">datax</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">float</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s">&quot;C&quot;</span><span class="p">)</span>
    <span class="n">datay</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">float</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s">&quot;C&quot;</span><span class="p">)</span>
    <span class="n">dataz</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nb">float</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s">&quot;C&quot;</span><span class="p">)</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">datax</span><span class="p">)</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">datax</span><span class="p">,</span> <span class="n">datay</span><span class="p">,</span> <span class="n">dataz</span><span class="p">,</span> <span class="n">N</span>  <span class="c"># eclipse warning removal</span>
    <span class="n">code</span> <span class="o">=</span> <span class="s">r&quot;&quot;&quot;</span>
<span class="s">    #line 290 &quot;binary_search.py&quot;</span>
<span class="s">    int M = 0;</span>
<span class="s">    int k1;</span>
<span class="s">    int sum = 0;</span>
<span class="s">    int t=0,s=0,k=0;</span>
<span class="s">    int turn=0;</span>
<span class="s">    bool breakflag;</span>
<span class="s">    float maxdist;</span>
<span class="s">    int a;</span>
<span class="s">    position=vector&lt;point&gt;(N);</span>
<span class="s">    newposition=vector&lt;point&gt;(N);</span>

<span class="s">    for (i=0;i&lt;N;i++)</span>
<span class="s">    {</span>
<span class="s">    position[i].x = datax[i] +  0.000000000001*(rand()%1000);</span>
<span class="s">    position[i].y = datay[i] + 0.00000000000001*(rand()%1000);</span>
<span class="s">    position[i].z  = dataz[i] +  0.0000000000001*(rand()%1000);</span>
<span class="s">    }</span>
<span class="s">    todelete = vector &lt;int&gt; (N);</span>
<span class="s">    for (i=0;i&lt;N;i++) todelete[i] == -2;</span>
<span class="s">    for (int xxx = 0; xxx &lt; 1000; xxx++)</span>
<span class="s">        {</span>
<span class="s">        maxdist = 0;</span>
<span class="s">        for (i=0;i&lt;N-1;i++)</span>
<span class="s">        {</span>
<span class="s">        if (dist(i,i+1) &gt; maxdist) {maxdist = dist(i,i+1);}</span>
<span class="s">        }</span>
<span class="s">        turn++;</span>
<span class="s">        M=0;</span>
<span class="s">        for (i=0;i&lt;N;i++) todelete[i] = -2;</span>
<span class="s">        for (int j=1;j&lt;N-1;j++)  //going over all elements trying to delete</span>
<span class="s">            {</span>
<span class="s">            breakflag = false; //by default we delete thing</span>

<span class="s">            for (k=0;k&lt;N;k++)  //going over all triangles to check</span>
<span class="s">                {</span>
<span class="s">                double dd = dist(j,k);</span>
<span class="s">                if (dd  &lt; 3 * maxdist)</span>
<span class="s">                {</span>

<span class="s">                if (k &lt; j-2 || k &gt; j+1)</span>
<span class="s">                    {</span>
<span class="s">                    if (k &lt; N-1) k1 = k+1;</span>
<span class="s">                    else k1 = 0;</span>
<span class="s">                    sum = intersect(position[j-1],position[j],position[</span>
<span class="s">                        j+1],position[k],position[k1]);</span>
<span class="s">                    if (sum!=0)</span>
<span class="s">                        {</span>
<span class="s">                        //printf(&quot;intersection at </span><span class="si">%d</span><span class="s">,</span><span class="si">%d</span><span class="s">\n&quot;,j,k);</span>
<span class="s">                        breakflag = true; //keeping thing</span>
<span class="s">                        break;</span>
<span class="s">                        }</span>
<span class="s">                    }</span>
<span class="s">		}</span>
<span class="s">		else</span>
<span class="s">		{</span>
<span class="s">			k+= abs((int)((float)dd/(float)maxdist )- 3);</span>
<span class="s">		}</span>
<span class="s">                }</span>
<span class="s">            if (breakflag ==false)</span>
<span class="s">            {</span>
<span class="s">            todelete[M++] = j;</span>
<span class="s">            position[j] = (position[j-1] + position[j+1])* 0.5;</span>
<span class="s">            //printf(&quot;</span><span class="si">%d</span><span class="s"> will be deleted at </span><span class="si">%d</span><span class="s">\n&quot;,j,k);</span>
<span class="s">            j++;</span>
<span class="s">            //break;</span>
<span class="s">            }</span>
<span class="s">            }</span>
<span class="s">        t = 0;//pointer for todelete</span>
<span class="s">        s = 0;//pointer for newposition</span>
<span class="s">        if (M==0)</span>
<span class="s">            {</span>
<span class="s">            break;</span>
<span class="s">            }</span>
<span class="s">        for (int j=0;j&lt;N;j++)</span>
<span class="s">            {</span>
<span class="s">            if (todelete[t] == j)</span>
<span class="s">                {</span>
<span class="s">                t++;</span>
<span class="s">                continue;</span>
<span class="s">                }</span>
<span class="s">            else</span>
<span class="s">                {</span>
<span class="s">                newposition[s++] = position[j];</span>
<span class="s">                }</span>
<span class="s">            }</span>
<span class="s">        N = s;</span>
<span class="s">        M = 0;</span>
<span class="s">        t = 0;</span>
<span class="s">        position = newposition;</span>
<span class="s">        }</span>
<span class="s">    ret[0] = N;</span>

<span class="s">    for (i=0;i&lt;N;i++)</span>
<span class="s">    {</span>
<span class="s">    datax[i]  = position[i].x;</span>
<span class="s">    datay[i]  = position[i].y;</span>
<span class="s">    dataz[i]  = position[i].z;</span>
<span class="s">    }</span>
<span class="s">    &quot;&quot;&quot;</span>
    <span class="n">support</span> <span class="o">=</span> <span class="s">r&quot;&quot;&quot;</span>
<span class="s">#line 400 &quot;binary_search.py&quot;</span>
<span class="s">#include &lt;cstdlib&gt;</span>
<span class="s">#include &lt;iostream&gt;</span>
<span class="s">#include &lt;iomanip&gt;</span>
<span class="s">#include &lt;cmath&gt;</span>
<span class="s">#include &lt;vector&gt;</span>
<span class="s">#include &lt;ctime&gt;</span>
<span class="s">#include &lt;omp.h&gt;</span>
<span class="s">#include &lt;stdio.h&gt;</span>
<span class="s">using namespace std;</span>
<span class="s">struct point{</span>
<span class="s">    double x,y,z;</span>
<span class="s">    point operator + (const point &amp;p) const {</span>
<span class="s">        return (point) {x+p.x, y+p.y, z+p.z};</span>
<span class="s">    }</span>
<span class="s">    point operator - (const point &amp;p) const {</span>
<span class="s">        return (point) {x-p.x, y-p.y, z-p.z};</span>
<span class="s">    }</span>
<span class="s">/* cross product */</span>
<span class="s">    point operator * (const point &amp;p) const {</span>
<span class="s">        return (point) {y*p.z - z*p.y,</span>
<span class="s">                        z*p.x - x*p.z,</span>
<span class="s">                        x*p.y - y*p.x};</span>
<span class="s">    }</span>
<span class="s">    point operator * (const double &amp;d) const {</span>
<span class="s">        return (point) {d*x, d*y, d*z};</span>
<span class="s">    }</span>

<span class="s">    point operator / (const double &amp;d) const {</span>
<span class="s">        return (point) {x/d, y/d, z/d};</span>
<span class="s">    }</span>
<span class="s">};</span>

<span class="s">vector &lt;point&gt; position;</span>
<span class="s">vector &lt;point&gt; newposition;</span>
<span class="s">vector &lt;int&gt; todelete;</span>
<span class="s">int N;</span>
<span class="s">int i;</span>
<span class="s">double dist(int i,int j);</span>
<span class="s">double dotProduct(point a,point b);</span>
<span class="s">int intersect(point t1,point t2,point t3,point r1,point r2);</span>

<span class="s">inline double sqr(double x){</span>
<span class="s">    return x*x;</span>
<span class="s">}</span>
<span class="s">inline double dist(int i,int j){</span>
<span class="s">return sqrt(dotProduct((position[i]-position[j]),(position[i]-position[j])));</span>
<span class="s">}</span>

<span class="s">inline double dist(point a,point b){</span>
<span class="s">    return sqr(a.x-b.x)+sqr(a.y-b.y)+sqr(a.z-b.z);</span>
<span class="s">}</span>

<span class="s">inline double dotProduct(point a,point b){</span>
<span class="s">    return a.x*b.x+a.y*b.y+a.z*b.z;</span>
<span class="s">}</span>

<span class="s">int intersect(point t1,point t2,point t3,point r1,point r2)</span>
<span class="s">{</span>
<span class="s">point A,B,C,D,n;</span>
<span class="s">int r;</span>
<span class="s">double det,t,u,v,c1,d1,d2,d3;</span>
<span class="s">B = t2 - t1;</span>
<span class="s">C = t3 - t1;</span>
<span class="s">D = r2 - t1;</span>
<span class="s">A = r2 - r1;</span>

<span class="s">d1 = (B.y*C.z-C.y*B.z);</span>
<span class="s">d2 = (B.x*C.z-B.z*C.x);</span>
<span class="s">d3 = (B.x*C.y-C.x*B.y);</span>
<span class="s">det = A.x*d1-A.y*d2+A.z*d3;</span>
<span class="s">if (det == 0) return 0;</span>
<span class="s">if (det &gt;0){</span>
<span class="s">t = D.x*d1-D.y*d2+D.z*d3;</span>
<span class="s">if (t&lt;0 || t&gt;det) return 0;</span>
<span class="s">u = A.x*(D.y*C.z-C.y*D.z)-A.y*(D.x*C.z-D.z*C.x)+A.z*(D.x*C.y-C.x*D.y);</span>
<span class="s">if (u&lt;0 || u&gt;det) return 0;</span>
<span class="s">v = A.x*(B.y*D.z-D.y*B.z)-A.y*(B.x*D.z-B.z*D.x)+A.z*(B.x*D.y-D.x*B.y);</span>
<span class="s">if (v&lt;0 || v&gt;det || (u+v)&gt;det) return 0;</span>
<span class="s">//printf(&quot;\n</span><span class="si">%lf</span><span class="s">,</span><span class="si">%lf</span><span class="s">,</span><span class="si">%lf</span><span class="s">, &quot;,t/det,u/det,v/det);</span>
<span class="s">n = B*C;</span>
<span class="s">c1 = dotProduct(r1-t1,n);</span>
<span class="s">if (c1&gt;0) return 1;</span>
<span class="s">else return -1;</span>
<span class="s">}</span>
<span class="s">else{</span>
<span class="s">t = D.x*d1-D.y*d2+D.z*d3;</span>
<span class="s">if (t&gt;0 || t&lt;det) return 0;</span>
<span class="s">u = A.x*(D.y*C.z-C.y*D.z)-A.y*(D.x*C.z-D.z*C.x)+A.z*(D.x*C.y-C.x*D.y);</span>
<span class="s">if (u&gt;0 || u&lt;det) return 0;</span>
<span class="s">v = A.x*(B.y*D.z-D.y*B.z)-A.y*(B.x*D.z-B.z*D.x)+A.z*(B.x*D.y-D.x*B.y);</span>
<span class="s">if (v&gt;0 || v&lt;det || (u+v)&lt;det) return 0;</span>
<span class="s">//printf(&quot;\n</span><span class="si">%lf</span><span class="s">,</span><span class="si">%lf</span><span class="s">,</span><span class="si">%lf</span><span class="s">, &quot;,t/det,u/det,v/det);</span>
<span class="s">n = B*C;</span>
<span class="s">c1 = dotProduct(r1-t1,n);</span>
<span class="s">if (c1&gt;0) return 1;</span>
<span class="s">else return -1;</span>
<span class="s">}</span>
<span class="s">}</span>
<span class="s">//DNA conformation</span>
<span class="s">&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">weave</span>
    <span class="n">weave</span><span class="o">.</span><span class="n">inline</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;datax&#39;</span><span class="p">,</span> <span class="s">&#39;datay&#39;</span><span class="p">,</span> <span class="s">&#39;dataz&#39;</span><span class="p">,</span> <span class="s">&#39;N&#39;</span><span class="p">,</span> <span class="s">&#39;ret&#39;</span><span class="p">],</span>
                 <span class="n">extra_compile_args</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;-malign-double&#39;</span><span class="p">],</span> <span class="n">support_code</span><span class="o">=</span><span class="n">support</span><span class="p">)</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">datax</span><span class="p">,</span> <span class="n">datay</span><span class="p">,</span> <span class="n">dataz</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>

    <span class="k">return</span> <span class="n">data</span><span class="p">[:</span><span class="n">ret</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

</div>
<span class="k">def</span> <span class="nf">_mutualSimplify</span><span class="p">(</span><span class="n">data1</span><span class="p">,</span> <span class="n">data2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;a weave.inline wrapper for polymer simplification code</span>
<span class="sd">    Calculates a simplified topologically equivalent polymer ring&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">data1</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">data1</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Wrong dimensions of data&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data2</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">data2</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">data2</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data2</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Wrong dimensions of data&quot;</span><span class="p">)</span>

    <span class="n">datax1</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">float</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s">&quot;C&quot;</span><span class="p">)</span>
    <span class="n">datay1</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">float</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s">&quot;C&quot;</span><span class="p">)</span>
    <span class="n">dataz1</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data1</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nb">float</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s">&quot;C&quot;</span><span class="p">)</span>

    <span class="n">datax2</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">float</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s">&quot;C&quot;</span><span class="p">)</span>
    <span class="n">datay2</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">float</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s">&quot;C&quot;</span><span class="p">)</span>
    <span class="n">dataz2</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data2</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nb">float</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s">&quot;C&quot;</span><span class="p">)</span>

    <span class="n">N1</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">datax1</span><span class="p">)</span>
    <span class="n">N2</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">datax2</span><span class="p">)</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">datax1</span><span class="p">,</span> <span class="n">datay1</span><span class="p">,</span> <span class="n">dataz1</span><span class="p">,</span> <span class="n">datax2</span><span class="p">,</span> <span class="n">datay2</span><span class="p">,</span> <span class="n">dataz2</span><span class="p">,</span> <span class="n">N1</span><span class="p">,</span> <span class="n">N2</span>  <span class="c"># eclipse warning removal</span>
    <span class="n">code</span> <span class="o">=</span> <span class="s">r&quot;&quot;&quot;</span>
<span class="s">    #line 264 &quot;binary_search.py&quot;</span>
<span class="s">    int M = 0;</span>
<span class="s">    int sum = 0;</span>
<span class="s">    int t=0,s=0,k=0, k1;</span>
<span class="s">    int turn=0;</span>
<span class="s">    bool breakflag;</span>

<span class="s">    int a;</span>
<span class="s">    position1=vector&lt;point&gt;(N1);</span>
<span class="s">    newposition1=vector&lt;point&gt;(N1);</span>

<span class="s">    position2=vector&lt;point&gt;(N2);</span>
<span class="s">    newposition2=vector&lt;point&gt;(N2);</span>


<span class="s">    for (i=0;i&lt;N1;i++)</span>
<span class="s">    {</span>
<span class="s">    position1[i].x = datax1[i] +  0.000000000000001*(rand()%1000);</span>
<span class="s">    position1[i].y = datay1[i] +0.00000000000000001*(rand()%1000);</span>
<span class="s">    position1[i].z  = dataz1[i] +  0.00000000000000001*(rand()%1000);</span>
<span class="s">    }</span>

<span class="s">    for (i=0;i&lt;N2;i++)</span>
<span class="s">    {</span>
<span class="s">    position2[i].x = datax2[i] +  0.000000000000001*(rand()%1000);</span>
<span class="s">    position2[i].y = datay2[i] +0.0000000000000000001*(rand()%1000);</span>
<span class="s">    position2[i].z  = dataz2[i] +  0.0000000000000000001*(rand()%1000);</span>
<span class="s">    }</span>

<span class="s">    todelete1 = vector &lt;int&gt; (N1);</span>
<span class="s">    todelete2 = vector &lt;int&gt; (N2);</span>

<span class="s">    for (i=0;i&lt;N1;i++) todelete1[i] == -2;</span>
<span class="s">    for (i=0;i&lt;N2;i++) todelete2[i] == -2;</span>

<span class="s">    for (int ttt = 0; ttt &lt; 1; ttt++)</span>
<span class="s">        {</span>
<span class="s">        turn++;</span>
<span class="s">        M=0;</span>
<span class="s">        for (i=0;i&lt;N1;i++) todelete1[i] = -2;</span>
<span class="s">        for (i=0;i&lt;N2;i++) todelete2[i] = -2;</span>

<span class="s">        for (int j=1;j&lt;N1-1;j++)  //going over all elements trying to delete</span>
<span class="s">            {</span>

<span class="s">            breakflag = false; //by default we delete thing</span>
<span class="s">            for (k=0;k&lt;N1;k++)  //going over all triangles to check</span>
<span class="s">                {</span>
<span class="s">                if (k &lt; j-2 || k &gt; j+1)</span>
<span class="s">                    {</span>
<span class="s">                    if (k &lt; N1 - 1) k1 = k + 1;</span>
<span class="s">                    else k1 = 0;</span>
<span class="s">                    sum = intersect(position1[j-1],position1[j],position1[</span>
<span class="s">                        j+1],position1[k],position1[k1]);</span>
<span class="s">                    if (sum!=0)</span>
<span class="s">                        {</span>
<span class="s">                        //printf(&quot;intersection at </span><span class="si">%d</span><span class="s">,</span><span class="si">%d</span><span class="s">\n&quot;,j,k);</span>
<span class="s">                        breakflag = true; //keeping thing</span>
<span class="s">                        break;</span>
<span class="s">                        }</span>
<span class="s">                    }</span>
<span class="s">                }</span>

<span class="s">            if (breakflag == false)</span>
<span class="s">            {</span>
<span class="s">            for (k=0;k&lt;N2;k++)  //going over all triangles to check</span>
<span class="s">                {</span>
<span class="s">                    if (k &lt; N2 - 1) k1 = k + 1;</span>
<span class="s">                    else k1 = 0;</span>
<span class="s">                    sum = intersect(position1[j-1],position1[j],position1[</span>
<span class="s">                        j+1],position2[k],position2[k1]);</span>
<span class="s">                    if (sum!=0)</span>
<span class="s">                        {</span>
<span class="s">                        //printf(&quot;crossintersection at </span><span class="si">%d</span><span class="s">,</span><span class="si">%d</span><span class="s">\n&quot;,j,k);</span>
<span class="s">                        breakflag = true; //keeping thing</span>
<span class="s">                        break;</span>
<span class="s">                        }</span>
<span class="s">                }</span>
<span class="s">             }</span>

<span class="s">            if (breakflag ==false)</span>
<span class="s">            {</span>
<span class="s">            todelete1[M++] = j;</span>
<span class="s">            position1[j] = (position1[j-1] + position1[j+1])* 0.5;</span>
<span class="s">            //printf(&quot;</span><span class="si">%d</span><span class="s"> will be deleted at </span><span class="si">%d</span><span class="s">\n&quot;,j,k);</span>
<span class="s">            j++;</span>
<span class="s">            //break;</span>
<span class="s">            }</span>
<span class="s">            }</span>
<span class="s">        t = 0;//pointer for todelete</span>
<span class="s">        s = 0;//pointer for newposition</span>
<span class="s">        if (M==0)</span>
<span class="s">            {</span>
<span class="s">            break;</span>
<span class="s">            }</span>
<span class="s">        for (int j=0;j&lt;N1;j++)</span>
<span class="s">            {</span>
<span class="s">            if (todelete1[t] == j)</span>
<span class="s">                {</span>
<span class="s">                t++;</span>
<span class="s">                continue;</span>
<span class="s">                }</span>
<span class="s">            else</span>
<span class="s">                {</span>
<span class="s">                newposition1[s++] = position1[j];</span>
<span class="s">                }</span>
<span class="s">            }</span>
<span class="s">        N1 = s;</span>
<span class="s">        M = 0;</span>
<span class="s">        t = 0;</span>
<span class="s">        position1 = newposition1;</span>
<span class="s">        }</span>

<span class="s">    ret[0] = N1;</span>
<span class="s">    ret[1] = N2;</span>

<span class="s">    for (i=0;i&lt;N1;i++)</span>
<span class="s">    {</span>
<span class="s">    datax1[i]  = position1[i].x;</span>
<span class="s">    datay1[i]  = position1[i].y;</span>
<span class="s">    dataz1[i]  = position1[i].z;</span>
<span class="s">    }</span>
<span class="s">    for (i=0;i&lt;N2;i++)</span>
<span class="s">    {</span>
<span class="s">    datax2[i]  = position2[i].x;</span>
<span class="s">    datay2[i]  = position2[i].y;</span>
<span class="s">    dataz2[i]  = position2[i].z;</span>
<span class="s">    }</span>

<span class="s">    &quot;&quot;&quot;</span>
    <span class="n">support</span> <span class="o">=</span> <span class="s">r&quot;&quot;&quot;</span>
<span class="s">#line 415 &quot;binary_search.py&quot;</span>
<span class="s">#include &lt;cstdlib&gt;</span>
<span class="s">#include &lt;iostream&gt;</span>
<span class="s">#include &lt;iomanip&gt;</span>
<span class="s">#include &lt;cmath&gt;</span>
<span class="s">#include &lt;vector&gt;</span>
<span class="s">#include &lt;ctime&gt;</span>
<span class="s">#include &lt;omp.h&gt;</span>
<span class="s">#include &lt;stdio.h&gt;</span>
<span class="s">using namespace std;</span>
<span class="s">struct point{</span>
<span class="s">    double x,y,z;</span>
<span class="s">    point operator + (const point &amp;p) const {</span>
<span class="s">        return (point) {x+p.x, y+p.y, z+p.z};</span>
<span class="s">    }</span>
<span class="s">    point operator - (const point &amp;p) const {</span>
<span class="s">        return (point) {x-p.x, y-p.y, z-p.z};</span>
<span class="s">    }</span>
<span class="s">/* cross product */</span>
<span class="s">    point operator * (const point &amp;p) const {</span>
<span class="s">        return (point) {y*p.z - z*p.y,</span>
<span class="s">                        z*p.x - x*p.z,</span>
<span class="s">                        x*p.y - y*p.x};</span>
<span class="s">    }</span>
<span class="s">    point operator * (const double &amp;d) const {</span>
<span class="s">        return (point) {d*x, d*y, d*z};</span>
<span class="s">    }</span>

<span class="s">    point operator / (const double &amp;d) const {</span>
<span class="s">        return (point) {x/d, y/d, z/d};</span>
<span class="s">    }</span>
<span class="s">};</span>

<span class="s">vector &lt;point&gt; position1;</span>
<span class="s">vector &lt;point&gt; newposition1;</span>
<span class="s">vector &lt;int&gt; todelete1;</span>
<span class="s">int N1;</span>
<span class="s">vector &lt;point&gt; position2;</span>
<span class="s">vector &lt;point&gt; newposition2;</span>
<span class="s">vector &lt;int&gt; todelete2;</span>
<span class="s">int N2;</span>


<span class="s">int i;</span>
<span class="s">double dist1(int i,int j);</span>
<span class="s">double dist2(int i,int j);</span>
<span class="s">double dotProduct(point a,point b);</span>
<span class="s">int intersect(point t1,point t2,point t3,point r1,point r2);</span>

<span class="s">inline double sqr(double x){</span>
<span class="s">    return x*x;</span>
<span class="s">}</span>
<span class="s">inline double dist1(int i,int j){</span>
<span class="s">return sqrt(dotProduct((position1[i]-position1[j]),(position1[i]-position1[j])));</span>
<span class="s">}</span>

<span class="s">inline double dist2(int i,int j){</span>
<span class="s">return sqrt(dotProduct((position2[i]-position2[j]),(position2[i]-position2[j])));</span>
<span class="s">}</span>

<span class="s">inline double dist(point a,point b){</span>
<span class="s">    return sqr(a.x-b.x)+sqr(a.y-b.y)+sqr(a.z-b.z);</span>
<span class="s">}</span>

<span class="s">inline double dotProduct(point a,point b){</span>
<span class="s">    return a.x*b.x+a.y*b.y+a.z*b.z;</span>
<span class="s">}</span>

<span class="s">int intersect(point t1,point t2,point t3,point r1,point r2)</span>
<span class="s">{</span>
<span class="s">point A,B,C,D,n;</span>
<span class="s">int r;</span>
<span class="s">double det,t,u,v,c1,d1,d2,d3;</span>
<span class="s">B = t2 - t1;</span>
<span class="s">C = t3 - t1;</span>
<span class="s">D = r2 - t1;</span>
<span class="s">A = r2 - r1;</span>

<span class="s">d1 = (B.y*C.z-C.y*B.z);</span>
<span class="s">d2 = (B.x*C.z-B.z*C.x);</span>
<span class="s">d3 = (B.x*C.y-C.x*B.y);</span>
<span class="s">det = A.x*d1-A.y*d2+A.z*d3;</span>
<span class="s">if (det == 0) return 0;</span>
<span class="s">if (det &gt;0){</span>
<span class="s">t = D.x*d1-D.y*d2+D.z*d3;</span>
<span class="s">if (t&lt;0 || t&gt;det) return 0;</span>
<span class="s">u = A.x*(D.y*C.z-C.y*D.z)-A.y*(D.x*C.z-D.z*C.x)+A.z*(D.x*C.y-C.x*D.y);</span>
<span class="s">if (u&lt;0 || u&gt;det) return 0;</span>
<span class="s">v = A.x*(B.y*D.z-D.y*B.z)-A.y*(B.x*D.z-B.z*D.x)+A.z*(B.x*D.y-D.x*B.y);</span>
<span class="s">if (v&lt;0 || v&gt;det || (u+v)&gt;det) return 0;</span>
<span class="s">//printf(&quot;\n</span><span class="si">%lf</span><span class="s">,</span><span class="si">%lf</span><span class="s">,</span><span class="si">%lf</span><span class="s">, &quot;,t/det,u/det,v/det);</span>
<span class="s">n = B*C;</span>
<span class="s">c1 = dotProduct(r1-t1,n);</span>
<span class="s">if (c1&gt;0) return 1;</span>
<span class="s">else return -1;</span>
<span class="s">}</span>
<span class="s">else{</span>
<span class="s">t = D.x*d1-D.y*d2+D.z*d3;</span>
<span class="s">if (t&gt;0 || t&lt;det) return 0;</span>
<span class="s">u = A.x*(D.y*C.z-C.y*D.z)-A.y*(D.x*C.z-D.z*C.x)+A.z*(D.x*C.y-C.x*D.y);</span>
<span class="s">if (u&gt;0 || u&lt;det) return 0;</span>
<span class="s">v = A.x*(B.y*D.z-D.y*B.z)-A.y*(B.x*D.z-B.z*D.x)+A.z*(B.x*D.y-D.x*B.y);</span>
<span class="s">if (v&gt;0 || v&lt;det || (u+v)&lt;det) return 0;</span>
<span class="s">//printf(&quot;\n</span><span class="si">%lf</span><span class="s">,</span><span class="si">%lf</span><span class="s">,</span><span class="si">%lf</span><span class="s">, &quot;,t/det,u/det,v/det);</span>
<span class="s">n = B*C;</span>
<span class="s">c1 = dotProduct(r1-t1,n);</span>
<span class="s">if (c1&gt;0) return 1;</span>
<span class="s">else return -1;</span>
<span class="s">}</span>
<span class="s">}</span>
<span class="s">//DNA conformation</span>
<span class="s">&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">weave</span>
    <span class="n">weave</span><span class="o">.</span><span class="n">inline</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;datax1&#39;</span><span class="p">,</span> <span class="s">&#39;datay1&#39;</span><span class="p">,</span> <span class="s">&#39;dataz1&#39;</span><span class="p">,</span> <span class="s">&#39;N1&#39;</span><span class="p">,</span>
                        <span class="s">&#39;datax2&#39;</span><span class="p">,</span> <span class="s">&#39;datay2&#39;</span><span class="p">,</span> <span class="s">&#39;dataz2&#39;</span><span class="p">,</span> <span class="s">&#39;N2&#39;</span><span class="p">,</span> <span class="s">&#39;ret&#39;</span><span class="p">],</span>
                 <span class="n">extra_compile_args</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;-malign-double&#39;</span><span class="p">],</span> <span class="n">support_code</span><span class="o">=</span><span class="n">support</span><span class="p">)</span>

    <span class="n">data1</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">datax1</span><span class="p">,</span> <span class="n">datay1</span><span class="p">,</span> <span class="n">dataz1</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
    <span class="n">data2</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">datax2</span><span class="p">,</span> <span class="n">datay2</span><span class="p">,</span> <span class="n">dataz2</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>

    <span class="k">return</span> <span class="n">data1</span><span class="p">[:</span><span class="n">ret</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">data2</span><span class="p">[:</span><span class="n">ret</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>


<span class="k">def</span> <span class="nf">mutualSimplify</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;Starting mutual simplification of polymers&quot;</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">la</span><span class="p">,</span> <span class="n">lb</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="k">print</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="s">&quot;before; &quot;</span><span class="p">,</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">_mutualSimplify</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="k">print</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="s">&quot;after one; &quot;</span><span class="p">,</span>
        <span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">_mutualSimplify</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="k">print</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="s">&quot;after two; &quot;</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">==</span> <span class="n">la</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">==</span> <span class="n">lb</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;Mutual simplification finished&quot;</span>
            <span class="k">return</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span>

<span class="k">def</span> <span class="nf">getLinkingNumber</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">randomOffset</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">mutualSimplify</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_getLinkingNumber</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">randomOffset</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_testMutualSimplify</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">np</span> <span class="o">=</span> <span class="n">numpy</span>
        <span class="n">mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">grow_rw</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">14</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">grow_rw</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">14</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">mat</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">mat</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.0001</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">b</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.0001</span>
        <span class="n">c1</span> <span class="o">=</span> <span class="n">getLinkingNumber</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">mutualSimplify</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">c2</span> <span class="o">=</span> <span class="n">getLinkingNumber</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&quot;simplified from 2000 to {0} and {1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>
        <span class="k">print</span> <span class="s">&quot;Link before: {0}, link after: {1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">c1</span> <span class="o">!=</span> <span class="n">c2</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;Test failed! Linking numbers are different&quot;</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">np</span> <span class="o">=</span> <span class="n">numpy</span>
        <span class="n">mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">create_random_walk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3000</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">create_random_walk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>

        <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">mat</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">mat</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.0001</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">b</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.0001</span>

        <span class="n">c1</span> <span class="o">=</span> <span class="n">_getLinkingNumber</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">mutualSimplify</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">c2</span> <span class="o">=</span> <span class="n">_getLinkingNumber</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&quot;simplified from 3000 and 1000 to {0} and {1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>
        <span class="k">print</span> <span class="s">&quot;Link before: {0}, link after: {1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">c1</span> <span class="o">!=</span> <span class="n">c2</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;Test failed! Linking numbers are different&quot;</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>


    <span class="k">print</span> <span class="s">&#39;Test finished successfully&#39;</span>



<span class="k">def</span> <span class="nf">testLinkingNumber</span><span class="p">():</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1000</span><span class="p">))</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1000</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
        <span class="n">mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">na</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
        <span class="n">nb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
        <span class="k">print</span> <span class="n">getLinkingNumber</span><span class="p">(</span><span class="n">na</span><span class="p">,</span> <span class="n">nb</span><span class="p">,</span> <span class="n">randomOffset</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

<span class="c"># testLinkingNumber()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../np-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">Wrapper for Openmm to perform polymer simulations and chromatin modelling 0.4 documentation</a> &raquo;</li>
          <li><a href="index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, Maxim Imakaev, Anton Goloborodko, Geoffrey Fudenberg, Leonid Mirny.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.3.
    </div>
  </body>
</html>